<!DOCTYPE html>
<html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>5 Package | Working with R</title>
<meta name="author" content="Eric Marcon">
<meta name="description" content="R packages extend its functionality with code provided by the developer community. They are the key to the success of R because they allow to quickly spread new methods resulting from research or...">
<meta name="generator" content="bookdown 0.39 with bs4_book()">
<meta property="og:title" content="5 Package | Working with R">
<meta property="og:type" content="book">
<meta property="og:url" content="https://ericmarcon.github.io/WorkingWithR/chap-package.html">
<meta property="og:description" content="R packages extend its functionality with code provided by the developer community. They are the key to the success of R because they allow to quickly spread new methods resulting from research or...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="5 Package | Working with R">
<meta name="twitter:description" content="R packages extend its functionality with code provided by the developer community. They are the key to the success of R because they allow to quickly spread new methods resulting from research or...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.7.0/transition.js"></script><script src="libs/bs3compat-0.7.0/tabs.js"></script><script src="libs/bs3compat-0.7.0/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><link href="libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">
<script src="libs/htmlwidgets-1.6.4/htmlwidgets.js"></script><link href="libs/vis-9.1.0/vis-network.min.css" rel="stylesheet">
<script src="libs/vis-9.1.0/vis-network.min.js"></script><script src="libs/visNetwork-binding-2.1.2/visNetwork.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<link href="libs/tabwid-1.1.3/tabwid.css" rel="stylesheet">
<script src="libs/tabwid-1.1.3/tabwid.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-7NVD1TWMCJ"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-7NVD1TWMCJ');
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
          margin-bottom: 0em;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Working with R</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Presentation</a></li>
<li><a class="" href="chap-logiciels.html"><span class="header-section-number">1</span> Software</a></li>
<li><a class="" href="chap-utiliseR.html"><span class="header-section-number">2</span> Use R</a></li>
<li><a class="" href="chap-git.html"><span class="header-section-number">3</span> Git and GitHub</a></li>
<li><a class="" href="chap-rediger.html"><span class="header-section-number">4</span> Writing</a></li>
<li><a class="active" href="chap-package.html"><span class="header-section-number">5</span> Package</a></li>
<li><a class="" href="chap-ci.html"><span class="header-section-number">6</span> Continuous integration</a></li>
<li><a class="" href="chap-shiny.html"><span class="header-section-number">7</span> Shiny</a></li>
<li><a class="" href="chap-enseigner.html"><span class="header-section-number">8</span> Teaching with R</a></li>
<li><a class="" href="chap-conclusion.html"><span class="header-section-number">9</span> Conclusion</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/EricMarcon/WorkingWithR">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="chap-package" class="section level1" number="5">
<h1>
<span class="header-section-number">5</span> Package<a class="anchor" aria-label="anchor" href="#chap-package"><i class="fas fa-link"></i></a>
</h1>
<p>R packages extend its functionality with code provided by the developer community.
They are the key to the success of R because they allow to quickly spread new methods resulting from research or to add new tools that can become standards, such as the <strong>tidyverse</strong>.</p>
<p>It is useful to produce a package when you have written new functions that form a coherent whole.
A package for personal use or limited to a work team is simple to set up and the time saved by easily using the updated version of each function very quickly amortizes the time spent on making the package.
This type of package is intended to be hosted on GitHub.</p>
<p>Packages with a wider use, which provide for example the code corresponding to a published method, are placed in the CRAN repository, from where they can be installed by the standard command <code><a href="https://rdrr.io/r/utils/install.packages.html">install.packages()</a></code>.
CRAN performs extensive code checks and only accepts packages that pass its test suite without any warning.
They must respect the policies<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://cran.r-project.org/web/packages/policies.html" class="uri"&gt;https://cran.r-project.org/web/packages/policies.html&lt;/a&gt;&lt;/p&gt;'><sup>98</sup></a> of the repository.</p>
<p>The documentation for package creation is abundant.
The reference book is <span class="citation">Wickham (<a href="references.html#ref-Wickham2015">2015</a>)</span>, which should be consulted as a reference.</p>
<p>The approach used here is to create a first package very quickly to understand that the process is quite simple.
It will then be enriched with the elements necessary for a package distributed to other users than its designer: a complete documentation and tests of correct operation in particular.</p>
<div id="first-package" class="section level2" number="5.1">
<h2>
<span class="header-section-number">5.1</span> First package<a class="anchor" aria-label="anchor" href="#first-package"><i class="fas fa-link"></i></a>
</h2>
<p>This introduction follows the recommendations of the blog <em>Creating a package in minutes</em><a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://thinkr.fr/creer-package-r-quelques-minutes/" class="uri"&gt;https://thinkr.fr/creer-package-r-quelques-minutes/&lt;/a&gt;&lt;/p&gt;'><sup>99</sup></a> from ThinkR.</p>
<div id="creation" class="section level3" number="5.1.1">
<h3>
<span class="header-section-number">5.1.1</span> Creation<a class="anchor" aria-label="anchor" href="#creation"><i class="fas fa-link"></i></a>
</h3>
<p>Packages have a strict organization in a fixed file and directory structure.
It is possible to create this structure manually but specialized packages can do it:</p>
<ul>
<li>
<strong>usethis</strong> automates the creation of folders.</li>
<li>
<strong>roxygen2</strong> automates the mandatory documentation of packages.</li>
<li>
<strong>devtools</strong> is the developer’s toolbox, allowing to build and test packages.</li>
</ul>
<p>All three are to be installed first:</p>
<p></p>
<div class="sourceCode" id="cb351"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"usethis"</span>, <span class="st">"roxygen2"</span>, <span class="st">"devtools"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p></p>
<p>The package to create will be an RStudio project.
In the project menu, select “New Project &gt; New Directory &gt; R package using devtools…”, choose the name of the project and its parent folder.
The package will be called <strong>multiple</strong>, in the <code>%LOCALAPPDATA%\ProjectsR</code> folder, following the recommendations in the section <a href="chap-logiciels.html#sec:solution-dossiers">1.2.4</a>.</p>
<p>The name of the package must respect the constraints of project names: no special characters, no spaces…
It must also be evocative of the purpose of the package.
If the package is to be distributed, all its documentation will be written in English, including its name.</p>
<p>The minimal structure is created:</p>
<ul>
<li>A <code>DESCRIPTION</code> file which indicates that the folder contains a package and specifies at least its name.</li>
<li>A <code>NAMESPACE</code> file which declares how the package intervenes in the management of the names of R objects (its content will be updated by <strong>roxygen2</strong>).</li>
<li>An <code>R</code> file which contains the code of the functions offered by the package (empty at this stage).</li>
</ul>
<p>The package can be tested right away: in the RStudio <em>Build</em> window, clicking on “Install and Restart” builds the package and loads it into R, after restarting the program to avoid any conflicts.</p>
<p>In the <em>Packages</em> window, <strong>multiple</strong> is now visible.
It is loaded, but contains nothing.</p>
</div>
<div id="first-function" class="section level3" number="5.1.2">
<h3>
<span class="header-section-number">5.1.2</span> First function<a class="anchor" aria-label="anchor" href="#first-function"><i class="fas fa-link"></i></a>
</h3>
<div id="files" class="section level4" number="5.1.2.1">
<h4>
<span class="header-section-number">5.1.2.1</span> Files<a class="anchor" aria-label="anchor" href="#files"><i class="fas fa-link"></i></a>
</h4>
<p>Functions are placed in one or more <code>.R</code> files in the <code>R</code> folder.
The organization of these files is free.
For this example, a file with the name of each function will be created.
Files grouping similar functions or a single file containing all the code are possible choices.</p>
<p>The choice made here is the following:</p>
<ul>
<li>A file that will contain the code common to the whole package: <code>package.R</code>.</li>
<li>One file common to all functions: <code>functions.R</code>.</li>
</ul>
</div>
<div id="creation-1" class="section level4" number="5.1.2.2">
<h4>
<span class="header-section-number">5.1.2.2</span> Creation<a class="anchor" aria-label="anchor" href="#creation-1"><i class="fas fa-link"></i></a>
</h4>
<p>The first function, <code><a href="https://rdrr.io/r/base/double.html">double()</a></code>, is created and stored in the <code>functions.R</code> file:</p>
<p></p>
<div class="sourceCode" id="cb352"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">double</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">number</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">number</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p></p>
<p>At this point, the function is internal to the package and is not accessible from the working environment.
To be sure, build the package (<em>Install and Restart</em>) and check that the function works:</p>
<p></p>
<div class="sourceCode" id="cb353"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/double.html">double</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p></p>
<p>The result is a vector composed of two 0’s because the called function is a homonym of the <strong>base</strong> package (see its documentation by typing <code><a href="https://rdrr.io/r/base/double.html">?double</a></code>):</p>
<p></p>
<div class="sourceCode" id="cb354"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">base</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/double.html">double</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 0 0</code></pre>
<p></p>
<p>In order for the function in our package to be visible, it must be <em>exported</em> by declaring it in the <code>NAMESPACE</code> file.
This is the job of <strong>roxygen2</strong> which manages the documentation of each function at the same time.
To activate it, place the cursor in the function and call the menu “Code &gt; Insert Roxygen Skeleton”.
Comments are added before the function:</p>
<p></p>
<div class="sourceCode" id="cb356"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Title</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param number </span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @return</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @examples</span></span>
<span><span class="va">double</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">number</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">number</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p></p>
<p>Comments to <strong>roxygen2</strong> begin with <code>#'</code>:</p>
<ul>
<li>The first line contains the title of the function, i.e. a very short description: its name in general.</li>
<li>The next line (separated by a line break) may contain its description (see <em>Description</em> in the help).</li>
<li>The next line (after another line break) might contain more information (<em>Details</em> in the help).</li>
<li>The arguments of the function are described by the <code>@param</code> lines.</li>
<li>
<code>@return</code> describes the result of the function.</li>
<li>
<code>@export</code> declares that the function is exported: it will be usable in the working environment.</li>
<li>Examples can be added.</li>
</ul>
<p>The documentation must be completed:</p>
<p></p>
<div class="sourceCode" id="cb357"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' double</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' Double value of numbers.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' Calculate the double values of numbers.</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' @param number a numeric vector.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @return A vector of the same length as `number` containing the </span></span>
<span><span class="co">#'   transformed values.</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @examples</span></span>
<span><span class="co">#' double(2)</span></span>
<span><span class="co">#' double(1:4)</span></span>
<span><span class="va">double</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">number</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">number</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p></p>
<p>Don’t hesitate to use the help of existing functions to respect R standards (here: <code><a href="https://rdrr.io/r/base/Log.html">?log</a></code>):</p>
<ul>
<li>Keep in mind that functions are normally vector: <code>number</code> is by default a vector, not a scalar.</li>
<li>Some elements start with a capital letter and end with a dot because they are paragraphs in the help file.</li>
<li>The title does not have a period.</li>
<li>The description of the parameters does not start with a capital letter.</li>
</ul>
<p>Taking into account the changes in the documentation requires calling the <code>roxygenize()</code> function.
In the <em>Build</em> window, the “More &gt; Document” menu allows you to do this.
Then build the package (<em>Install and Restart</em>) and check the result by running the function and displaying its help:</p>
<p></p>
<div class="sourceCode" id="cb358"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/double.html">double</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">?</span><span class="va">double</span></span></code></pre></div>
<p></p>
<p>It is possible to automate the update of the documentation at each build of the package by the menu “Build &gt; Configure Build Tools…”: click on “Configure” and check the box “Automatically reoxygenize when running Install and Restart”.
This is an efficient choice for a small package but penalizing when the time to update the documentation increases with the complexity of the package. The package rebuild is most often used to test code changes: its speed is essential.</p>
<p>The documentation for <strong>roxygen2</strong> supports the Markdown<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://roxygen2.r-lib.org/articles/markdown.html" class="uri"&gt;https://roxygen2.r-lib.org/articles/markdown.html&lt;/a&gt;&lt;/p&gt;'><sup>100</sup></a> format.</p>
<p>At this stage, the package is functional: it contains a function and a beginning of documentation.
It is time to run a check of its code: in the <em>Build</em> window, click on “Check” or use the <code>devtools::check()</code> command.
The operation <em>reoxygenates</em> the package (updates its documentation), performs a large number of tests and returns a list of errors, warnings and notes detected.
The goal is always to have no warnings: they must be handled immediately.
For example, the following return is a warning about the non-conformity of the declared license:</p>
<pre><code>&gt; checking DESCRIPTION meta-information ... WARNING
  Non-standard license specification:
    `use_gpl3_license()`
  Standardizable: FALSE

0 errors v | 1 warning x | 0 notes v
Erreur : R CMD check found WARNINGs</code></pre>
<p>To correct it, update, run the update license command, starting with your name:</p>
<p></p>
<div class="sourceCode" id="cb360"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>usethis.full_name <span class="op">=</span> <span class="st">"Eric Marcon"</span><span class="op">)</span></span>
<span><span class="fu">usethis</span><span class="fu">::</span><span class="fu"><a href="https://usethis.r-lib.org/reference/licenses.html">use_gpl3_license</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p></p>
<p>The list of valid licenses is provided by R<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://svn.r-project.org/R/trunk/share/licenses/license.db" class="uri"&gt;https://svn.r-project.org/R/trunk/share/licenses/license.db&lt;/a&gt;&lt;/p&gt;'><sup>101</sup></a>.</p>
<p>After correction, run the tests again until the alerts disappear.</p>
</div>
</div>
<div id="sec:package-cds" class="section level3" number="5.1.3">
<h3>
<span class="header-section-number">5.1.3</span> Source control<a class="anchor" aria-label="anchor" href="#sec:package-cds"><i class="fas fa-link"></i></a>
</h3>
<p>It is time to put the code under source control.</p>
<p>Enable source control in the project options (figure <a href="chap-git.html#fig:git-Project">3.2</a>).
Restart RStudio on demand.</p>
<p>Create a repository on GitHub and push the local repository to it, as explained in the chapter <a href="chap-git.html#chap-git">3</a>.</p>
<p>Create the file <code>README.md</code>:</p>
<pre><code># multiple

An R package to compute mutiple of numbers.</code></pre>
<p>The development of the package is punctuated by many commits at each modification and a push at each step, validated by a version number increment.</p>
</div>
<div id="package.r" class="section level3" number="5.1.4">
<h3>
<span class="header-section-number">5.1.4</span> package.R<a class="anchor" aria-label="anchor" href="#package.r"><i class="fas fa-link"></i></a>
</h3>
<p>The <code>package.R</code> file is intended to receive the R code and especially the comments for <strong>roxygen2</strong> which concern the whole package.
This file can also be named <code>multiple-package.R</code>, prefixed with the package name, for compatibility with <strong>usethis</strong>.
It can be created under this name with the command:</p>
<p></p>
<div class="sourceCode" id="cb362"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">usethis</span><span class="fu">::</span><span class="fu"><a href="https://usethis.r-lib.org/reference/use_package_doc.html">use_package_doc</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p></p>
<p>The first comment block will generate the package help (<code>?multiple</code>).</p>
<pre><code>#' @keywords internal 
"_PACKAGE"</code></pre>
<p>The “_PACKAGE” keyword indicates that package documentation must be produced.
It could be written in the block, with a syntax identical to that of functions, but its default content is that of the <code>Description</code> field in the <code>DESCRIPTION</code> file.
The <code>internal</code> keyword hides the package documentation in the help summary.</p>
<p>The documentation is updated by the <code>roxygen2::roxygenise()</code> command.
After rebuilding the package, check that the help has appeared: <code>?multiple</code>.</p>
</div>
</div>
<div id="package-organization" class="section level2" number="5.2">
<h2>
<span class="header-section-number">5.2</span> Package organization<a class="anchor" aria-label="anchor" href="#package-organization"><i class="fas fa-link"></i></a>
</h2>
<div id="sec:package-description" class="section level3" number="5.2.1">
<h3>
<span class="header-section-number">5.2.1</span> DESCRIPTION file<a class="anchor" aria-label="anchor" href="#sec:package-description"><i class="fas fa-link"></i></a>
</h3>
<p>The file must be completed:</p>
<pre><code>Package: multiple
Title: Calculate multiples of numbers
Version: 0.0.0.9000
Authors@R: 
  person(given = "Eric",
           family = "Marcon",
           role = c("aut", "cre"),
           email = "e.marcon@free.fr",
           comment = c(ORCID = "0000-0002-5249-321X"))
Description: Simple computation of multiples of numbers, 
  including fast algorithms for integers.
License: GPL-3
Encoding: UTF-8
LazyData: true
Roxygen: list(markdown = TRUE)
RoxygenNote: 7.1.1</code></pre>
<p>The package name is fixed and must not be changed.</p>
<p>Its title must describe in one line what it is used for.
The title is displayed in the <em>Packages</em> window next to the package names.</p>
<p>The version must respect the conventions:</p>
<ul>
<li>The first number is the major version, 0 as long as the package is not stable, then 1.
The major version only changes if the package is no longer compatible with its previous versions, which forces users to modify their code.</li>
<li>The second is the minor version, incremented when new features are added.</li>
<li>The third is the correction version: 0 at the origin, incremented at each code correction without new functionality.</li>
<li>The fourth is reserved for development, and starts at 9000.
It is incremented with each unstable version and disappears when a new stable version (<em>release</em>) is produced.</li>
</ul>
<p>Example: a bug fix on version 1.3.0 produces version 1.3.1.
The following development versions (unstable, not intended for production use) are 1.3.1.9000 then 1.3.1.9001, etc.
The version number must be updated each time the package is pushed on GitHub.
When the development is stabilized, the new version, intended to be used in production, is 1.3.2 if it does not bring any new functionality or 1.4.0 in the opposite case.</p>
<p>The description of the authors is rather heavy but simple to understand.
The Orcid identifiers of academic authors can be used.
If the package has several authors, they are placed in a <code><a href="https://rdrr.io/r/base/c.html">c()</a></code> function: <code>c(person(...), person(...))</code> for two authors.
In this case, the role of each must be specified:</p>
<ul>
<li>“cre” for the creator of the package.</li>
<li>“aut” for one of the other authors.</li>
<li>“ctb” for a contributor, who may have reported a bug or provided some code.</li>
</ul>
<p>The description of the package in one paragraph allows to give more information.</p>
<p>The license specifies how the package can be used and modified.
GPL-3 is a good default, but other choices are possible<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://r-pkgs.org/description.html#description-license" class="uri"&gt;https://r-pkgs.org/description.html#description-license&lt;/a&gt;&lt;/p&gt;'><sup>102</sup></a>.</p>
<p>The <code>LazyData</code> option means that the example data provided with the package can be used without calling it first by the <code><a href="https://rdrr.io/r/utils/data.html">data()</a></code> function: this is the current standard.</p>
<p>Finally, the last two lines are handled by <strong>roxygen2</strong>.</p>
</div>
<div id="news.md-file" class="section level3" number="5.2.2">
<h3>
<span class="header-section-number">5.2.2</span> NEWS.md file<a class="anchor" aria-label="anchor" href="#news.md-file"><i class="fas fa-link"></i></a>
</h3>
<p>The <code>NEWS.md</code> file contains the history of the package.
New versions are added to the top of the file.</p>
<p>Create a first version of the file:</p>
<pre><code># multiple 0.0.0.9000

## New features

* Initial version of the package</code></pre>
<p>The first level titles must contain the package name and version.
Level 2 titles are free, but usually contain headings like “New features” and “Bug Fixes”.</p>
<p>To avoid multiplying the versions described, it is advisable to change the current version and complete the documentation until the correction version changes (third number).
Then, the entry corresponding to this version remains frozen and a new entry is added.</p>
</div>
</div>
<div id="vignette" class="section level2" number="5.3">
<h2>
<span class="header-section-number">5.3</span> Vignette<a class="anchor" aria-label="anchor" href="#vignette"><i class="fas fa-link"></i></a>
</h2>
<p>A vignette is essential to document the package correctly:</p>
<p></p>
<div class="sourceCode" id="cb366"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">usethis</span><span class="fu">::</span><span class="fu"><a href="https://usethis.r-lib.org/reference/use_vignette.html">use_vignette</a></span><span class="op">(</span><span class="st">"multiple"</span><span class="op">)</span></span></code></pre></div>
<p></p>
<p>The file <code>multiple.Rmd</code> is created in the <code>vignette</code> folder.
Add a subtitle in its header: the short description of the package:</p>
<pre><code>title: "multiple"
subtitle: "Multiples of numbers"</code></pre>
<p>The rest of the header allows R to build the vignette from R Markdown code.</p>
<p>The body of the vignette contains by default R code to declare the options for presenting the code snippets and loading the package.
An introduction to the use of the package should be written in this document, in R Markdown.</p>
<p>During the development of the package, the vignette can be built manually by running:</p>
<p></p>
<div class="sourceCode" id="cb368"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">build_vignettes</span><span class="op">(</span><span class="st">"multiple"</span><span class="op">)</span></span></code></pre></div>
<p></p>
<p>The resulting files are placed in <code>doc/</code>: open the <code>.html</code> file to check the result.</p>
<p>RStudio does not create the package vignette when the “Install and Restart” command in the Build window is called.
For a complete installation, two solutions are possible:</p>
<ul>
<li>Build the package source file (“Build &gt; More &gt; Build Source Package”) and then install it (“Packages &gt; Install &gt; Install from &gt; Package Archive file”).
The source file is next to the project file.</li>
<li>Push the package code on GitHub and then run:</li>
</ul>
<p></p>
<div class="sourceCode" id="cb369"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">remotes</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"multiple"</span>, build_vignettes <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p></p>
<p>The vignette can then be displayed by the command:</p>
<p></p>
<div class="sourceCode" id="cb370"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/vignette.html">vignette</a></span><span class="op">(</span><span class="st">"multiple"</span><span class="op">)</span></span></code></pre></div>
<p></p>
</div>
<div id="pkgdown" class="section level2" number="5.4">
<h2>
<span class="header-section-number">5.4</span> pkgdown<a class="anchor" aria-label="anchor" href="#pkgdown"><i class="fas fa-link"></i></a>
</h2>
<p>The <strong>pkgdown</strong> package creates a companion site to the package<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;Example: &lt;a href="https://EricMarcon.github.io/entropart/" class="uri"&gt;https://EricMarcon.github.io/entropart/&lt;/a&gt;&lt;/p&gt;'><sup>103</sup></a>, which includes the <code>README.md</code> file as the home page, the vignette in a “Get Started” section, all of the help files with their executed examples (the “Reference” section), the <code>NEWS.md</code> file for a history of the package (the “Changelog” section), and information from the <code>DESCRIPTION</code> file.</p>
<p>Create the site with <strong>usethis</strong>:</p>
<p></p>
<div class="sourceCode" id="cb371"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">usethis</span><span class="fu">::</span><span class="fu"><a href="https://usethis.r-lib.org/reference/use_pkgdown.html">use_pkgdown</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p></p>
<p>Then build the site.
This command will be executed again at each version change of the package:</p>
<p></p>
<div class="sourceCode" id="cb372"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pkgdown</span><span class="fu">::</span><span class="fu">build_site</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p></p>
<p>The site is placed in the <code>docs</code> folder.
Open the file <code>index.htm</code> with a web browser to view it.
As soon as the project is pushed to GitHub, activate the repository pages so that the site is visible online (see section <a href="chap-git.html#sec:github-pages">3.7</a>).</p>
<p><strong>pkgdown</strong> places the site in the <code>docs</code> folder.</p>
<p>Add the address of the GitHub pages to a new line in the <code>DESCRIPTION</code> file:</p>
<pre><code>URL: https://GitHubID.github.io/multiple</code></pre>
<p>Also add it to the <code>_pkgdown.yml</code> file that was created empty, along with the following option:</p>
<pre><code>url: https://GitHubID.github.io/multiple

development:
  mode: auto</code></pre>
<p><strong>pkgdown</strong> places the site in the <code>docs/dev</code> folder if the site for a stable (three-numbered) version of the package exists in <code>docs</code> and the current version is a development version (four-numbered).
This way, users of a production version of the package have access to the site without it being disturbed by the development versions.</p>
<p>The site can be enriched in several ways:</p>
<ul>
<li>By adding articles in R Markdown format to the <code>vignettes/articles</code> folder.
The vignette should not require significant computational resources to present examples because it is built at the same time as the package.
The articles are generated by <strong>pkgdown</strong>, independently, and can therefore be more ambitious;</li>
<li>By improving its presentation (grouping functions by themes, adding badges, a sticker<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;The Shiny application &lt;strong&gt;hexmake&lt;/strong&gt; allows easy creation of a sticker: &lt;a href="https://connect.thinkr.fr/hexmake/" class="uri"&gt;https://connect.thinkr.fr/hexmake/&lt;/a&gt;&lt;/p&gt;'><sup>104</sup></a>…): refer to the help of <strong>pkgdown</strong>.</li>
</ul>
<p>To enrich the documentation of the package, it is possible to use a <code>README.Rmd</code> file in R Markdown format, to be knitted to create the standard <code>README.md</code> of GitHub, used as the home page of the <strong>pkgdown</strong> site, which can in this way present examples of use of the code.
The approach is detailed in <em>R Packages</em><a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://r-pkgs.org/release.html?q=readme#readme-rmd" class="uri"&gt;https://r-pkgs.org/release.html?q=readme#readme-rmd&lt;/a&gt;&lt;/p&gt;'><sup>105</sup></a>.
The added complexity is to be compared to the gain: a simple homepage (without code) with links to the vignette and articles is easier to implement.</p>
</div>
<div id="package-specific-code" class="section level2" number="5.5">
<h2>
<span class="header-section-number">5.5</span> Package specific code<a class="anchor" aria-label="anchor" href="#package-specific-code"><i class="fas fa-link"></i></a>
</h2>
<div id="importing-functions" class="section level3" number="5.5.1">
<h3>
<span class="header-section-number">5.5.1</span> Importing functions<a class="anchor" aria-label="anchor" href="#importing-functions"><i class="fas fa-link"></i></a>
</h3>
<p>Let’s create a new function in <code>functions.R</code> that adds random noise to the double value:</p>
<p></p>
<div class="sourceCode" id="cb375"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fuzzydouble</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">number</span>, <span class="va">sd</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">number</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">number</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">sd</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>
The noise is drawn in a centered normal distribution of standard deviation <code>sd</code> and added to the calculated value.</p>
<p><code><a href="https://rdrr.io/r/stats/Normal.html">rnorm()</a></code> is a function of the <strong>stats</strong> package.
Even though the package is systematically loaded by R, the package to which the function belongs must be declared: the only exceptions are functions from the <strong>base</strong> package.</p>
<p>The <strong>stats</strong> package must first be declared in <code>DESCRIPTION</code> which contains an <code>Imports:</code> statement.
All packages used by the <strong>multiple</strong> code will be listed, separated by commas.</p>
<pre><code>Imports: stats</code></pre>
<p>This “import” simply means that the <strong>stats</strong> package must be loaded, but not necessarily attached (see section <a href="chap-utiliseR.html#sec:environnements">2.2</a>), for <strong>multiple</strong> to work.</p>
<p>Then, the <code><a href="https://rdrr.io/r/stats/Normal.html">rnorm()</a></code> function must be found in the <strong>multiple</strong> package environment.
There are several ways to fulfill this requirement.
First, the following comment could be provided for <strong>roxygen2</strong>:</p>
<p></p>
<div class="sourceCode" id="cb377"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @import stats</span></span></code></pre></div>
<p></p>
<p>The entire namespace of the <strong>stats</strong> package would be attached to and accessible by the <strong>multiple</strong> package.
This is not a good practice because it inreases the risk of name conflicts (see section <a href="chap-utiliseR.html#sec:environnements">2.2</a>).
Note that the notion of import used here is different from that of <code>DESCRIPTION</code>, although they have the same name.</p>
<p>It is best to import only the <code><a href="https://rdrr.io/r/stats/Normal.html">rnorm()</a></code> function by declaring it in the function documentation:</p>
<p></p>
<div class="sourceCode" id="cb378"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @importFrom stats rnorm</span></span></code></pre></div>
<p></p>
<p>This is not an ideal practice either because the origin of the function would not be clear in the package code.</p>
<p>The best practice is to import nothing (in the sense of <strong>roxygen2</strong>) and to systematically qualify functions from other packages with the syntax <code>package::function()</code>.
This is the solution chosen here because the <code>@importFrom</code> directive would import the function in the whole <strong>multiple</strong> package, not only in the <code>fuzzydouble()</code> function, at the risk of creating side effects (modifying the behavior of another function of the package which would not assume the import of <code><a href="https://rdrr.io/r/stats/Normal.html">rnorm()</a></code>).
Finally, the code of the function is as follows:</p>
<p></p>
<div class="sourceCode" id="cb379"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' fuzzydouble</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' Double value of numbers with an error</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' Calculate the double values of numbers </span></span>
<span><span class="co">#' and add a random error to the result.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param number a numeric vector.</span></span>
<span><span class="co">#' @param sd the standard deviation of the Gaussian error added.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @return A vector of the same length as `number`</span></span>
<span><span class="co">#'  containing the transformed values.</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @examples</span></span>
<span><span class="co">#' fuzzydouble(2)</span></span>
<span><span class="co">#' fuzzydouble(1:4)</span></span>
<span><span class="va">fuzzydouble</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">number</span>, <span class="va">sd</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">number</span> <span class="op">+</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">number</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">sd</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p></p>
</div>
<div id="s3-methods" class="section level3" number="5.5.2">
<h3>
<span class="header-section-number">5.5.2</span> S3 methods<a class="anchor" aria-label="anchor" href="#s3-methods"><i class="fas fa-link"></i></a>
</h3>
<p>S3 methods are presented in section <a href="chap-utiliseR.html#sec:S3">2.1.2</a>.</p>
<div id="classes" class="section level4" number="5.5.2.1">
<h4>
<span class="header-section-number">5.5.2.1</span> Classes<a class="anchor" aria-label="anchor" href="#classes"><i class="fas fa-link"></i></a>
</h4>
<p>Objects belong to classes:</p>
<p></p>
<div class="sourceCode" id="cb380"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Class of a number</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "numeric"</code></pre>
<div class="sourceCode" id="cb382"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Class of a function</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">sum</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "function"</code></pre>
<p></p>
<p>In addition to the basic classes, developers can create others.</p>
</div>
<div id="methods" class="section level4" number="5.5.2.2">
<h4>
<span class="header-section-number">5.5.2.2</span> Methods<a class="anchor" aria-label="anchor" href="#methods"><i class="fas fa-link"></i></a>
</h4>
<p>The point of creating new classes is to adapt existing methods to them, the most common case being <code><a href="https://rdrr.io/r/base/plot.html">plot()</a></code>.
This is a generic method, i.e. a function template, without code, to be adapted to the class of object to be processed.</p>
<p></p>
<div class="sourceCode" id="cb384"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot</span></span></code></pre></div>
<pre><code>## function (x, y, ...) 
## UseMethod("plot")
## &lt;bytecode: 0x10649b3b0&gt;
## &lt;environment: namespace:base&gt;</code></pre>
<p></p>
<p>There are many variations of <code>plot</code> in R, which are functions with names of the form <code>plot.class()</code>.
<strong>stats</strong> provides a function <code>plot.lm()</code> to create a figure from a linear model.
Many packages create classes tailored to their objects and provide a <code>plot</code> method for each class.
The functions can be listed:</p>
<p></p>
<div class="sourceCode" id="cb386"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Some functions plot()</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/methods.html">methods</a></span><span class="op">(</span><span class="va">plot</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "plot,ANY-method"   "plot,color-method"
## [3] "plot.AccumCurve"   "plot.acf"         
## [5] "plot.ACF"          "plot.addvar"</code></pre>
<div class="sourceCode" id="cb388"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Total number</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/methods.html">methods</a></span><span class="op">(</span><span class="va">plot</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 155</code></pre>
<p></p>
<p>Conversely, the available methods for a class can be displayed:</p>
<p></p>
<div class="sourceCode" id="cb390"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/methods.html">methods</a></span><span class="op">(</span>class <span class="op">=</span> <span class="st">"lm"</span><span class="op">)</span></span></code></pre></div>
<pre><code>##  [1] add1           alias          anova         
##  [4] as_flextable   case.names     coerce        
##  [7] confint        cooks.distance deviance      
## [10] dfbeta         dfbetas        drop1         
## [13] dummy.coef     effects        extractAIC    
## [16] family         formula        fortify       
## [19] hatvalues      influence      initialize    
## [22] kappa          labels         logLik        
## [25] model.frame    model.matrix   nobs          
## [28] plot           predict        print         
## [31] proj           qqnorm         qr            
## [34] residuals      response       rstandard     
## [37] rstudent       show           simulate      
## [40] slotsFromS3    summary        variable.names
## [43] vcov          
## see '?methods' for accessing help and source code</code></pre>
<p></p>
<p>The <code>print</code> method is used to display any object (it is implicit when only the name of an object is entered):</p>
<p></p>
<div class="sourceCode" id="cb392"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_lm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">dist</span> <span class="op">~</span> <span class="va">speed</span>, data <span class="op">=</span> <span class="va">cars</span><span class="op">)</span></span>
<span><span class="co"># Equivalent to '&gt; my_lm'</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">my_lm</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = dist ~ speed, data = cars)
## 
## Coefficients:
## (Intercept)        speed  
##     -17.579        3.932</code></pre>
<p></p>
<p>The <code>summary</code> method displays a readable summary of the object:</p>
<p></p>
<div class="sourceCode" id="cb394"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">my_lm</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = dist ~ speed, data = cars)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -29.069  -9.525  -2.272   9.215  43.201 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept) -17.5791     6.7584  -2.601   0.0123 *  
## speed         3.9324     0.4155   9.464 1.49e-12 ***
## ---
## Signif. codes:  
## 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 15.38 on 48 degrees of freedom
## Multiple R-squared:  0.6511, Adjusted R-squared:  0.6438 
## F-statistic: 89.57 on 1 and 48 DF,  p-value: 1.49e-12</code></pre>
<p></p>
<p>The other methods have been created specifically for the needs of the <strong>stats</strong> package.</p>
</div>
<div id="assigning-an-object-to-a-class" class="section level4" number="5.5.2.3">
<h4>
<span class="header-section-number">5.5.2.3</span> Assigning an object to a class<a class="anchor" aria-label="anchor" href="#assigning-an-object-to-a-class"><i class="fas fa-link"></i></a>
</h4>
<p>In order for an object to belong to a class, it is sufficient to declare it:</p>
<p></p>
<div class="sourceCode" id="cb396"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"MyClass"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "MyClass"</code></pre>
<p></p>
<p>A more elegant way to do this is to add the new class to the set of classes to which the object already belongs:</p>
<p></p>
<div class="sourceCode" id="cb398"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"MyClass"</span>, <span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "MyClass" "numeric"</code></pre>
<p></p>
<p>There is no consistency check between the real structure of the object and a structure of the class that would be declared elsewhere: the developer must make sure that the methods will find the right data in the objects that declare to belong to it.
If not, errors will occur:</p>
<p></p>
<div class="sourceCode" id="cb400"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"lm"</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/conditions.html">tryCatch</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>, error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">e</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## &lt;simpleError in x$call: $ operator is invalid for atomic vectors&gt;</code></pre>
<p></p>
</div>
</div>
<div id="in-practice" class="section level3" number="5.5.3">
<h3>
<span class="header-section-number">5.5.3</span> In practice<a class="anchor" aria-label="anchor" href="#in-practice"><i class="fas fa-link"></i></a>
</h3>
<div id="creating-a-generic-method" class="section level4" number="5.5.3.1">
<h4>
<span class="header-section-number">5.5.3.1</span> Creating a generic method<a class="anchor" aria-label="anchor" href="#creating-a-generic-method"><i class="fas fa-link"></i></a>
</h4>
<p>New generic methods can be created and declined according to the classes.</p>
<p>As an example, let’s create a generic method <code>triple</code> which will calculate the triple of numbers in the package <strong>multiple</strong>, declined in two distinct functions: one for integers and one for reals.
Calculations on integers are faster than those on reals, which justifies (at least in theory) the effort of writing two versions of the code.</p>
<p></p>
<div class="sourceCode" id="cb402"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generic Method</span></span>
<span><span class="va">triple</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/UseMethod.html">UseMethod</a></span><span class="op">(</span><span class="st">"triple"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p></p>
<p>The generic method contains no code beyond its declaration.
Its signature (i.e., the set of arguments) is important because functions derived from this method will necessarily have to have the same arguments in the same order and can only add additional arguments before <code>...</code> (which is mandatory).
As the nature of the first argument will depend on the class of each object, it is usual to call it <code>x</code>.</p>
<p>The method is declined in two functions:</p>
<p></p>
<div class="sourceCode" id="cb403"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">triple.integer</span><span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">x</span> <span class="op">*</span> <span class="fl">3L</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">triple.numeric</span><span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">x</span> <span class="op">*</span> <span class="fl">3.0</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p></p>
<p>In its integer version, <code>x</code> is multiplied by <code>3L</code>, the suffix <code>L</code> meaning that 3 should be understood as an integer.
In its real version, 3 can be written <code>3.0</code> to make it clear that it is a real.
Under R, <code>3</code> without further specification is understood as a real.</p>
<p>The choice of function depends on the class of the object passed as argument.</p>
<p></p>
<div class="sourceCode" id="cb404"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Integer argument</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="fl">2L</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "integer"</code></pre>
<div class="sourceCode" id="cb406"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Integer result by the function triple.integer</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="fu">triple</span><span class="op">(</span><span class="fl">2L</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "integer"</code></pre>
<div class="sourceCode" id="cb408"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Real argument</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "numeric"</code></pre>
<div class="sourceCode" id="cb410"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Real result by the function triple.numeric</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="fu">triple</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "numeric"</code></pre>
<div class="sourceCode" id="cb412"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Performance</span></span>
<span><span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="fu">triple.integer</span><span class="op">(</span><span class="fl">2L</span><span class="op">)</span>, <span class="fu">triple.numeric</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>    <span class="fu">triple</span><span class="op">(</span><span class="fl">2L</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## Unit: nanoseconds
##                expr min  lq    mean median  uq    max neval
##  triple.integer(2L) 123 123  143.91    123 164    533   100
##   triple.numeric(2) 123 123 6514.49    123 164 637509   100
##          triple(2L) 492 533 8935.54    533 533 838860   100</code></pre>
<p></p>
<p>The performance measurement by the <strong>microbenchmark</strong> package shows no difference between the functions <code>triple.integer()</code> and <code>triple.numeric</code> as expected because the time spent on the computation itself is negligible compared to the time spent calling the function.
The generic method consumes much more time than the very simple calculations here.
R indeed tests the existence of functions corresponding to the class of the object passed as argument to the generic methods.
As an object can belong to several classes, it searches for a function adapted to the first class, then to the following classes successively.
This search takes a lot of time and justifies the use of generic methods for the readability of the code rather than for performance: the interest of generic methods is to provide the user of the code with a single function for a given objective (<code>plot</code> to make a figure) whatever the data to be processed.</p>
</div>
<div id="creating-a-class" class="section level4" number="5.5.3.2">
<h4>
<span class="header-section-number">5.5.3.2</span> Creating a class<a class="anchor" aria-label="anchor" href="#creating-a-class"><i class="fas fa-link"></i></a>
</h4>
<p>In a package, classes are created if the results of the functions justify it: a list structure and the identification of the class with an object (“lm” is the class of linear models).
For each class created, the <code>print</code>, <code>summary</code> and <code>plot</code> methods (if a graphical representation is possible) should be written.</p>
<p>Let’s write a function <code>multiple()</code> whose result will be an object of a new class, <code>multiple</code>, which will be a list storing the values to multiply, the multiplier and the result.</p>
<p></p>
<div class="sourceCode" id="cb414"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">multiple</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">number</span>, <span class="va">times</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Calculate the multiples</span></span>
<span>    <span class="va">y</span> <span class="op">&lt;-</span> <span class="va">number</span> <span class="op">*</span> <span class="va">times</span></span>
<span>    <span class="co"># Save in a list</span></span>
<span>    <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">number</span>, y <span class="op">=</span> <span class="va">y</span>, times <span class="op">=</span> <span class="va">times</span><span class="op">)</span></span>
<span>    <span class="co"># Set the class</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"multiple"</span>, <span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># Class of the result</span></span>
<span><span class="va">my_multiple</span> <span class="op">&lt;-</span> <span class="fu">multiple</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">my_multiple</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "multiple" "list"</code></pre>
<p></p>
<p>The call to the <code>multiple()</code> function returns an object of class <code>multiple</code>, which is also of class <code>list</code>.
In the absence of a <code>print.multiple()</code> function, R looks for the <code>print.list()</code> function, which does not exist, and falls back on the <code><a href="https://rdrr.io/r/base/print.default.html">print.default()</a></code> function:</p>
<p></p>
<div class="sourceCode" id="cb416"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_multiple</span></span></code></pre></div>
<pre><code>## $x
## [1] 1 2 3
## 
## $y
## [1] 2 4 6
## 
## $times
## [1] 2
## 
## attr(,"class")
## [1] "multiple" "list"</code></pre>
<p></p>
<p>The <code>print.multiple</code> function must therefore be written for a readable display, limited to the result:</p>
<p></p>
<div class="sourceCode" id="cb418"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">print.multiple</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.default.html">print.default</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">y</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># New presentation</span></span>
<span><span class="va">my_multiple</span></span></code></pre></div>
<pre><code>## [1] 2 4 6</code></pre>
<p></p>
<p>Details can be presented in the <code>summary</code> function:</p>
<p></p>
<div class="sourceCode" id="cb420"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">summary.multiple</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.default.html">print.default</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"multiplied by"</span>, <span class="va">object</span><span class="op">$</span><span class="va">times</span>, <span class="st">"is:\n"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.default.html">print.default</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">y</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># New display</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">my_multiple</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 1 2 3
## multiplied by 2 is:
## [1] 2 4 6</code></pre>
<p></p>
<p>Finally, a <code>plot</code> function and an <code>autoplot</code> function complete the set:</p>
<p></p>
<div class="sourceCode" id="cb422"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot.multiple</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot.default</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">x</span><span class="op">$</span><span class="va">y</span>, x<span class="op">=</span><span class="va">x</span><span class="op">$</span><span class="va">x</span>, type <span class="op">=</span> <span class="st">"p"</span>, </span>
<span>    main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Multiplication by"</span>, <span class="va">x</span><span class="op">$</span><span class="va">times</span><span class="op">)</span>, <span class="va">...</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">autoplot.multiple</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">object</span><span class="op">$</span><span class="va">x</span>, y <span class="op">=</span> <span class="va">object</span><span class="op">$</span><span class="va">y</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.data</span><span class="op">$</span><span class="va">x</span>, y <span class="op">=</span> <span class="va">.data</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Multiplication by"</span>, </span>
<span>                                <span class="va">object</span><span class="op">$</span><span class="va">times</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span><span class="op">(</span><span class="va">my_multiple</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="WwR_files/figure-html/plot.multiple-1.png" width="80%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb423"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">my_multiple</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="WwR_files/figure-html/plot.multiple-2.png" width="80%" style="display: block; margin: auto;"></div>
<p></p>
<p>For technical reasons related to unconventional evaluation in the tidyverse, variable names used by <code><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes()</a></code> must be prefixed with <code>.data$</code> in packages and <code><a href="https://rlang.r-lib.org/reference/dot-data.html">rlang::.data</a></code> must be imported.
Otherwise, the package check returns a note that the variables <code>x</code> and <code>y</code>, used by the arguments of <code><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes()</a></code> have not been declared and may not exist in the local environment (see section <a href="chap-utiliseR.html#sec:environnements">2.2</a>).</p>
</div>
<div id="documentation" class="section level4" number="5.5.3.3">
<h4>
<span class="header-section-number">5.5.3.3</span> Documentation<a class="anchor" aria-label="anchor" href="#documentation"><i class="fas fa-link"></i></a>
</h4>
<p>Generic methods and functions that declare them must be documented like any other function.</p>
<p>Namespace management is a bit more complex:</p>
<ul>
<li>Generic methods must be exported:</li>
</ul>
<pre><code>#' @export</code></pre>
<ul>
<li>Functions derived from generic methods should not be exported but declared as methods, with the name of the generic method and the processed class.
<strong>roxygen2</strong> requires that an export directive be added but does not enforce it (as it should) in the <code>NAMESPACE</code> file that is used by R:</li>
</ul>
<pre><code>#' @method plot multiple
#' @export</code></pre>
<ul>
<li><p>Since version 3 of <strong>roxygen2</strong>, the declaration <code>@method</code> is useless as long as the function name is unambiguously decomposable, like <code>plot.multiple</code>: <code>@export</code> is sufficient.
If the derived function name has multiple dots, <strong>roxygen2</strong> may not automatically detect the generic and the object and <code>@method</code> must be maintained.</p></li>
<li><p>Functions derived from generic methods from another package need to import the generic method, unless it is provided by <strong>base</strong> (<code>print</code> is provided by <strong>base</strong> and is therefore not affected):</p></li>
</ul>
<pre><code>#' @importFrom graphics plot
#' @importFrom ggplot2 autoplot</code></pre>
<ul>
<li>The generics imported in this way must be re-exported by a directive to be placed for example just after the code of the derived function:</li>
</ul>
<pre><code><a href="https://rdrr.io/r/graphics/plot.default.html">#' @export
graphics::plot

#' @export
ggplot2::autoplot</a></code></pre>
<ul>
<li>
<strong>roxygen2</strong> automatically creates a help file <code>reexports.Rd</code> in which there is a link to the original documentation of the re-exported generics.</li>
</ul>
<p>In <code>DESCRIPTION</code>, the original package for each generic must be listed in the <code>Imports:</code> directive:</p>
<pre><code>Imports: ggplot2, graphics</code></pre>
<p>Last, importing functions from the tidyverse also requires some precautions:</p>
<ul>
<li>the <strong>tidyverse</strong> package is reserved for interactive use in R: there is no way to import it into <code>DESCRIPTION</code> because its dependencies may change and lead to unpredictable results.
The <strong>magrittr</strong> package provides the pipes, mainly <code>%&gt;%</code>.
The <strong>rlang</strong> package provides the <code>.data</code> object shown below.
They must be imported into <code>DESCRIPTION</code>.</li>
</ul>
<pre><code>Imports: magrittr, rlang, stats</code></pre>
<ul>
<li>Since it is not possible to prefix the <code>%&gt;%</code> with the package name, the function must be imported using the delimiters provided for functions whose names contain special characters:</li>
</ul>
<p></p>
<div class="sourceCode" id="cb430"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @importFrom magrittr `%&gt;%`</span></span></code></pre></div>
<p></p>
<ul>
<li>Functions in the tidyverse that use column names from tibbles or dataframes generate warnings at package check time because these names are confused with undefined variable names.
To avoid this confusion, the <code>.data</code> object of the <strong>rlang</strong> package is helpful (for example in <code><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes()</a></code> seen above).
It must be imported:</li>
</ul>
<p></p>
<div class="sourceCode" id="cb431"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @importFrom rlang .data</span></span></code></pre></div>
<p></p>
<p>Finally, the complete code is as follows:</p>
<p></p>
<div class="sourceCode" id="cb432"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Multiplication of a numeric vector</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param number a numeric vector</span></span>
<span><span class="co">#' @param times a number to multiply</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @return an object of class `multiple`</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @examples</span></span>
<span><span class="co">#' multiple(1:2,3)</span></span>
<span><span class="va">multiple</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">number</span>, <span class="va">times</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Calculate the multiples</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="va">number</span> <span class="op">*</span> <span class="va">times</span></span>
<span>  <span class="co"># Save in a list</span></span>
<span>  <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">number</span>, y <span class="op">=</span> <span class="va">y</span>, times <span class="op">=</span> <span class="va">times</span><span class="op">)</span></span>
<span>  <span class="co"># Set the class</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"multiple"</span>, <span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#' Print objects of class multiple</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param x an object of class `multiple`.</span></span>
<span><span class="co">#' @param ... further arguments passed to the generic method.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @examples</span></span>
<span><span class="co">#' print(multiple(2,3))</span></span>
<span><span class="va">print.multiple</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.default.html">print.default</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">y</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#' Summarize objects of class multiple</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param object an object of class `multiple`.</span></span>
<span><span class="co">#' @param ... further arguments passed to the generic method.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @examples</span></span>
<span><span class="co">#' summary(multiple(2,3))</span></span>
<span><span class="va">summary.multiple</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.default.html">print.default</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"multiplied by"</span>, <span class="va">object</span><span class="op">$</span><span class="va">times</span>, <span class="st">"is:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.default.html">print.default</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">y</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#' Plot objects of class multiple</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param x a vector of numbers</span></span>
<span><span class="co">#' @param y a vector of multiplied numbers</span></span>
<span><span class="co">#' @param ... further arguments passed to the generic method.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @importFrom graphics plot</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @examples</span></span>
<span><span class="co">#' plot(multiple(2,3))</span></span>
<span><span class="va">plot.multiple</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot.default</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">x</span><span class="op">$</span><span class="va">y</span>, x<span class="op">=</span><span class="va">x</span><span class="op">$</span><span class="va">x</span>, type <span class="op">=</span> <span class="st">"p"</span>, </span>
<span>               main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Multiplication by"</span>, <span class="va">x</span><span class="op">$</span><span class="va">times</span><span class="op">)</span>, <span class="va">...</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="fu">graphics</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span></span></code></pre></div>
<pre><code>## function (x, y, ...) 
## UseMethod("plot")
## &lt;bytecode: 0x10649b3b0&gt;
## &lt;environment: namespace:base&gt;</code></pre>
<div class="sourceCode" id="cb434"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' autoplot</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' ggplot of the `multiple` objects.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param object an object of class `multiple`.</span></span>
<span><span class="co">#' @param ... ignored.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @return a `ggplot` object</span></span>
<span><span class="co">#' @importFrom ggplot2 autoplot</span></span>
<span><span class="co">#' @importFrom magrittr `%&gt;%`</span></span>
<span><span class="co">#' @importFrom rlang .data</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @examples</span></span>
<span><span class="co">#' autoplot(multiple(2,3))</span></span>
<span><span class="va">autoplot.multiple</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">object</span><span class="op">$</span><span class="va">x</span>, y <span class="op">=</span> <span class="va">object</span><span class="op">$</span><span class="va">y</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.data</span><span class="op">$</span><span class="va">x</span>, y <span class="op">=</span> <span class="va">.data</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Multiplication by"</span>, </span>
<span>                                <span class="va">object</span><span class="op">$</span><span class="va">times</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="fu">ggplot2</span><span class="fu">::</span><span class="va"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span></span></code></pre></div>
<pre><code>## function (object, ...) 
## {
##     UseMethod("autoplot")
## }
## &lt;bytecode: 0x118611d40&gt;
## &lt;environment: namespace:ggplot2&gt;</code></pre>
<p></p>
</div>
</div>
<div id="c-code" class="section level3" number="5.5.4">
<h3>
<span class="header-section-number">5.5.4</span> C++ code<a class="anchor" aria-label="anchor" href="#c-code"><i class="fas fa-link"></i></a>
</h3>
<p>The use of C++ code has been seen in section <a href="chap-utiliseR.html#sec:cpp">2.5</a>.
To integrate these functions in a package, the following rules must be respected:</p>
<ul>
<li>The <code>.cpp</code> files containing the code are placed in the <code>/src</code> folder of the project.</li>
<li>The code is commented for <strong>roxygen2</strong> in the same way as for R functions, but with the C language comment marker:</li>
</ul>
<p></p>
<div class="sourceCode" id="cb436"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb436-1"><a href="chap-package.html#cb436-1" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb436-2"><a href="chap-package.html#cb436-2" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> Rcpp<span class="op">;</span></span>
<span id="cb436-3"><a href="chap-package.html#cb436-3" tabindex="-1"></a></span>
<span id="cb436-4"><a href="chap-package.html#cb436-4" tabindex="-1"></a><span class="co">//' timesTwo</span></span>
<span id="cb436-5"><a href="chap-package.html#cb436-5" tabindex="-1"></a><span class="co">//'</span></span>
<span id="cb436-6"><a href="chap-package.html#cb436-6" tabindex="-1"></a><span class="co">//' Calculates the double of a value.</span></span>
<span id="cb436-7"><a href="chap-package.html#cb436-7" tabindex="-1"></a><span class="co">//'</span></span>
<span id="cb436-8"><a href="chap-package.html#cb436-8" tabindex="-1"></a><span class="co">//' @param x A numeric vector.</span></span>
<span id="cb436-9"><a href="chap-package.html#cb436-9" tabindex="-1"></a><span class="co">//' @export</span></span>
<span id="cb436-10"><a href="chap-package.html#cb436-10" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb436-11"><a href="chap-package.html#cb436-11" tabindex="-1"></a>NumericVector timesTwo<span class="op">(</span>NumericVector x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb436-12"><a href="chap-package.html#cb436-12" tabindex="-1"></a>  <span class="cf">return</span> x <span class="op">*</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb436-13"><a href="chap-package.html#cb436-13" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p></p>
<ul>
<li>In <code>DESCRIPTION</code>, import the packages.
<strong>Rcpp</strong>, and <strong>RcppParallel</strong> if parallelized code is used (delete its references otherwise), must be declared in <code>LinkingTo</code>:</li>
</ul>
<pre><code>Imports: Rcpp, RcppParallel
LinkingTo: Rcpp, RcppParallel</code></pre>
<ul>
<li>Comments for <strong>roxygen2</strong> should be added to <code>package.R</code> (“multiple” is the package name):</li>
</ul>
<p></p>
<div class="sourceCode" id="cb438"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @importFrom Rcpp sourceCpp</span></span>
<span><span class="co">#' @importFrom RcppParallel RcppParallelLibs</span></span>
<span><span class="co">#' @useDynLib multiple, .registration = TRUE</span></span></code></pre></div>
<p></p>
<ul>
<li>C++ working files are excluded from source control in <code>.gitignore</code>:</li>
</ul>
<pre><code># C binaries
src/*.o
src/*.so
src/*.dll</code></pre>
<p>These changes are partly done automatically, for <strong>Rcpp</strong> only, by <strong>usethis</strong>, but manual insertion of the code is faster and more reliable: do not use this command.</p>
<p></p>
<div class="sourceCode" id="cb440"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># usethis::use_rcpp()</span></span></code></pre></div>
<p></p>
<p>Building the package will lead to compiling the code: Rtools are therefore essential.</p>
</div>
<div id="tidy-package" class="section level3" number="5.5.5">
<h3>
<span class="header-section-number">5.5.5</span> Tidy package<a class="anchor" aria-label="anchor" href="#tidy-package"><i class="fas fa-link"></i></a>
</h3>
<p>Any modern package should be tidyverse compatible, which requires little effort:</p>
<ul>
<li>To allow pipelines, the main argument of functions should be the first one.</li>
<li>Functions that transform data should accept a dataframe or tibble as the first argument and return an object of the same format.</li>
<li>Methods <code><a href="https://rdrr.io/r/base/plot.html">plot()</a></code> should be doubled with methods <code><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot()</a></code> with the same arguments that produce the same graph with <strong>ggplot2</strong>.</li>
</ul>
</div>
</div>
<div id="bibliography-1" class="section level2" number="5.6">
<h2>
<span class="header-section-number">5.6</span> Bibliography<a class="anchor" aria-label="anchor" href="#bibliography-1"><i class="fas fa-link"></i></a>
</h2>
<p>The documentation of a package uses bibliographic references.
They can be managed automatically with <strong>Rdpack</strong> and <strong>roxygen2</strong>.
References used in R Markdown files (vignette, site produced by <strong>pkgdown</strong>) are not concerned.</p>
<div id="preparation" class="section level3" number="5.6.1">
<h3>
<span class="header-section-number">5.6.1</span> Preparation<a class="anchor" aria-label="anchor" href="#preparation"><i class="fas fa-link"></i></a>
</h3>
<p>Bibliographic references must be placed in a BibTeX file <code>REFERENCES.bib</code> placed in the <code>inst</code> folder.
This folder contains files that will be placed in the root of the package folder when it is installed.</p>
<p>Add the following line to <code>DESCRIPTION</code>:</p>
<pre><code>RdMacros: Rdpack</code></pre>
<p>Also add the package <code>Rdpack</code> to the list of imported packages:</p>
<pre><code>Imports: magrittr, stats, Rcpp, Rdpack</code></pre>
<p>Finally, import the <code>reprompt()</code> function from <strong>Rdpack</strong> by adding the following lines to the documentation for <strong>roxygen2</strong> in <code>package.R</code>:</p>
<p></p>
<div class="sourceCode" id="cb443"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @importFrom Rdpack reprompt</span></span></code></pre></div>
<p></p>
</div>
<div id="citations" class="section level3" number="5.6.2">
<h3>
<span class="header-section-number">5.6.2</span> Citations<a class="anchor" aria-label="anchor" href="#citations"><i class="fas fa-link"></i></a>
</h3>
<p>References are cited by the command <code>\insertCite{key}{package}</code> in the documentation for <strong>roxygen2</strong>.
<code>package</code> is the name of the package in which the <code>REFERENCES.bib</code> file is to be searched: this will normally be the current package, but references to other packages are accessible, provided only that they use <strong>Rdpack</strong>.</p>
<p><code>key</code> is the identifier of the reference in the file.
The following example<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;strong&gt;divent&lt;/strong&gt; package on GitHub: &lt;a href="https://github.com/EricMarcon/divent/blob/master/R/package.R" class="uri"&gt;https://github.com/EricMarcon/divent/blob/master/R/package.R&lt;/a&gt;&lt;/p&gt;'><sup>106</sup></a> is from the documentation of the <strong>divent</strong> package hosted on GitHub, in its <code>.R</code> file:</p>
<p></p>
<div class="sourceCode" id="cb444"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' divent</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' Measures of Diversity and Entropy</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' This package is a reboot of the **entropart** package \insertCite{Marcon2014c}{divent}.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @importFrom Rdpack reprompt</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' @references</span></span>
<span><span class="co">#' \insertAllCited{}</span></span>
<span><span class="st">"_PACKAGE"</span></span></code></pre></div>
<pre><code>## [1] "_PACKAGE"</code></pre>
<p></p>
<p>The cited reference is in <code>inst/REFERENCES.bib</code>:</p>
<pre><code>@Article{Marcon2014c,
  author  = {Marcon, Eric and Herault, Bruno},
  title   = {entropart, an R Package to Partition 
             Diversity},
  journal = {Journal of Statistical Software},
  year    = {2015},
  volume  = {67},
  number  = {8},
  pages   = {1--26},
}</code></pre>
<p>Citations are enclosed in parentheses.
To place the author’s name outside the parenthesis, add the statement <code>;textual</code>:</p>
<pre><code>\insertCite{Marcon2014c;textual}{divent}</code></pre>
<p>To cite several references (necessarily from the same package), separate them with commas.</p>
<p>At the end of the documentation of an object using citations, systematically add a list of references:</p>
<p></p>
<div class="sourceCode" id="cb448"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @references</span></span>
<span><span class="co">#' \insertAllCited{}</span></span></code></pre></div>
<p></p>
</div>
</div>
<div id="data" class="section level2" number="5.7">
<h2>
<span class="header-section-number">5.7</span> Data<a class="anchor" aria-label="anchor" href="#data"><i class="fas fa-link"></i></a>
</h2>
<p>Data can be embedded in a package, especially for the clarity of the examples.</p>
<p>The simplest method is to use <strong>usethis</strong>.
Create variables containing the data to be saved and then save them:</p>
<p></p>
<div class="sourceCode" id="cb449"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">seq1_10</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span></span>
<span><span class="va">seq1_100</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">100</span></span>
<span><span class="fu">usethis</span><span class="fu">::</span><span class="fu"><a href="https://usethis.r-lib.org/reference/use_data.html">use_data</a></span><span class="op">(</span><span class="va">seq1_10</span>, <span class="va">seq1_100</span><span class="op">)</span></span></code></pre></div>
<p></p>
<p>An <code>.rda</code> file is created in the <code>data</code> folder for each variable created.
With the <code>LazyData</code> option enabled in <code>DESCRIPTION</code>, variables will be available as soon as the package is loaded, but will not actually be loaded into memory until after they are used for the first time.</p>
<p>Each variable must be documented in the <code>package.R</code> file:</p>
<p></p>
<div class="sourceCode" id="cb450"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' seq1_10</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' A sequence of numbers from 1 to 10</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @format A numeric vector.</span></span>
<span><span class="co">#' @source Values computed by the R software, </span></span>
<span><span class="co">#'   \url{https://www.r-project.org/}</span></span>
<span><span class="st">"seq1_10"</span></span></code></pre></div>
<p></p>
<p>The name of the variable is given in quotes after the comment block (instead of the R code of a function).
<code>@format</code> describes the format of the data and <code>@source</code> is used to indicate its source.</p>
</div>
<div id="unit-tests" class="section level2" number="5.8">
<h2>
<span class="header-section-number">5.8</span> Unit tests<a class="anchor" aria-label="anchor" href="#unit-tests"><i class="fas fa-link"></i></a>
</h2>
<p>Ideally, all code included in a package should be tested in multiple ways:</p>
<ul>
<li>Against syntax errors: R’s checking procedures handle this quite well.</li>
<li>To check the conformity of the computation results to the expected values.</li>
<li>Against the occurrence of errors if users do not use the code as the developer intended (incorrect arguments passed to functions, inadequate data…).</li>
</ul>
<p>Unit tests are used for the last two objectives.
They are based on <strong>testthat</strong> to be integrated in the package:</p>
<p></p>
<div class="sourceCode" id="cb451"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">usethis</span><span class="fu">::</span><span class="fu"><a href="https://usethis.r-lib.org/reference/use_testthat.html">use_testthat</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p></p>
<p></p>
<pre><code>## 
## Attaching package: 'testthat'</code></pre>
<pre><code>## The following object is masked from 'package:targets':
## 
##     matches</code></pre>
<pre><code>## The following object is masked from 'package:dplyr':
## 
##     matches</code></pre>
<pre><code>## The following object is masked from 'package:purrr':
## 
##     is_null</code></pre>
<pre><code>## The following objects are masked from 'package:readr':
## 
##     edition_get, local_edition</code></pre>
<pre><code>## The following object is masked from 'package:tidyr':
## 
##     matches</code></pre>
<p></p>
<p>The tests must be added as <code>.R</code> files whose names must begin with <code>test' in the</code>tests/testthat` folder.</p>
<p>Each test (so the content of each file) starts with its context, i.e. a set of tests. For example, in a file <code>test_double.R</code>:</p>
<p></p>
<div class="sourceCode" id="cb458"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">context</span><span class="op">(</span><span class="st">"function double"</span><span class="op">)</span></span></code></pre></div>
<p></p>
<p>The tests are contained in files that group them by topic, for example <code>test_double.R</code>.
The name of each test is passed as an argument to the function <code>test_that()</code>:</p>
<p></p>
<div class="sourceCode" id="cb459"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">test_that</span><span class="op">(</span><span class="st">"Double values are correct"</span>, <span class="op">{</span></span>
<span>    <span class="fu">skip_on_cran</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span></span>
<span>    <span class="co"># 2 x 2 should be 4</span></span>
<span>    <span class="fu">expect_equal</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/double.html">double</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="co"># The result should be a number (type = 'double')</span></span>
<span>    <span class="fu">expect_type</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/double.html">double</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="st">"double"</span><span class="op">)</span></span>
<span>    <span class="co"># Error management</span></span>
<span>    <span class="fu">expect_error</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/double.html">double</a></span><span class="op">(</span><span class="st">"a"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<pre><code>## Test passed 🎊</code></pre>
<p></p>
<p>All functions starting with <code>expect</code> allow to compare their first argument to a result: in the above example, the result of <code>double(1:2)</code> must be <code>2 4</code> and the type of this vector must be double precision real.
The last test checks whether a string passed as an argument generates an error, which is not optimal: if the package handled the error, the returned message could be tested.</p>
<p>The <code>skip_on_cran()</code> command, to be used systematically, avoids running the tests on CRAN when the package is dropped there: CRAN has limited resources and strictly limits the time for checking packages on its platform.
The tests will therefore have to be run on GitHub, thanks to continuous integration, see section <a href="chap-package.html#sec:package-ci5">5.10</a>.</p>
<p>The tests can be launched by the “More &gt; Test package” menu of the <em>Build</em> window or by the <code>devtools::test()</code> command.</p>
<p>It is advisable to write the tests as soon as a function of the package is stabilized.</p>
</div>
<div id="gitignore-file" class="section level2" number="5.9">
<h2>
<span class="header-section-number">5.9</span> .gitignore file<a class="anchor" aria-label="anchor" href="#gitignore-file"><i class="fas fa-link"></i></a>
</h2>
<p>The <code>.gitignore</code> file obtained at this stage is incomplete.
It can be replaced by this one:</p>
<pre><code># History files
.Rhistory
.Rapp.history
# Session Data files
.RData
# Example code in package build process
*-Ex.R
# Output files from R CMD build
/*.tar.gz
# Output files from R CMD check
/*.Rcheck/
# RStudio files
.Rproj.user/
.Rprofile
# knitr and R markdown default cache directories
*_cache/
/cache/
# Temporary files created by R markdown
*.utf8.md
*.knit.md
# C binaries
src/*.o
src/*.so
src/*.dll
/src-i386/
/src-x64/
# uncomment if pkgdown is run by CI
# docs/</code></pre>
<p>The last line is for the <code>docs/</code> folder, which receives the web site produced by <strong>pkgdown</strong>.
It is commented out as long as the production of the site is done locally, but uncommented if it is entrusted to GitHub Actions (see next section).</p>
</div>
<div id="sec:package-ci5" class="section level2" number="5.10">
<h2>
<span class="header-section-number">5.10</span> Continuous integration<a class="anchor" aria-label="anchor" href="#sec:package-ci5"><i class="fas fa-link"></i></a>
</h2>
<p>A package check must be done at each step of the development, which consumes a considerable amount of time.
It can be automated very easily with the GitHub Actions service, triggered at each modification of the repository on GitHub.
The analysis of the code coverage by tests (which parts of the code are tested or not) will be added.</p>
<p>GitHub is also able to rebuild the package documentation with <strong>pkgdown</strong>, another resource-consuming operation, after the tests have passed.</p>
<p>Section <a href="chap-ci.html#sec:package-ci6">6.3.3</a> details how to do this.</p>
</div>
<div id="sec:package-cran" class="section level2" number="5.11">
<h2>
<span class="header-section-number">5.11</span> CRAN<a class="anchor" aria-label="anchor" href="#sec:package-cran"><i class="fas fa-link"></i></a>
</h2>
<p>Packages with an audience beyond the author’s circle can be uploaded to CRAN.
The rules to respect on CRAN are numerous<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://cran.r-project.org/web/packages/policies.html" class="uri"&gt;https://cran.r-project.org/web/packages/policies.html&lt;/a&gt;&lt;/p&gt;'><sup>107</sup></a>. They are checked by the <code>R CMD check</code> command with the <code>-- as.cran</code> option.
The check must not return any errors, warnings, or notes before submitting the package.</p>
<div id="testing-the-package" class="section level3" number="5.11.1">
<h3>
<span class="header-section-number">5.11.1</span> Testing the package<a class="anchor" aria-label="anchor" href="#testing-the-package"><i class="fas fa-link"></i></a>
</h3>
<p>Verification of the package by GitHub as part of continuous integration is not sufficient.
The package must be tested on the development version of R.
The <em>R-hub builder</em><a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://builder.r-hub.io/" class="uri"&gt;https://builder.r-hub.io/&lt;/a&gt;&lt;/p&gt;'><sup>108</sup></a> site allows to do it easily.</p>
<p>The package, which must not be a development version (limited to three numbers, see section <a href="chap-package.html#sec:package-description">5.2.1</a>), must be built in source format: in the <em>Build</em> window of RStudio, click on “More &gt; Build Source Package”.
On the <em>R-hub builder</em> site, click on “Advanced”, select the package source file and the test platform: <em>Debian Linux, R-devel, GCC</em>.</p>
<p>The <strong>rhub</strong> package allows you to use the same verification platform as the <em>R-hub builder</em> site from RStudio.
The first step is to validate your email address with the <code>validate_email()</code> command.
Then, just call the <code>check_for_cran()</code> function to run a full verification.</p>
</div>
<div id="submission" class="section level3" number="5.11.2">
<h3>
<span class="header-section-number">5.11.2</span> Submission<a class="anchor" aria-label="anchor" href="#submission"><i class="fas fa-link"></i></a>
</h3>
<p>When the package is ready, submission to CRAN is done through the dedicated web site<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://xmpalantir.wu.ac.at/cransubmit/" class="uri"&gt;https://xmpalantir.wu.ac.at/cransubmit/&lt;/a&gt;&lt;/p&gt;'><sup>109</sup></a>.</p>
<p>In case of rejection, process the requests and resubmit after incrementing the version number.</p>
</div>
<div id="maintenance" class="section level3" number="5.11.3">
<h3>
<span class="header-section-number">5.11.3</span> Maintenance<a class="anchor" aria-label="anchor" href="#maintenance"><i class="fas fa-link"></i></a>
</h3>
<p>Requests for corrections are sent by CRAN from time to time, especially when the version of R changes.
The email address of the package maintainer must remain valid and the requests must be processed quickly.
Otherwise, the package is archived.</p>
<p>New versions of the package are submitted in the same way as the first one.</p>

</div>
</div>
</div>

  <div class="chapter-nav">
<div class="prev"><a href="chap-rediger.html"><span class="header-section-number">4</span> Writing</a></div>
<div class="next"><a href="chap-ci.html"><span class="header-section-number">6</span> Continuous integration</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#chap-package"><span class="header-section-number">5</span> Package</a></li>
<li>
<a class="nav-link" href="#first-package"><span class="header-section-number">5.1</span> First package</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#creation"><span class="header-section-number">5.1.1</span> Creation</a></li>
<li><a class="nav-link" href="#first-function"><span class="header-section-number">5.1.2</span> First function</a></li>
<li><a class="nav-link" href="#sec:package-cds"><span class="header-section-number">5.1.3</span> Source control</a></li>
<li><a class="nav-link" href="#package.r"><span class="header-section-number">5.1.4</span> package.R</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#package-organization"><span class="header-section-number">5.2</span> Package organization</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#sec:package-description"><span class="header-section-number">5.2.1</span> DESCRIPTION file</a></li>
<li><a class="nav-link" href="#news.md-file"><span class="header-section-number">5.2.2</span> NEWS.md file</a></li>
</ul>
</li>
<li><a class="nav-link" href="#vignette"><span class="header-section-number">5.3</span> Vignette</a></li>
<li><a class="nav-link" href="#pkgdown"><span class="header-section-number">5.4</span> pkgdown</a></li>
<li>
<a class="nav-link" href="#package-specific-code"><span class="header-section-number">5.5</span> Package specific code</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#importing-functions"><span class="header-section-number">5.5.1</span> Importing functions</a></li>
<li><a class="nav-link" href="#s3-methods"><span class="header-section-number">5.5.2</span> S3 methods</a></li>
<li><a class="nav-link" href="#in-practice"><span class="header-section-number">5.5.3</span> In practice</a></li>
<li><a class="nav-link" href="#c-code"><span class="header-section-number">5.5.4</span> C++ code</a></li>
<li><a class="nav-link" href="#tidy-package"><span class="header-section-number">5.5.5</span> Tidy package</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#bibliography-1"><span class="header-section-number">5.6</span> Bibliography</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#preparation"><span class="header-section-number">5.6.1</span> Preparation</a></li>
<li><a class="nav-link" href="#citations"><span class="header-section-number">5.6.2</span> Citations</a></li>
</ul>
</li>
<li><a class="nav-link" href="#data"><span class="header-section-number">5.7</span> Data</a></li>
<li><a class="nav-link" href="#unit-tests"><span class="header-section-number">5.8</span> Unit tests</a></li>
<li><a class="nav-link" href="#gitignore-file"><span class="header-section-number">5.9</span> .gitignore file</a></li>
<li><a class="nav-link" href="#sec:package-ci5"><span class="header-section-number">5.10</span> Continuous integration</a></li>
<li>
<a class="nav-link" href="#sec:package-cran"><span class="header-section-number">5.11</span> CRAN</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#testing-the-package"><span class="header-section-number">5.11.1</span> Testing the package</a></li>
<li><a class="nav-link" href="#submission"><span class="header-section-number">5.11.2</span> Submission</a></li>
<li><a class="nav-link" href="#maintenance"><span class="header-section-number">5.11.3</span> Maintenance</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/EricMarcon/WorkingWithR/blob/master/05-Package.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/EricMarcon/WorkingWithR/edit/master/05-Package.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Working with R</strong>" was written by Eric Marcon. It was last built on 05/22/2024.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
