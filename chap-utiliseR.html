<!DOCTYPE html>
<html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>2 Use R | Working with R</title>
<meta name="author" content="Eric Marcon">
<meta name="description" content="The literature devoted to learning R is flourishing. The following books are an arbitrary but useful selection: R for Data Science (Wickham and Grolemund 2016) presents a complete working method,...">
<meta name="generator" content="bookdown 0.42 with bs4_book()">
<meta property="og:title" content="2 Use R | Working with R">
<meta property="og:type" content="book">
<meta property="og:url" content="https://ericmarcon.github.io/WorkingWithR/chap-utiliseR.html">
<meta property="og:description" content="The literature devoted to learning R is flourishing. The following books are an arbitrary but useful selection: R for Data Science (Wickham and Grolemund 2016) presents a complete working method,...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="2 Use R | Working with R">
<meta name="twitter:description" content="The literature devoted to learning R is flourishing. The following books are an arbitrary but useful selection: R for Data Science (Wickham and Grolemund 2016) presents a complete working method,...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.8.0/transition.js"></script><script src="libs/bs3compat-0.8.0/tabs.js"></script><script src="libs/bs3compat-0.8.0/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><link href="libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">
<script src="libs/htmlwidgets-1.6.4/htmlwidgets.js"></script><link href="libs/vis-9.1.0/vis-network.min.css" rel="stylesheet">
<script src="libs/vis-9.1.0/vis-network.min.js"></script><script src="libs/visNetwork-binding-2.1.2/visNetwork.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<link href="libs/tabwid-1.1.3/tabwid.css" rel="stylesheet">
<script src="libs/tabwid-1.1.3/tabwid.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-7NVD1TWMCJ"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-7NVD1TWMCJ');
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
          margin-bottom: 0em;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Working with R</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Presentation</a></li>
<li><a class="" href="chap-logiciels.html"><span class="header-section-number">1</span> Software</a></li>
<li><a class="active" href="chap-utiliseR.html"><span class="header-section-number">2</span> Use R</a></li>
<li><a class="" href="chap-git.html"><span class="header-section-number">3</span> Git and GitHub</a></li>
<li><a class="" href="chap-rediger.html"><span class="header-section-number">4</span> Writing</a></li>
<li><a class="" href="chap-package.html"><span class="header-section-number">5</span> Package</a></li>
<li><a class="" href="chap-ci.html"><span class="header-section-number">6</span> Continuous integration</a></li>
<li><a class="" href="chap-shiny.html"><span class="header-section-number">7</span> Shiny</a></li>
<li><a class="" href="chap-enseigner.html"><span class="header-section-number">8</span> Teaching with R</a></li>
<li><a class="" href="chap-conclusion.html"><span class="header-section-number">9</span> Conclusion</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/EricMarcon/WorkingWithR">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="chap-utiliseR" class="section level1" number="2">
<h1>
<span class="header-section-number">2</span> Use R<a class="anchor" aria-label="anchor" href="#chap-utiliseR"><i class="fas fa-link"></i></a>
</h1>
<p>The literature devoted to learning R is flourishing.
The following books are an arbitrary but useful selection:</p>
<ul>
<li>
<a href="https://r4ds.had.co.nz/">R for Data Science</a> <span class="citation">(<a href="references.html#ref-Wickham2016">Wickham and Grolemund 2016</a>)</span> presents a complete working method, consistent with the tidyverse.</li>
<li>
<a href="http://adv-r.had.co.nz/">Advanced R</a> <span class="citation">(<a href="references.html#ref-Wickham2014">Wickham 2014</a>)</span> is the reference for mastering the subtleties of the language and understanding how R works.</li>
<li>Finally, <a href="https://csgillespie.github.io/efficientR/">Efficient R programming</a> <span class="citation">(<a href="references.html#ref-Gillespie2016">Gillespie and Lovelace 2016</a>)</span> deals with code optimization.</li>
</ul>
<p>Some advanced aspects of coding are seen here.
Details on the different languages of R are useful for creating packages.
The environments are presented next, for the proper understanding of the search for objects called by the code.
Finally, the optimization of code performance is discussed in depth (loops, C++ code and parallelization) and illustrated by a case study.</p>
<div id="the-languages-of-r" class="section level2" number="2.1">
<h2>
<span class="header-section-number">2.1</span> The languages of R<a class="anchor" aria-label="anchor" href="#the-languages-of-r"><i class="fas fa-link"></i></a>
</h2>
<p>R includes several programming languages.
The most common is S3, but it is not the only one<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://adv-r.had.co.nz/OO-essentials.html" class="uri"&gt;https://adv-r.had.co.nz/OO-essentials.html&lt;/a&gt;&lt;/p&gt;'><sup>18</sup></a>.</p>
<div id="base" class="section level3" number="2.1.1">
<h3>
<span class="header-section-number">2.1.1</span> Base<a class="anchor" aria-label="anchor" href="#base"><i class="fas fa-link"></i></a>
</h3>
<p>The core of R is the primitive functions and basic data structures like the <code>sum</code> function and <code>matrix</code> data:</p>
<p></p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pryr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pryr/man/otype.html">otype</a></span><span class="op">(</span><span class="va">sum</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "base"</code></pre>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/typeof.html">typeof</a></span><span class="op">(</span><span class="va">sum</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "builtin"</code></pre>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pryr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pryr/man/otype.html">otype</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "base"</code></pre>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/typeof.html">typeof</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "double"</code></pre>
<p></p>
<p>The <strong>pryr</strong> package allows to display the language in which objects are defined.
The <code><a href="https://rdrr.io/r/base/typeof.html">typeof()</a></code> function displays the internal storage type of the objects:</p>
<ul>
<li>the <code><a href="https://rdrr.io/r/base/sum.html">sum()</a></code> function belongs to the basic language of R and is a builtin function.</li>
<li>the elements of the numerical matrix containing a single 1 are double precision reals, and the matrix itself is defined in the basic language.</li>
</ul>
<p>Primitive functions are coded in C and are very fast.
They are always available, whatever the packages loaded.
Their use is therefore to be preferred.</p>
</div>
<div id="sec:S3" class="section level3" number="2.1.2">
<h3>
<span class="header-section-number">2.1.2</span> S3<a class="anchor" aria-label="anchor" href="#sec:S3"><i class="fas fa-link"></i></a>
</h3>
<p>S3 is the most used language, often the only one known by R users.</p>
<p>It is an object-oriented language in which classes, i.e. the type of objects, are declarative.</p>
<p></p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">MyFirstName</span> <span class="op">&lt;-</span> <span class="st">"Eric"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">MyFirstName</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"FirstName"</span></span></code></pre></div>
<p></p>
<p>The variable <code>MyFirstName</code> is here classed as <code>FirstName</code> by a simple declaration.</p>
<p>Unlike the way a classical object-oriented language works<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://www.troispointzero.fr/le-blog/introduction-a-la-programmation-orientee-objet-poo/" class="uri"&gt;https://www.troispointzero.fr/le-blog/introduction-a-la-programmation-orientee-objet-poo/&lt;/a&gt;&lt;/p&gt;'><sup>19</sup></a>, S3 methods are related to functions, not objects.</p>
<p></p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Default display</span></span>
<span><span class="va">MyFirstName</span></span></code></pre></div>
<pre><code>## [1] "Eric"
## attr(,"class")
## [1] "FirstName"</code></pre>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">print.Firstname</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"The first name is"</span>, <span class="va">x</span><span class="op">)</span> </span>
<span><span class="co"># Modified display</span></span>
<span><span class="va">MyFirstName</span></span></code></pre></div>
<pre><code>## [1] "Eric"
## attr(,"class")
## [1] "FirstName"</code></pre>
<p></p>
<p>In this example, the <code><a href="https://rdrr.io/r/base/print.html">print()</a></code> method applied to the “Firstname” class is modified.
In a classical object-oriented language, the method would be defined in the class <code>Firstname</code>.
In R, methods are defined from generic methods.</p>
<p><code>print</code> is a generic method (“a generic”) declared in <strong>base</strong>.</p>
<p></p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pryr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pryr/man/otype.html">otype</a></span><span class="op">(</span><span class="va">print</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "base"</code></pre>
<p></p>
<p>Its code is just a <code>UseMethod("print")</code> declaration:</p>
<p></p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">print</span></span></code></pre></div>
<pre><code>## function (x, ...) 
## UseMethod("print")
## &lt;bytecode: 0x131196e38&gt;
## &lt;environment: namespace:base&gt;</code></pre>
<p></p>
<p>There are many S3 methods for <code>print</code>:</p>
<p></p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/methods.html">methods</a></span><span class="op">(</span><span class="st">"print"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "print.acf"               "print.activeConcordance"
## [3] "print.AES"               "print.all_vars"         
## [5] "print.anova"             "print.any_vars"</code></pre>
<p></p>
<p>Each applies to a class. <code>print.default</code> is used as a last resort and relies on the type of the object, not its S3 class.</p>
<p></p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/typeof.html">typeof</a></span><span class="op">(</span><span class="va">MyFirstName</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "character"</code></pre>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pryr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pryr/man/otype.html">otype</a></span><span class="op">(</span><span class="va">MyFirstName</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "S3"</code></pre>
<p></p>
<p>An object can belong to several classes, which allows a form of inheritance of methods.
In a classical object oriented language, inheritance allows to define more precise classes (“FrenchFirstName”) which inherit from more general classes (“FirstName”) and thus benefit from their methods without having to redefine them.
In R, inheritance is simply declaring a vector of increasingly broad classes for an object:</p>
<p></p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Definition of classes by a vector</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">MyFirstName</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"FrenchFirstName"</span>, <span class="st">"FirstName"</span><span class="op">)</span></span>
<span><span class="co"># Alternative code, with inherits()</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">inherits</a></span><span class="op">(</span><span class="va">MyFirstName</span>, what <span class="op">=</span> <span class="st">"FrenchFirstName"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html">inherits</a></span><span class="op">(</span><span class="va">MyFirstName</span>, what <span class="op">=</span> <span class="st">"FirstName"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p></p>
<p>The generic looks for a method for each class, in the order of their declaration.</p>
<p></p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">print.FrenchFirstName</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"French first name:"</span>, <span class="va">x</span><span class="op">)</span> </span>
<span><span class="va">MyFirstName</span></span></code></pre></div>
<pre><code>## French first name: Eric</code></pre>
<p></p>
<p>In summary, S3 is the common language of R.
Almost all packages are written in S3.
Generics are everywhere but go unnoticed, for example in packages:</p>
<p></p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://ericmarcon.github.io/entropart/">"entropart"</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/methods.html">.S3methods</a></span><span class="op">(</span>class <span class="op">=</span> <span class="st">"SpeciesDistribution"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] autoplot plot    
## see '?methods' for accessing help and source code</code></pre>
<p></p>
<p>The <code><a href="https://rdrr.io/r/utils/methods.html">.S3methods()</a></code> function displays all available methods for a class, as opposed to <code><a href="https://rdrr.io/r/utils/methods.html">methods()</a></code> which displays all classes for which the method passed as an argument is defined.</p>
<p>Many primitive functions in R are generic methods.
To find out about them, use the <code><a href="https://rdrr.io/r/base/InternalMethods.html">help(InternalMethods)</a></code> helper.</p>
</div>
<div id="s4" class="section level3" number="2.1.3">
<h3>
<span class="header-section-number">2.1.3</span> S4<a class="anchor" aria-label="anchor" href="#s4"><i class="fas fa-link"></i></a>
</h3>
<p>S4 is an evolution of S3 that structures classes to get closer to a classical object oriented language:</p>
<ul>
<li>Classes must be explicitly defined, not simply declared.</li>
<li>1ttributes (i.e. variables describing objects), called <em>slots</em>, are explicitly declared.</li>
<li>The constructor, i.e. the method that creates a new instance of a class (i.e. a variable containing an object of the class), is explicit.</li>
</ul>
<p>Using the previous example, the S4 syntax is as follows:</p>
<p></p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Definition of the class Person, with its slots</span></span>
<span><span class="kw">setClass</span><span class="op">(</span></span>
<span>  <span class="st">"Person"</span>,  </span>
<span>  slots <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>LastName <span class="op">=</span> <span class="st">"character"</span>, FirstName <span class="op">=</span> <span class="st">"character"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#  Construction of an instance</span></span>
<span><span class="va">Me</span> <span class="op">&lt;-</span> <span class="fu">new</span><span class="op">(</span><span class="st">"Person"</span>, LastName <span class="op">=</span> <span class="st">"Marcon"</span>, FirstName <span class="op">=</span> <span class="st">"Eric"</span><span class="op">)</span></span>
<span><span class="co"># Language</span></span>
<span><span class="fu">pryr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pryr/man/otype.html">otype</a></span><span class="op">(</span><span class="va">Me</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "S4"</code></pre>
<p></p>
<p>Methods always belong to functions.
They are declared by the <code><a href="https://rdrr.io/r/methods/setMethod.html">setMethod()</a></code> function:</p>
<p></p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">setMethod</span><span class="op">(</span></span>
<span>  <span class="st">"print"</span>,</span>
<span>  signature <span class="op">=</span> <span class="st">"Person"</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"The person is:"</span>, <span class="va">x</span><span class="op">@</span><span class="va">FirstName</span>, <span class="va">x</span><span class="op">@</span><span class="va">LastName</span><span class="op">)</span> </span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">Me</span><span class="op">)</span></span></code></pre></div>
<pre><code>## The person is: Eric Marcon</code></pre>
<p></p>
<p>The attributes are called by the syntax <code>variable@slot</code>.</p>
<p>In summary, S4 is more rigorous than S3.
Some packages on CRAN : <strong>Matrix</strong>, <strong>sp</strong>, <strong>odbc</strong>… and many on Bioconductor are written in S4 but the language is now clearly abandoned in favor of S3, notably because of the success of the <strong>tidyverse</strong>.</p>
</div>
<div id="rc" class="section level3" number="2.1.4">
<h3>
<span class="header-section-number">2.1.4</span> RC<a class="anchor" aria-label="anchor" href="#rc"><i class="fas fa-link"></i></a>
</h3>
<p>RC was introduced in R 2.12 (2010) with the <strong>methods</strong> package.</p>
<p>Methods belong to classes, as in C++: they are declared in the class and called from the objects.</p>
<p></p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st">"methods"</span><span class="op">)</span></span>
<span><span class="co"># Declaration of the class</span></span>
<span><span class="va">PersonRC</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/methods/refClass.html">setRefClass</a></span><span class="op">(</span></span>
<span>  <span class="st">"PersonRC"</span>, </span>
<span>  fields <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>LastName <span class="op">=</span> <span class="st">"character"</span>, FirstName <span class="op">=</span> <span class="st">"character"</span><span class="op">)</span>,</span>
<span>  methods <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>print <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="va">FirstName</span>, <span class="va">LastName</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Constructeur</span></span>
<span><span class="va">MeRC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/methods/new.html">new</a></span><span class="op">(</span><span class="st">"PersonRC"</span>, LastName <span class="op">=</span> <span class="st">"Marcon"</span>, FirstName <span class="op">=</span> <span class="st">"Eric"</span><span class="op">)</span></span>
<span><span class="co"># Language</span></span>
<span><span class="fu">pryr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pryr/man/otype.html">otype</a></span><span class="op">(</span><span class="va">MeRC</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "RC"</code></pre>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Call the print method</span></span>
<span><span class="va">MeRC</span><span class="op">$</span><span class="fu">print</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## Eric Marcon</code></pre>
<p></p>
<p>RC is a confidential language, although it is the first “true” object-oriented language of R.</p>
</div>
<div id="s6" class="section level3" number="2.1.5">
<h3>
<span class="header-section-number">2.1.5</span> S6<a class="anchor" aria-label="anchor" href="#s6"><i class="fas fa-link"></i></a>
</h3>
<p>S6<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://r6.r-lib.org/" class="uri"&gt;https://r6.r-lib.org/&lt;/a&gt;&lt;/p&gt;'><sup>20</sup></a> enhances RC but is not included in R: it requires installing its package.</p>
<p>Attributes and methods can be public or private.
An <code><a href="https://rdrr.io/r/methods/new.html">initialize()</a></code> method is used as a constructor.</p>
<p></p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://r6.r-lib.org">"R6"</a></span><span class="op">)</span></span>
<span><span class="va">PersonR6</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://r6.r-lib.org/reference/R6Class.html">R6Class</a></span><span class="op">(</span></span>
<span>  <span class="st">"PersonR6"</span>, </span>
<span>  public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    LastName <span class="op">=</span> <span class="st">"character"</span>, </span>
<span>    FirstName <span class="op">=</span> <span class="st">"character"</span>,</span>
<span>    initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">LastName</span> <span class="op">=</span> <span class="cn">NA</span>, <span class="va">FirstName</span> <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">self</span><span class="op">$</span><span class="va">LastName</span> <span class="op">&lt;-</span> <span class="va">LastName</span></span>
<span>      <span class="va">self</span><span class="op">$</span><span class="va">FirstName</span> <span class="op">&lt;-</span> <span class="va">FirstName</span></span>
<span>    <span class="op">}</span>,</span>
<span>    print <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="va">self</span><span class="op">$</span><span class="va">FirstName</span>, <span class="va">self</span><span class="op">$</span><span class="va">LastName</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">MeR6</span> <span class="op">&lt;-</span> <span class="va">PersonR6</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>LastName <span class="op">=</span> <span class="st">"Marcon"</span>, FirstName <span class="op">=</span> <span class="st">"Eric"</span><span class="op">)</span></span>
<span><span class="va">MeR6</span><span class="op">$</span><span class="fu">print</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## Eric Marcon</code></pre>
<p></p>
<p>S6 allows to program rigorously in object but is very little used.
The performances of S6 are much better than those of RC but are inferior to those of S3<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://r6.r-lib.org/articles/Performance.html" class="uri"&gt;https://r6.r-lib.org/articles/Performance.html&lt;/a&gt;&lt;/p&gt;'><sup>21</sup></a>.</p>
<p>The non-inclusion of R6 to R is shown by <strong>pryr</strong>:</p>
<p></p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pryr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pryr/man/otype.html">otype</a></span><span class="op">(</span><span class="va">MeR6</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "S3"</code></pre>
<p></p>
</div>
<div id="tidyverse" class="section level3" number="2.1.6">
<h3>
<span class="header-section-number">2.1.6</span> Tidyverse<a class="anchor" aria-label="anchor" href="#tidyverse"><i class="fas fa-link"></i></a>
</h3>
<p>The tidyverse is a set of coherent packages that have evolved the way R is programmed.
The set of essential packages can be loaded by the <strong>tidyverse</strong> package which has no other use:</p>
<p></p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://tidyverse.tidyverse.org">"tidyverse"</a></span><span class="op">)</span></span></code></pre></div>
<p></p>
<p>This is not a new language per se but rather an extension of S3, with deep technical modifications, notably the unconventional evaluation of expressions<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://dplyr.tidyverse.org/articles/programming.html" class="uri"&gt;https://dplyr.tidyverse.org/articles/programming.html&lt;/a&gt;&lt;/p&gt;'><sup>22</sup></a>, which it is not essential to master in detail.</p>
<p>Its principles are written in a manifesto<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://cran.r-project.org/web/packages/tidyverse/vignettes/manifesto.html" class="uri"&gt;https://cran.r-project.org/web/packages/tidyverse/vignettes/manifesto.html&lt;/a&gt;&lt;/p&gt;'><sup>23</sup></a>.
Its most visible contribution for the user is the sequence of commands in a flow (code pipeline).</p>
<p>In standard programming, the sequence of functions is written by successive nesting, which makes it difficult to read, especially when arguments are needed:</p>
<p></p>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Base-2 logarithm of the mean of 100 random numbers in a uniform distribution</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span>, base <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] -1.127903</code></pre>
<p></p>
<p>In the tidyverse, the functions are chained together, which often better matches the programmer’s thinking about data processing:</p>
<p></p>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 100 random numbers in a uniform distribution</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co"># Mean</span></span>
<span>  <span class="va">mean</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co"># Base-2 logarithm</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span>base <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] -0.9772102</code></pre>
<p></p>
<p>The pipe <code>%&gt;%</code> is an operator that calls the next function by passing it as first argument the result of the previous function.
Additional arguments are passed normally: for the readability of the code, it is essential to name them.
Most of the R functions can be used without difficulty in the tidyverse, even though they were not designed for this purpose: it is sufficient that their first argument is the data to be processed.</p>
<p>The pipeline allows only one value to be passed to the next function, which prohibits multidimensional functions, such as <code>f(x,y)</code>.
The preferred data structure is the <em>tibble</em>, which is an improved dataframe: its <code><a href="https://rdrr.io/r/base/print.html">print()</a></code> method is more readable, and it corrects some unintuitive dataframe behavior, such as the automatic conversion of single-column dataframes to vectors.
The columns of the dataframe or tibble allow to pass as much data as needed.</p>
<p>Finally, data visualization is supported by <strong>ggplot2</strong> which relies on a theoretically sound graph grammar <span class="citation">(<a href="references.html#ref-Wickham2010">Wickham 2010</a>)</span>.
Schematically, a graph is constructed according to the following model:</p>
<pre><code>ggplot(data = &lt;DATA&gt;) + 
  &lt;GEOM_FUNCTION&gt;(
     mapping = aes(&lt;MAPPINGS&gt;),
     stat = &lt;STAT&gt;, 
     position = &lt;POSITION&gt;
  ) +
  &lt;COORDINATE_FUNCTION&gt; +
  &lt;FACET_FUNCTION&gt;</code></pre>
<ul>
<li>The data is necessarily a dataframe.</li>
<li>The geometry is the type of graph chosen (points, lines, histograms or other).</li>
<li>The aesthetics (function <code><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes()</a></code>) designates what is represented: it is the correspondence between the columns of the dataframe and the elements necessary for the geometry.</li>
<li>Statistics is the treatment applied to the data before passing it to the geometry (often “identity”, i.e. no transformation but “boxplot” for a boxplot).
The data can be transformed by a scale function, such as <code><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_log10()</a></code>.</li>
<li>The position is the location of the objects on the graph (often “identity”; “stack” for a stacked histogram, “jitter” to move the overlapping points slightly in a <code>geom_point</code>).</li>
<li>The coordinates define the display of the graph (<code><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html">coord_fixed()</a></code> to avoid distorting a map for example).</li>
<li>Finally, facets offer the possibility to display several aspects of the same data by producing one graph per modality of a variable.</li>
</ul>
<p>The set formed by the pipeline and <strong>ggplot2</strong> allows complex processing in a readable code.
Figure <a href="chap-utiliseR.html#fig:diamonds">2.1</a> shows the result of the following code:</p>

<p></p>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Diamonds data provided by ggplot2</span></span>
<span><span class="va">diamonds</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co"># Keep only diamonds larger than half a carat</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">carat</span> <span class="op">&gt;</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co"># Graph: price vs. weight</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">carat</span>, y <span class="op">=</span> <span class="va">price</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># Scatter plot</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="co"># Logarithmic scale</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_log10</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_log10</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="co"># Linear regression</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"lm"</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:diamonds"></span>
<img src="WwR_files/figure-html/diamonds-1.png" alt="Price of diamonds according to their weight. Demonstration of the ggplot2 code combined with tidyverse data processing." width="80%"><p class="caption">
Figure 2.1: Price of diamonds according to their weight. Demonstration of the <strong>ggplot2</strong> code combined with tidyverse data processing.
</p>
</div>
<p></p>
<p>In this figure, two geometries (scatterplot and linear regression) share the same aesthetics (price vs. weight in carats) which is therefore declared upstream, in the <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code> function.</p>
<p>The tidyverse is documented in detail in <span class="citation">Wickham and Grolemund (<a href="references.html#ref-Wickham2016">2016</a>)</span> and <strong>ggplot2</strong> in <span class="citation">Wickham (<a href="references.html#ref-Wickham2017">2017</a>)</span>.</p>
</div>
</div>
<div id="sec:environnements" class="section level2" number="2.2">
<h2>
<span class="header-section-number">2.2</span> Environments<a class="anchor" aria-label="anchor" href="#sec:environnements"><i class="fas fa-link"></i></a>
</h2>
<p>R’s objects, data and functions, are named.
Since R is modular, with the ability to add any number of packages to it, it is very likely that name conflicts will arise.
To deal with them, R has a rigorous system of name precedence: code runs in a defined environment, inheriting from parent environments.</p>
<div id="organization" class="section level3" number="2.2.1">
<h3>
<span class="header-section-number">2.2.1</span> Organization<a class="anchor" aria-label="anchor" href="#organization"><i class="fas fa-link"></i></a>
</h3>
<p>R starts in an empty environment.
Each loaded package creates a child environment to form a stack of environments, of which each new element is called a “child” of the previous one, which is its “parent”.</p>
<p>The console is in the global environment, the child of the last loaded package.</p>
<p></p>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/search.html">search</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>##  [1] ".GlobalEnv"        "package:R6"       
##  [3] "package:entropart" "package:lubridate"
##  [5] "package:forcats"   "package:stringr"  
##  [7] "package:dplyr"     "package:purrr"    
##  [9] "package:readr"     "package:tidyr"    
## [11] "package:tibble"    "package:ggplot2"  
## [13] "package:tidyverse" "package:stats"    
## [15] "package:graphics"  "package:grDevices"
## [17] "package:utils"     "package:datasets" 
## [19] "package:methods"   "Autoloads"        
## [21] "package:base"</code></pre>
<p></p>
<p>The code of a function called from the console runs in a child environment of the global environment:</p>
<p></p>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Current environment</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/environment.html">environment</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## &lt;environment: R_GlobalEnv&gt;</code></pre>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># The function f displays its environment</span></span>
<span><span class="va">f</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html">environment</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># Display the environment of the function</span></span>
<span><span class="fu">f</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## &lt;environment: 0x12b028518&gt;</code></pre>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Parent environment of the function's environment</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/environment.html">parent.env</a></span><span class="op">(</span><span class="fu">f</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## &lt;environment: R_GlobalEnv&gt;</code></pre>
<p></p>
</div>
<div id="search" class="section level3" number="2.2.2">
<h3>
<span class="header-section-number">2.2.2</span> Search<a class="anchor" aria-label="anchor" href="#search"><i class="fas fa-link"></i></a>
</h3>
<p>The search for ab object starts in the local environment.
If it is not found, it is searched in the parent environment, then in the parent of the parent, until the environments are exhausted, which generates an error indicating that the object was not found.</p>
<p>Example:</p>
<p></p>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Variable q defined in the global environment</span></span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="st">"GlobalEnv"</span></span>
<span><span class="co"># Function defining q in its environment</span></span>
<span><span class="va">qLocalFunction</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">q</span> <span class="op">&lt;-</span> <span class="st">"Function"</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">q</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># The local variable is returned</span></span>
<span><span class="fu">qLocalFunction</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "Function"</code></pre>
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Poorly written function using a variable it does not define</span></span>
<span><span class="va">qGlobalEnv</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>   <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">q</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># The global environment variable is returned</span></span>
<span><span class="fu">qGlobalEnv</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "GlobalEnv"</code></pre>
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Delete this variable</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">q</span><span class="op">)</span></span>
<span><span class="co"># The function base::q is returned</span></span>
<span><span class="fu">qGlobalEnv</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## function (save = "default", status = 0, runLast = TRUE) 
## .Internal(quit(save, status, runLast))
## &lt;bytecode: 0x12b5efee8&gt;
## &lt;environment: namespace:base&gt;</code></pre>
<p></p>
<p>The variable <code>q</code> is defined in the global environment.
The function <code>qLocalFunction</code> defines its own variable <code>q</code>.
Calling the function returns the its local value because it is in the function’s environment.</p>
<p>The <code>qGlobalEnv</code> function returns the <code>q</code> variable that it does not define locally.
So it looks for it in its parent environment and finds the variable defined in the global environment.
By removing the variable from the global environment with <code>rm(q)</code>, the <code>qGlobalEnv()</code> function scans the stack of environments until it finds an object named <code>q</code> in the <strong>base</strong> package, which is the function to exit R.
It could have found another object if a package containing a <code>q</code> object had been loaded.</p>
<p>To avoid this erratic behavior, a function should <em>never</em> call an object not defined in its own environment.</p>
</div>
<div id="package-namespaces" class="section level3" number="2.2.3">
<h3>
<span class="header-section-number">2.2.3</span> Package namespaces<a class="anchor" aria-label="anchor" href="#package-namespaces"><i class="fas fa-link"></i></a>
</h3>
<p>It is time to define precisely what packages make visible.
Packages contain objects (functions and data) which they <em>export</em> or not.
They are usually called by the <code><a href="https://rdrr.io/r/base/library.html">library()</a></code> function, which does two things:</p>
<ul>
<li>It <em>loads</em> the package into memory, allowing access to all its objects with the syntax <code>package::object</code> for exported objects and <code>package:::object</code> for non-exported ones.</li>
<li>It then <em>attaches</em> the package, which places its environment on top of the stack.</li>
</ul>
<p>It is possible to detach a package with the <code><a href="https://rdrr.io/r/base/ns-load.html">unloadNamespace()</a></code> function to remove it from the environment stack.
Example:</p>
<p></p>
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># entropart loaded and attached</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://ericmarcon.github.io/entropart/">"entropart"</a></span><span class="op">)</span></span>
<span><span class="co"># is it attached?</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">isNamespaceLoaded</a></span><span class="op">(</span><span class="st">"entropart"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># stack of environments</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/search.html">search</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>##  [1] ".GlobalEnv"        "package:R6"       
##  [3] "package:entropart" "package:lubridate"
##  [5] "package:forcats"   "package:stringr"  
##  [7] "package:dplyr"     "package:purrr"    
##  [9] "package:readr"     "package:tidyr"    
## [11] "package:tibble"    "package:ggplot2"  
## [13] "package:tidyverse" "package:stats"    
## [15] "package:graphics"  "package:grDevices"
## [17] "package:utils"     "package:datasets" 
## [19] "package:methods"   "Autoloads"        
## [21] "package:base"</code></pre>
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Diversity(), a function exported by entropart is found</span></span>
<span><span class="fu"><a href="https://ericmarcon.github.io/entropart/reference/Diversity.html">Diversity</a></span><span class="op">(</span><span class="fl">1</span>, CheckArguments <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code>## None 
##    1</code></pre>
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Detach and unload entropart</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">unloadNamespace</a></span><span class="op">(</span><span class="st">"entropart"</span><span class="op">)</span></span>
<span><span class="co"># Is it attached?</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">isNamespaceLoaded</a></span><span class="op">(</span><span class="st">"entropart"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] FALSE</code></pre>
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Stack of environments, without entropart</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/search.html">search</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>##  [1] ".GlobalEnv"        "package:R6"       
##  [3] "package:lubridate" "package:forcats"  
##  [5] "package:stringr"   "package:dplyr"    
##  [7] "package:purrr"     "package:readr"    
##  [9] "package:tidyr"     "package:tibble"   
## [11] "package:ggplot2"   "package:tidyverse"
## [13] "package:stats"     "package:graphics" 
## [15] "package:grDevices" "package:utils"    
## [17] "package:datasets"  "package:methods"  
## [19] "Autoloads"         "package:base"</code></pre>
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Diversity() cannot be found</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/conditions.html">tryCatch</a></span><span class="op">(</span><span class="fu"><a href="https://ericmarcon.github.io/entropart/reference/Diversity.html">Diversity</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">e</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## &lt;simpleError in Diversity(1): could not find function "Diversity"&gt;</code></pre>
<div class="sourceCode" id="cb93"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># but can be called with its full name</span></span>
<span><span class="fu">entropart</span><span class="fu">::</span><span class="fu"><a href="https://ericmarcon.github.io/entropart/reference/Diversity.html">Diversity</a></span><span class="op">(</span><span class="fl">1</span>, CheckArguments <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code>## None 
##    1</code></pre>
<p></p>
<p>Calling <code><a href="https://ericmarcon.github.io/entropart/reference/Diversity.html">entropart::Diversity()</a></code> loads the package (i.e., implicitly executes <code>loadNamespace("entropart")</code>) but does not attach it.</p>
<p>In practice, one should limit the number of attached packages to limit the risk of calling an unwanted function, homonymous to the desired function.
In critical cases, the full name of the function should be used: <code>package::function()</code>.</p>
<p>A common issue occurs with the <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code> function of <strong>dplyr</strong>, which is the namesake of the <strong>stats</strong> function.
The <strong>stats</strong> package is usually loaded before <strong>dplyr</strong>, a package in the tidyverse.
Thus, <code><a href="https://rdrr.io/r/stats/filter.html">stats::filter()</a></code> must be called explicitly.</p>
<p>However, the <strong>dplyr</strong> or <strong>tidyverse</strong> package (which attaches all the tidyverse packages) can be loaded systematically by creating a <code>.RProfile</code> at the root of the project containing the command:</p>
<p></p>
<div class="sourceCode" id="cb95"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://tidyverse.tidyverse.org">"tidyverse"</a></span><span class="op">)</span></span></code></pre></div>
<p></p>
<p>In this case, <strong>dplyr</strong> is loaded <em>before</em> <strong>stats</strong> so its function is inaccessible.</p>
</div>
</div>
<div id="measuring-execution-time" class="section level2" number="2.3">
<h2>
<span class="header-section-number">2.3</span> Measuring execution time<a class="anchor" aria-label="anchor" href="#measuring-execution-time"><i class="fas fa-link"></i></a>
</h2>
<p>The execution time of long code can be measured very simply by the <code>system.time</code> command.
For very short execution times, it is necessary to repeat the measurement: this is the purpose of the <strong>microbenchmark</strong> package.</p>
<div id="system.time" class="section level3" number="2.3.1">
<h3>
<span class="header-section-number">2.3.1</span> system.time<a class="anchor" aria-label="anchor" href="#system.time"><i class="fas fa-link"></i></a>
</h3>
<p>The function returns the execution time of the code.</p>
<p></p>
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Mean absolute deviation of 1000 values in a uniform distribution, repeated 100 times</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">100</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/mad.html">mad</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.008   0.001   0.009</code></pre>
<p></p>
</div>
<div id="microbenchmark" class="section level3" number="2.3.2">
<h3>
<span class="header-section-number">2.3.2</span> microbenchmark<a class="anchor" aria-label="anchor" href="#microbenchmark"><i class="fas fa-link"></i></a>
</h3>
<p>The <strong>microbenchmark</strong> package is the most advanced.</p>
<p>The goal is to compare the speed of computing the square of a vector (or a number) by multiplying it by itself (<span class="math inline">\(x \times x\)</span>) or by raising it to the power of 2 (<span class="math inline">\(x^2\)</span>).</p>
<p></p>
<div class="sourceCode" id="cb98"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Functions to test</span></span>
<span><span class="va">f1</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">*</span> <span class="va">x</span></span>
<span><span class="va">f2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">^</span><span class="fl">2</span></span>
<span><span class="va">f3</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">^</span><span class="fl">2.1</span></span>
<span><span class="va">f4</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">^</span><span class="fl">3</span></span>
<span><span class="co"># Initialization</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">10000</span><span class="op">)</span></span>
<span><span class="co"># Test</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/joshuaulrich/microbenchmark/">"microbenchmark"</a></span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">mb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="fu">f1</span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, <span class="fu">f2</span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, <span class="fu">f3</span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, <span class="fu">f4</span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## Unit: microseconds
##   expr     min       lq      mean   median       uq     max
##  f1(X)   2.050   6.8265  12.97978   7.3800   8.0360 521.233
##  f2(X)   4.428   8.6715  14.24545   9.4710  10.5165 402.251
##  f3(X) 101.106 105.4725 117.10051 108.4245 110.9050 530.950
##  f4(X) 134.357 139.2155 149.76808 141.2040 144.2175 769.898
##  neval
##    100
##    100
##    100
##    100</code></pre>
<p></p>
<p>The returned table contains the minimum, median, mean, max and first and third quartile times, as well as the number of repetitions.
The median value is to be compared.
The number of repetitions is by default 100, to be modulated (argument <code>times</code>) according to the complexity of the calculation.</p>
<p>The test result, a <code>microbenchmark</code> object, is a raw table of execution times.
The statistical analysis is done by the <code>print</code> and <code>summary</code> methods.
To choose the columns to display, use the following syntax:</p>
<p></p>
<div class="sourceCode" id="cb100"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">mb</span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"expr"</span>, <span class="st">"median"</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<pre><code>##    expr   median
## 1 f1(X)   7.3800
## 2 f2(X)   9.4710
## 3 f3(X) 108.4245
## 4 f4(X) 141.2040</code></pre>
<p></p>
<p>To make calculations on these results, we must store them in a variable.
To prevent the results from being displayed in the console, the simplest solution is to use the <code>capture.output</code> function by assigning its result to a variable.</p>
<p></p>
<div class="sourceCode" id="cb102"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dummy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/capture.output.html">capture.output</a></span><span class="op">(</span><span class="va">mbs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">mb</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p></p>
<p>The previous test is displayed again.</p>
<p></p>
<div class="sourceCode" id="cb103"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">mb</span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"expr"</span>, <span class="st">"median"</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<pre><code>##    expr   median
## 1 f1(X)   7.3800
## 2 f2(X)   9.4710
## 3 f3(X) 108.4245
## 4 f4(X) 141.2040</code></pre>
<p></p>
<p>The computation time is about the same between <span class="math inline">\(x \times x\)</span> and <span class="math inline">\(x^2\)</span>.
The power calculation is much longer, especially if the power is not integer, because it requires a logarithm calculation.
The computation of the power 2 is therefore optimized by R to avoid the use of log.</p>
<p>Two graphical representations are available: the violins represent the probability density of the execution time; the boxplots are classical.</p>
<p></p>
<div class="sourceCode" id="cb105"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://ggplot2.tidyverse.org">"ggplot2"</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">mb</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="WwR_files/figure-html/boxplot-1.png" width="80%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb106"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/boxplot.html">boxplot</a></span><span class="op">(</span><span class="va">mb</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="WwR_files/figure-html/boxplot-2.png" width="80%" style="display: block; margin: auto;"></div>
<p></p>
</div>
<div id="profiling" class="section level3" number="2.3.3">
<h3>
<span class="header-section-number">2.3.3</span> Profiling<a class="anchor" aria-label="anchor" href="#profiling"><i class="fas fa-link"></i></a>
</h3>
<p><strong>profvis</strong> is RStudio’s profiling tool.</p>
<p>It tracks the execution time of each line of code and the memory used.
The goal is to detect slow code portions that need to be improved.</p>
<p></p>
<div class="sourceCode" id="cb107"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://profvis.r-lib.org">profvis</a></span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://profvis.r-lib.org/reference/profvis.html">profvis</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="co"># Cosine calculations</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">cos</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">10</span><span class="op">^</span><span class="fl">7</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># 1/2 second pause</span></span>
<span>  <span class="fu"><a href="https://profvis.r-lib.org/reference/pause.html">pause</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="fu">htmlwidgets</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/htmlwidgets/man/saveWidget.html">saveWidget</a></span><span class="op">(</span><span class="va">p</span>, <span class="st">"docs/profile.html"</span><span class="op">)</span></span></code></pre></div>
<p></p>
<p>The result is an HTML file containing the profiling report<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://EricMarcon.github.io/WorkingWithR/profile.html" class="uri"&gt;https://EricMarcon.github.io/WorkingWithR/profile.html&lt;/a&gt;&lt;/p&gt;'><sup>24</sup></a>.
It can be observed that the time to draw the random numbers is similar to that of the cosine calculation.</p>
<p>Read the complete documentation<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://rstudio.github.io/profvis/" class="uri"&gt;https://rstudio.github.io/profvis/&lt;/a&gt;&lt;/p&gt;'><sup>25</sup></a> on the RStudio website.</p>
</div>
</div>
<div id="loops" class="section level2" number="2.4">
<h2>
<span class="header-section-number">2.4</span> Loops<a class="anchor" aria-label="anchor" href="#loops"><i class="fas fa-link"></i></a>
</h2>
<p>The most frequent case of long code to execute is loops: the same code is repeated a large number of times.</p>
<div id="vector-functions" class="section level3" number="2.4.1">
<h3>
<span class="header-section-number">2.4.1</span> Vector functions<a class="anchor" aria-label="anchor" href="#vector-functions"><i class="fas fa-link"></i></a>
</h3>
<p>Most of R’s functions are vector functions: loops are processed internally, extremely fast.
Therefore, you should think in terms of vectors rather than scalars.</p>
<p></p>
<div class="sourceCode" id="cb108"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Draw two vectors of three random numbers between 0 and 1</span></span>
<span><span class="va">x1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">x2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="co"># Square root of the three numbers in x1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">x1</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 0.9427738 0.8665204 0.4586981</code></pre>
<div class="sourceCode" id="cb110"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Respective sums of the three numbers of x1 and x2</span></span>
<span><span class="va">x1</span> <span class="op">+</span> <span class="va">x2</span></span></code></pre></div>
<pre><code>## [1] 1.6262539 1.6881583 0.9063973</code></pre>
<p></p>
<p>We also have to write vector functions on their first argument.
The function <code>lnq</code> of the package <strong>entropart</strong> returns the deformed logarithm of order <span class="math inline">\(q\)</span> of a number <span class="math inline">\(x\)</span>.</p>
<p></p>
<div class="sourceCode" id="cb112"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Code of the function</span></span>
<span><span class="fu">entropart</span><span class="fu">::</span><span class="va"><a href="https://ericmarcon.github.io/entropart/reference/lnq.html">lnq</a></span></span></code></pre></div>
<pre><code>## function (x, q) 
## {
##     if (q == 1) {
##         return(log(x))
##     }
##     else {
##         Log &lt;- (x^(1 - q) - 1)/(1 - q)
##         Log[x &lt; 0] &lt;- NA
##         return(Log)
##     }
## }
## &lt;bytecode: 0x12bfb99e0&gt;
## &lt;environment: namespace:entropart&gt;</code></pre>
<p></p>
<p>For a function to be vector, each line of its code must allow the first argument to be treated as a vector.
Here: <code>log(x)</code> and <code>x^</code> are a vector function and operator and the condition <code>[x &lt; 0]</code> also returns a vector.</p>
</div>
<div id="lapply" class="section level3" number="2.4.2">
<h3>
<span class="header-section-number">2.4.2</span> lapply<a class="anchor" aria-label="anchor" href="#lapply"><i class="fas fa-link"></i></a>
</h3>
<p>Code that cannot be written as a vector function requires loops.</p>
<p><code><a href="https://rdrr.io/r/base/lapply.html">lapply()</a></code> applies a function to each element of a list.
There are several versions of this function:</p>
<ul>
<li>
<code><a href="https://rdrr.io/r/base/lapply.html">lapply()</a></code> returns a list (and saves the time of rearranging them in an array).</li>
<li>
<code><a href="https://rdrr.io/r/base/lapply.html">sapply()</a></code> returns a dataframe by collapsing the lists (this is done by the <code><a href="https://rdrr.io/r/base/lapply.html">simplify2array()</a></code> function).</li>
<li>
<code><a href="https://rdrr.io/r/base/lapply.html">vapply()</a></code> is almost identical but requires that the data type of the result be provided.</li>
</ul>
<p></p>
<div class="sourceCode" id="cb114"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Draw 1000 values in a uniform distribution</span></span>
<span><span class="va">x1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span></span>
<span><span class="co"># The square root can be calculated for the vector or each value </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">x1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">x1</span>, FUN <span class="op">=</span> <span class="va">sqrt</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb116"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">x1</span><span class="op">)</span>, </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">x1</span>, FUN <span class="op">=</span> <span class="va">sqrt</span><span class="op">)</span>, </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">x1</span>, FUN <span class="op">=</span> <span class="va">sqrt</span><span class="op">)</span>, </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">vapply</a></span><span class="op">(</span><span class="va">x1</span>, FUN <span class="op">=</span> <span class="va">sqrt</span>, FUN.VALUE <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">mb</span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"expr"</span>, <span class="st">"median"</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<pre><code>##                                    expr   median
## 1                              sqrt(x1)   1.5580
## 2                lapply(x1, FUN = sqrt) 136.3865
## 3                sapply(x1, FUN = sqrt) 165.5170
## 4 vapply(x1, FUN = sqrt, FUN.VALUE = 0) 135.1565</code></pre>
<p></p>
<p><code><a href="https://rdrr.io/r/base/lapply.html">lapply()</a></code> is much slower than a vector function.
<code><a href="https://rdrr.io/r/base/lapply.html">sapply()</a></code> requires more time for <code><a href="https://rdrr.io/r/base/lapply.html">simplify2array()</a></code>, which must detect how to gather the results.
Finally, <code><a href="https://rdrr.io/r/base/lapply.html">vapply()</a></code> saves the time of determining the data type of the result and allows for faster computation with little effort.</p>
</div>
<div id="for-loops" class="section level3" number="2.4.3">
<h3>
<span class="header-section-number">2.4.3</span> For loops<a class="anchor" aria-label="anchor" href="#for-loops"><i class="fas fa-link"></i></a>
</h3>
<p>Loops are handled by the <code>for</code> function.
They have the reputation of being slow in R because the code inside the loop must be interpreted at each execution.
This is no longer the case since version 3.5 of R: loops are compiled systematically before execution.
The behavior of the just-in-time compiler is defined by the <code>enableJIT</code> function.
The default level is 3: all functions are compiled, and loops in the code are compiled too.</p>
<p>To evaluate the performance gain, the following code removes all automatic compilation, and compares the same loop compiled or not.</p>
<p></p>
<div class="sourceCode" id="cb118"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st">"compiler"</span><span class="op">)</span></span>
<span><span class="co"># No automatic compilation</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/compiler/compile.html">enableJIT</a></span><span class="op">(</span>level <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 3</code></pre>
<div class="sourceCode" id="cb120"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Loop to calculate the square root of a vector</span></span>
<span><span class="va">loop</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Initialization of the result vector, essential</span></span>
<span>  <span class="va">root</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span><span class="st">"numeric"</span>, length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># Loop</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="va">root</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">root</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># Compiled version</span></span>
<span><span class="va">loop2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/compiler/compile.html">cmpfun</a></span><span class="op">(</span><span class="va">loop</span><span class="op">)</span></span>
<span><span class="co"># Comparison</span></span>
<span><span class="va">mb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="fu">loop</span><span class="op">(</span><span class="va">x1</span><span class="op">)</span>, <span class="fu">loop2</span><span class="op">(</span><span class="va">x1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">mbs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">mb</span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"expr"</span>, <span class="st">"median"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code>##        expr   median
## 1  loop(x1) 363.8955
## 2 loop2(x1)  42.5375</code></pre>
<div class="sourceCode" id="cb122"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Automatic compilation by default since version 3.5</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/compiler/compile.html">enableJIT</a></span><span class="op">(</span>level <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 0</code></pre>
<p></p>
<p>The gain is considerable: from 1 to <code>9</code>.</p>
<p>For loops are now much faster than <code>vapply</code>.</p>
<p></p>
<div class="sourceCode" id="cb124"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Test</span></span>
<span><span class="va">mb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">vapply</a></span><span class="op">(</span><span class="va">x1</span>, FUN <span class="op">=</span> <span class="va">sqrt</span>, <span class="fl">0</span><span class="op">)</span>, <span class="fu">loop</span><span class="op">(</span><span class="va">x1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">mb</span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"expr"</span>, <span class="st">"median"</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<pre><code>##                        expr   median
## 1 vapply(x1, FUN = sqrt, 0) 134.9925
## 2                  loop(x1)  42.4350</code></pre>
<p></p>
<p>Be careful, the performance test can be misleading:</p>
<p></p>
<div class="sourceCode" id="cb126"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Preparing the result vector</span></span>
<span><span class="va">root</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span><span class="st">"numeric"</span>, length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Test</span></span>
<span><span class="va">mb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">vapply</a></span><span class="op">(</span><span class="va">x1</span>, FUN <span class="op">=</span> <span class="va">sqrt</span>, <span class="fl">0</span><span class="op">)</span>, </span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x1</span><span class="op">)</span><span class="op">)</span> <span class="va">root</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">x1</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">mb</span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"expr"</span>, <span class="st">"median"</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<pre><code>##                                             expr   median
## 1                      vapply(x1, FUN = sqrt, 0)  139.974
## 2 for (i in 1:length(x1)) root[i] &lt;- sqrt(x1[i]) 1257.860</code></pre>
<p></p>
<p>In this code, the for loop is not compiled so it is much slower than in its normal use (in a function or at the top level of the code).</p>
<p>The long loops allow tracking of their progress by a text bar, which is another advantage.
The following function executes pauses of one tenth of a second for the time passed in parameter (in seconds).</p>
<p></p>
<div class="sourceCode" id="cb128"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">loop_monitored</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">duration</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Progress bar</span></span>
<span>  <span class="va">pgb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/txtProgressBar.html">txtProgressBar</a></span><span class="op">(</span>min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="va">duration</span> <span class="op">*</span> <span class="fl">10</span><span class="op">)</span></span>
<span>  <span class="co"># Loop</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">duration</span> <span class="op">*</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Pause for a tenth of a second</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html">Sys.sleep</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="fl">10</span><span class="op">)</span></span>
<span>    <span class="co"># Track progress</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/txtProgressBar.html">setTxtProgressBar</a></span><span class="op">(</span><span class="va">pgb</span>, <span class="va">i</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">loop_monitored</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## ============================================================</code></pre>
<p></p>
</div>
<div id="replicate" class="section level3" number="2.4.4">
<h3>
<span class="header-section-number">2.4.4</span> replicate<a class="anchor" aria-label="anchor" href="#replicate"><i class="fas fa-link"></i></a>
</h3>
<p><code><a href="https://rdrr.io/r/base/lapply.html">replicate()</a></code> repeats a statement.</p>
<p></p>
<div class="sourceCode" id="cb130"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">replicate</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 0.9453453 0.5262818 0.7233425</code></pre>
<p></p>
<p>This code is equivalent to <code>runif(3)</code>, with performance similar to <code>vapply</code>: 50 to 100 times slower than a vector function.</p>
<p></p>
<div class="sourceCode" id="cb132"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">replicate</a></span><span class="op">(</span><span class="fl">1E3</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1E3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">mb</span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"expr"</span>, <span class="st">"median"</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<pre><code>##                        expr   median
## 1 replicate(1000, runif(1)) 784.8015
## 2               runif(1000)   6.8470</code></pre>
<p></p>
</div>
<div id="vectorize" class="section level3" number="2.4.5">
<h3>
<span class="header-section-number">2.4.5</span> Vectorize<a class="anchor" aria-label="anchor" href="#vectorize"><i class="fas fa-link"></i></a>
</h3>
<p><code><a href="https://rdrr.io/r/base/Vectorize.html">Vectorize()</a></code> makes a function that is not vectorized, by loops.
Write the loops instead.</p>
</div>
<div id="marginal-statistics" class="section level3" number="2.4.6">
<h3>
<span class="header-section-number">2.4.6</span> Marginal statistics<a class="anchor" aria-label="anchor" href="#marginal-statistics"><i class="fas fa-link"></i></a>
</h3>
<p><code>apply</code> applies a function to the rows or columns of a two dimensional object.</p>
<p><code>colSums</code> and similar functions (<code>rowSums</code>, <code>colMeans</code>, <code>rowMeans</code>) are optimized.</p>
<p></p>
<div class="sourceCode" id="cb134"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Sum of the numeric columns of the diamonds dataset of ggplot2</span></span>
<span><span class="co"># Loop identical to the action of apply(, 2, )</span></span>
<span><span class="va">loop_sum</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">table</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">the_sum</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span><span class="st">"numeric"</span>, length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">table</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">table</span><span class="op">)</span><span class="op">)</span> <span class="va">the_sum</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">table</span><span class="op">[</span>, <span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">the_sum</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">mb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span></span>
<span>  <span class="fu">loop_sum</span><span class="op">(</span><span class="va">diamonds</span><span class="op">[</span><span class="op">-</span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">diamonds</span><span class="op">[</span><span class="op">-</span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">]</span>, <span class="fl">2</span>, <span class="va">sum</span><span class="op">)</span>, </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colSums</a></span><span class="op">(</span><span class="va">diamonds</span><span class="op">[</span><span class="op">-</span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">mb</span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"expr"</span>, <span class="st">"median"</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<pre><code>##                              expr   median
## 1      loop_sum(diamonds[-(2:4)]) 1.901580
## 2 apply(diamonds[-(2:4)], 2, sum) 4.410514
## 3       colSums(diamonds[-(2:4)]) 1.358351</code></pre>
<p></p>
<p><code>apply</code> clarifies the code but is slower than the loop, which is only slightly slower than <code>colSums</code>.</p>
</div>
</div>
<div id="sec:cpp" class="section level2" number="2.5">
<h2>
<span class="header-section-number">2.5</span> C++ code<a class="anchor" aria-label="anchor" href="#sec:cpp"><i class="fas fa-link"></i></a>
</h2>
<p>Integrating C++ code into R is greatly simplified by the <strong>Rcpp</strong> package but is still difficult to debug and therefore should be reserved for very simple code (to avoid errors) repeated a large number of times (to be worth the effort).
The preparation and verification of the data must be done in R, as well as the processing and presentation of the results.</p>
<p>The common practice is to include C++ code in a package, but running it outside a package is possible:</p>
<ul>
<li>C++ code can be included in a C++ document (file with extension <code>.cpp</code>): it is compiled by the <code>sourceCpp()</code> command, which creates the R functions to call the C++ code.</li>
<li>In an RMarkdown document, Rcpp code snippets can be created to insert the C++ code: they are compiled and interfaced to R at the time of knitting.</li>
</ul>
<p>The following example shows how to create a C++ function to calculate the double of a numerical vector.</p>
<p></p>
<div class="sourceCode" id="cb136"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb136-1"><a href="chap-utiliseR.html#cb136-1" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb136-2"><a href="chap-utiliseR.html#cb136-2" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> Rcpp<span class="op">;</span></span>
<span id="cb136-3"><a href="chap-utiliseR.html#cb136-3" tabindex="-1"></a></span>
<span id="cb136-4"><a href="chap-utiliseR.html#cb136-4" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb136-5"><a href="chap-utiliseR.html#cb136-5" tabindex="-1"></a>NumericVector timesTwo<span class="op">(</span>NumericVector x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb136-6"><a href="chap-utiliseR.html#cb136-6" tabindex="-1"></a>  <span class="cf">return</span> x <span class="op">*</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb136-7"><a href="chap-utiliseR.html#cb136-7" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p></p>
<p>An R function with the same name as the C++ function is now available.</p>
<p></p>
<div class="sourceCode" id="cb137"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">timesTwo</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1]  2  4  6  8 10</code></pre>
<p></p>
<p>The performance is two orders of magnitude faster than the R code (see the case study, section <a href="chap-utiliseR.html#sec:cas">2.7</a>).</p>
</div>
<div id="parallelizing-r" class="section level2" number="2.6">
<h2>
<span class="header-section-number">2.6</span> Parallelizing R<a class="anchor" aria-label="anchor" href="#parallelizing-r"><i class="fas fa-link"></i></a>
</h2>
<p>When long computations can be split into independent tasks, the simultaneous (<em>parallel</em>) execution of these tasks reduces the total computation time to that of the longest task, to which is added the cost of setting up the parallelization (creation of the tasks, recovery of the results…).</p>
<p>Read Josh Errickson’s excellent introduction<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="http://dept.stat.lsa.umich.edu/~jerrick/courses/stat701/notes/parallel.html" class="uri"&gt;http://dept.stat.lsa.umich.edu/~jerrick/courses/stat701/notes/parallel.html&lt;/a&gt;&lt;/p&gt;'><sup>26</sup></a> which details the issues and constraints of parallelization.</p>
<p>Two mechanisms are available for parallel code execution:</p>
<ul>
<li>
<em>fork</em>: the running process is duplicated on multiple cores of the computing computer’s processor.
This is the simplest method but it does not work on Windows (it is a limitation of the operating system).</li>
<li>
<em>Socket</em>: a cluster is constituted, either physically (a set of computers running R is necessary) or logically (an instance of R on each core of the computer used).
The members of the cluster communicate through the network (the internal network of the computer is used in a logical cluster).</li>
</ul>
<p>Different R packages allow to implement these mechanisms.</p>
<div id="mclapply-fork" class="section level3" number="2.6.1">
<h3>
<span class="header-section-number">2.6.1</span> mclapply (fork)<a class="anchor" aria-label="anchor" href="#mclapply-fork"><i class="fas fa-link"></i></a>
</h3>
<p>The <code>mclapply</code> function of the <strong>parallel</strong> package has the same syntax as <code>lapply</code> but parallelizes the execution of loops.
On Windows, it has no effect since the system does not allow <em>fork</em>: it simply calls <code>lapply</code>.
However, a workaround exists to emulate <code>mclapply</code> on Windows by calling <code>parLapply</code>, which uses a cluster.</p>
<p></p>
<div class="sourceCode" id="cb139"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## mclapply.hack.R</span></span>
<span><span class="co">##</span></span>
<span><span class="co">## Nathan VanHoudnos</span></span>
<span><span class="co">## nathanvan AT northwestern FULL STOP edu</span></span>
<span><span class="co">## July 14, 2014</span></span>
<span><span class="co">##</span></span>
<span><span class="co">## A script to implement a hackish version of </span></span>
<span><span class="co">## parallel:mclapply() on Windows machines.</span></span>
<span><span class="co">## On Linux or Mac, the script has no effect</span></span>
<span><span class="co">## beyond loading the parallel library. </span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span>    </span>
<span></span>
<span><span class="co">## Define the hack</span></span>
<span><span class="co"># mc.cores argument added: Eric Marcon</span></span>
<span><span class="va">mclapply.hack</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span>, <span class="va">mc.cores</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co">## Create a cluster</span></span>
<span>  <span class="va">size.of.list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html">makeCluster</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">size.of.list</span>, <span class="va">mc.cores</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## Find out the names of the loaded packages </span></span>
<span>  <span class="va">loaded.package.names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="co">## Base packages</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html">sessionInfo</a></span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">basePkgs</span>,</span>
<span>    <span class="co">## Additional packages</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html">sessionInfo</a></span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">otherPkgs</span> <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/conditions.html">tryCatch</a></span><span class="op">(</span></span>
<span>    <span class="op">{</span></span>
<span>      <span class="co">## Copy over all of the objects within scope to</span></span>
<span>      <span class="co">## all clusters. </span></span>
<span>      <span class="va">this.env</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html">environment</a></span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="kw">while</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span><span class="op">(</span><span class="va">this.env</span>, <span class="fu"><a href="https://rdrr.io/r/base/environment.html">globalenv</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="cn">FALSE</span> <span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html">clusterExport</a></span><span class="op">(</span></span>
<span>          <span class="va">cl</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/ls.html">ls</a></span><span class="op">(</span>all.names <span class="op">=</span> <span class="cn">TRUE</span>, env <span class="op">=</span> <span class="va">this.env</span><span class="op">)</span>,</span>
<span>          envir <span class="op">=</span> <span class="va">this.env</span></span>
<span>        <span class="op">)</span></span>
<span>        <span class="va">this.env</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html">parent.env</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/environment.html">environment</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html">clusterExport</a></span><span class="op">(</span></span>
<span>        <span class="va">cl</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/ls.html">ls</a></span><span class="op">(</span>all.names <span class="op">=</span> <span class="cn">TRUE</span>, env <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html">globalenv</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        envir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html">globalenv</a></span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>      </span>
<span>      <span class="co">## Load the libraries on all the clusters</span></span>
<span>      <span class="co">## N.B. length(cl) returns the number of clusters</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html">parLapply</a></span><span class="op">(</span></span>
<span>        cl <span class="op">=</span> <span class="va">cl</span>, </span>
<span>        X <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span>, </span>
<span>        fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">xx</span><span class="op">)</span><span class="op">{</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span></span>
<span>            <span class="va">loaded.package.names</span>, </span>
<span>            FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">yy</span><span class="op">)</span> <span class="op">{</span></span>
<span>              <span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va">yy</span>, character.only <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>            <span class="op">}</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>      <span class="op">)</span></span>
<span>      </span>
<span>      <span class="co">## Run the lapply in parallel </span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html">parLapply</a></span><span class="op">(</span><span class="va">cl</span>, <span class="va">...</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span>, </span>
<span>    finally <span class="op">=</span> <span class="op">{</span>        </span>
<span>      <span class="co">## Stop the cluster</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">## Warn the user if they are using Windows</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.info.html">Sys.info</a></span><span class="op">(</span><span class="op">)</span><span class="op">[[</span><span class="st">'sysname'</span><span class="op">]</span><span class="op">]</span> <span class="op">==</span> <span class="st">'Windows'</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span></span>
<span>    <span class="st">"\n"</span>, </span>
<span>    <span class="st">"   *** Microsoft Windows detected ***\n"</span>,</span>
<span>    <span class="st">"   \n"</span>,</span>
<span>    <span class="st">"   For technical reasons, the MS Windows version of mclapply()\n"</span>,</span>
<span>    <span class="st">"   is implemented as a serial function instead of a parallel\n"</span>,</span>
<span>    <span class="st">"   function."</span>,</span>
<span>    <span class="st">"   \n\n"</span>,</span>
<span>    <span class="st">"   As a quick hack, we replace this serial version of mclapply()\n"</span>,</span>
<span>    <span class="st">"   with a wrapper to parLapply() for this R session. Please see\n\n"</span>,</span>
<span>    <span class="st">"     http://www.stat.cmu.edu/~nmv/2014/07/14/</span></span>
<span><span class="st">    implementing-mclapply-on-windows \n\n"</span>,</span>
<span>    <span class="st">"   for details.\n\n"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">## If the OS is Windows, set mclapply to the</span></span>
<span><span class="co">## the hackish version. Otherwise, leave the</span></span>
<span><span class="co">## definition alone. </span></span>
<span><span class="va">mclapply</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/switch.html">switch</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Sys.info.html">Sys.info</a></span><span class="op">(</span><span class="op">)</span><span class="op">[[</span><span class="st">'sysname'</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  Windows <span class="op">=</span> <span class="op">{</span><span class="va">mclapply.hack</span><span class="op">}</span>, </span>
<span>  Linux   <span class="op">=</span> <span class="op">{</span><span class="va">mclapply</span><span class="op">}</span>,</span>
<span>  Darwin  <span class="op">=</span> <span class="op">{</span><span class="va">mclapply</span><span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p></p>
<p>The following code tests the parallelization of a function that returns its argument unchanged after a quarter-second pause.
This is knitted with <code>3</code> cores, all of which are used except for one so as not to saturate the system.</p>
<p></p>
<div class="sourceCode" id="cb140"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">time</span> <span class="op">=</span> <span class="fl">.25</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html">Sys.sleep</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#Leave one core out for the system</span></span>
<span><span class="va">n_cores</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span></span>
<span></span>
<span><span class="co"># Serial : theoretical time = n_cores / 4 seconds</span></span>
<span><span class="op">(</span><span class="va">tserial</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n_cores</span>, <span class="va">f</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.007   0.000   0.734</code></pre>
<div class="sourceCode" id="cb142"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Parallel : theoretical time = 1/4 second</span></span>
<span><span class="op">(</span><span class="va">tparallel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html">mclapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n_cores</span>, <span class="va">f</span>, mc.cores <span class="op">=</span> <span class="va">n_cores</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.003   0.031   0.283</code></pre>
<p></p>
<p>Setting up parallelization has a cost of about <code>0.033</code> seconds here.
The execution time is much longer in parallel on Windows because setting up the cluster takes much more time than parallelization saves.
Parallelization is interesting for longer tasks, such as a one second break.</p>
<p></p>
<div class="sourceCode" id="cb144"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Serial</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n_cores</span>, <span class="va">f</span>, time <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.000   0.000   2.093</code></pre>
<div class="sourceCode" id="cb146"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Parallel</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html">mclapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n_cores</span>, <span class="va">f</span>, time <span class="op">=</span> <span class="fl">1</span>, mc.cores <span class="op">=</span> <span class="va">n_cores</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.002   0.021   1.151</code></pre>
<p></p>
<p>The additional time required for parallel execution of the new code is relatively smaller: the costs become less than the savings when the time of each task increases.</p>
<p>If the number of parallel tasks exceeds the number of cores used, performance collapses because the additional task must be executed after the first ones.</p>
<p></p>
<div class="sourceCode" id="cb148"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html">mclapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n_cores</span>, <span class="va">f</span>, time <span class="op">=</span> <span class="fl">1</span>, mc.cores <span class="op">=</span> <span class="va">n_cores</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.001   0.017   1.127</code></pre>
<div class="sourceCode" id="cb150"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html">mclapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">n_cores</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span>, <span class="va">f</span>, time <span class="op">=</span> <span class="fl">1</span>, mc.cores <span class="op">=</span> <span class="va">n_cores</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.003   0.018   2.075</code></pre>
<p></p>
<p>The time then remains stable until the number of cores is doubled.
Figure <a href="chap-utiliseR.html#fig:r-parallele">2.2</a> shows the evolution of the computation time according to the number of tasks.</p>

<p></p>
<div class="sourceCode" id="cb152"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tasks</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">n_cores</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span></span>
<span>  <span class="va">tasks</span>, </span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">n_tasks</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html">mclapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n_tasks</span>, <span class="va">f</span>, time <span class="op">=</span> <span class="fl">1</span>, mc.cores <span class="op">=</span> <span class="va">n_cores</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://tidyverse.tidyverse.org">"tidyverse"</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span><span class="va">tasks</span>, time <span class="op">=</span> <span class="va">time</span><span class="op">[</span><span class="st">"elapsed"</span>, <span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">ggplot</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">tasks</span>, y <span class="op">=</span> <span class="va">time</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span> <span class="op">*</span> <span class="va">n_cores</span>, col <span class="op">=</span> <span class="st">"red"</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:r-parallele"></span>
<img src="WwR_files/figure-html/r-parallele-1.png" alt="Parallel execution time of tasks requiring one second (each task is a one second pause). The number of tasks varies from 1 to twice the number of cores used (equal to 2) plus one." width="80%"><p class="caption">
Figure 2.2: Parallel execution time of tasks requiring one second (each task is a one second pause). The number of tasks varies from 1 to twice the number of cores used (equal to <code>2</code>) plus one.
</p>
</div>
<p></p>
<p>The theoretical shape of this curve is as follows:</p>
<ul>
<li>For a task, the time is equal to one second plus the parallelization setup time.</li>
<li>The time should remain stable until the number of cores used.</li>
<li>When all the cores are used (red dotted line), the time should increase by one second and then remain stable until the next limit.</li>
</ul>
<p>In practice, the computation time is determined by other factors that are difficult to predict.
The best practice is to adapt the number of tasks to the number of cores, otherwise performance will be lost.</p>
</div>
<div id="parlapply-socket" class="section level3" number="2.6.2">
<h3>
<span class="header-section-number">2.6.2</span> parLapply (socket)<a class="anchor" aria-label="anchor" href="#parlapply-socket"><i class="fas fa-link"></i></a>
</h3>
<p><code>parLapply</code> requires to create a cluster, export the useful variables on each node, load the necessary packages on each node, execute the code and finally stop the cluster.
The code for each step can be found in the <code>mclapply.hack</code> function above.</p>
<p>For everyday use, <code>mclapply</code> is faster, except on Windows, and simpler (including on Windows thanks to the above workaround).</p>
</div>
<div id="foreach" class="section level3" number="2.6.3">
<h3>
<span class="header-section-number">2.6.3</span> foreach<a class="anchor" aria-label="anchor" href="#foreach"><i class="fas fa-link"></i></a>
</h3>
<div id="how-it-works" class="section level4" number="2.6.3.1">
<h4>
<span class="header-section-number">2.6.3.1</span> How it works<a class="anchor" aria-label="anchor" href="#how-it-works"><i class="fas fa-link"></i></a>
</h4>
<p>The <strong>foreach</strong> package allows advanced use of parallelization.
Read its vignettes.</p>
<p></p>
<div class="sourceCode" id="cb153"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Manual</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/vignette.html">vignette</a></span><span class="op">(</span><span class="st">"foreach"</span>, <span class="st">"foreach"</span><span class="op">)</span></span>
<span><span class="co"># Nested loops</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/vignette.html">vignette</a></span><span class="op">(</span><span class="st">"nested"</span>, <span class="st">"foreach"</span><span class="op">)</span></span></code></pre></div>
<p></p>
<p>Regardless of parallelization, <strong>foreach</strong> redefines <em>for</em> loops.</p>
<p></p>
<div class="sourceCode" id="cb154"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">f</span><span class="op">(</span><span class="va">i</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># becomes</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/RevolutionAnalytics/foreach">"foreach"</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">foreach</a></span><span class="op">(</span>i <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">%do%</a></span> <span class="op">{</span></span>
<span>  <span class="fu">f</span><span class="op">(</span><span class="va">i</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code>## [[1]]
## [1] 1
## 
## [[2]]
## [1] 2
## 
## [[3]]
## [1] 3</code></pre>
<p></p>
<p>The <code>foreach</code> function returns a list containing the results of each loop.
The elements of the list can be combined by any function, such as <code>c</code>.</p>
<p></p>
<div class="sourceCode" id="cb156"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">foreach</a></span><span class="op">(</span>i <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, .combine <span class="op">=</span> <span class="st">"c"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">%do%</a></span> <span class="op">{</span></span>
<span>  <span class="fu">f</span><span class="op">(</span><span class="va">i</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code>## [1] 1 2 3</code></pre>
<p></p>
<p>The <code>foreach</code> function is capable of using iterators, that is, functions that pass to the loop only the data it needs without loading the rest into memory.
Here, the <code>icount</code> iterator passes the values 1, 2 and 3 individually, without loading the 1:3 vector into memory.</p>
<p></p>
<div class="sourceCode" id="cb158"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/RevolutionAnalytics/iterators">"iterators"</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">foreach</a></span><span class="op">(</span>i <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/iterators/man/icount.html">icount</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>, .combine <span class="op">=</span> <span class="st">"c"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">%do%</a></span> <span class="op">{</span></span>
<span>  <span class="fu">f</span><span class="op">(</span><span class="va">i</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code>## [1] 1 2 3</code></pre>
<p></p>
<p>It is therefore very useful when each object of the loop uses a large amount of memory.</p>
</div>
<div id="parallelization" class="section level4" number="2.6.3.2">
<h4>
<span class="header-section-number">2.6.3.2</span> Parallelization<a class="anchor" aria-label="anchor" href="#parallelization"><i class="fas fa-link"></i></a>
</h4>
<p>Replacing the <code>%do%</code> operator with <code>%dopar%</code> parallelizes loops, provided that an adapter, i.e. an intermediate package between <code>foreach</code> and a package implementing parallelization, is loaded.
<strong>doParallel</strong> is an adapter for using the <strong>parallel</strong> package that comes with R.</p>
<p></p>
<div class="sourceCode" id="cb160"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RevolutionAnalytics/doparallel">doParallel</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html">registerDoParallel</a></span><span class="op">(</span>cores <span class="op">=</span> <span class="va">n_cores</span><span class="op">)</span></span>
<span><span class="co"># Serial</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">foreach</a></span><span class="op">(</span>i <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/iterators/man/icount.html">icount</a></span><span class="op">(</span><span class="va">n_cores</span><span class="op">)</span>, .combine <span class="op">=</span> <span class="st">"c"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">%do%</a></span> <span class="op">{</span><span class="fu">f</span><span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.002   0.001   0.723</code></pre>
<div class="sourceCode" id="cb162"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Parallel</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">foreach</a></span><span class="op">(</span>i <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/iterators/man/icount.html">icount</a></span><span class="op">(</span><span class="va">n_cores</span><span class="op">)</span>, .combine <span class="op">=</span> <span class="st">"c"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">%dopar%</a></span> <span class="op">{</span><span class="fu">f</span><span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.005   0.021   0.400</code></pre>
<p></p>
<p>The fixed cost of parallelization is low.</p>
</div>
</div>
<div id="future" class="section level3" number="2.6.4">
<h3>
<span class="header-section-number">2.6.4</span> future<a class="anchor" aria-label="anchor" href="#future"><i class="fas fa-link"></i></a>
</h3>
<p>The <strong>future</strong> package is used to abstract the code of the parallelization implementation.
It is at the centre of an ecosystem of packages that facilitate its use<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://www.futureverse.org/" class="uri"&gt;https://www.futureverse.org/&lt;/a&gt;&lt;/p&gt;'><sup>27</sup></a>.</p>
<p>The parallelization strategy used is declared by the <code><a href="https://future.futureverse.org/reference/plan.html">plan()</a></code> function.
The default strategy is <code>sequential</code>, i.e. single-task.
The <code>multicore</code> and <code>multisession</code> strategies are based respectively on the <em>fork</em> and <em>socket</em> techniques seen above.
Other strategies are available for using physical clusters (several computers prepared to run R together): the <strong>future</strong> documentation details how to do this.</p>
<p>Here we will use the <code>multisession</code> strategy, which works on the local computer, whatever its operating system.</p>
<p></p>
<div class="sourceCode" id="cb164"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://future.futureverse.org">"future"</a></span><span class="op">)</span></span>
<span><span class="co"># Socket strategy on all available cores except 1</span></span>
<span><span class="va">usedCores</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://parallelly.futureverse.org/reference/availableCores.html">availableCores</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html">plan</a></span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="va">usedCores</span><span class="op">)</span></span></code></pre></div>
<p></p>
<p>The <strong>future.apply</strong> package allows all <code>*apply()</code> and <code><a href="https://rdrr.io/r/base/lapply.html">replicate()</a></code> loops to be effortlessly parallelized by prefixing their names with <code>future_</code>.</p>
<p></p>
<div class="sourceCode" id="cb165"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://future.apply.futureverse.org">"future.apply"</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="fu"><a href="https://future.apply.futureverse.org/reference/future_lapply.html">future_replicate</a></span><span class="op">(</span><span class="va">usedCores</span> <span class="op">-</span> <span class="fl">1</span>, <span class="fu">f</span><span class="op">(</span><span class="va">usedCores</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.020   0.001   0.360</code></pre>
<p></p>
<p>foreach loops can be parallelized with the <strong>doFuture</strong> package by simply replacing <code>%dopar%</code> with <code>%dofuture%</code>.</p>
<p></p>
<div class="sourceCode" id="cb167"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://doFuture.futureverse.org">"doFuture"</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">foreach</a></span><span class="op">(</span>i <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/iterators/man/icount.html">icount</a></span><span class="op">(</span><span class="va">n_cores</span><span class="op">)</span>, .combine <span class="op">=</span> <span class="st">"c"</span><span class="op">)</span> <span class="op"><a href="https://doFuture.futureverse.org/reference/grapes-dofuture-grapes.html">%dofuture%</a></span> <span class="op">{</span><span class="fu">f</span><span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.034   0.001   0.453</code></pre>
<p></p>
<p>The strategy is reset to <code>sequential</code> at the end.</p>
<p></p>
<div class="sourceCode" id="cb169"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html">plan</a></span><span class="op">(</span><span class="va">sequential</span><span class="op">)</span></span></code></pre></div>
<p></p>
</div>
</div>
<div id="sec:cas" class="section level2" number="2.7">
<h2>
<span class="header-section-number">2.7</span> Case study<a class="anchor" aria-label="anchor" href="#sec:cas"><i class="fas fa-link"></i></a>
</h2>
<p>This case study tests the different techniques seen above to solve a concrete problem.
The objective is to compute the average distance between two points of a random set of 1000 points in a square window of side 1.</p>
<p>Its expectation is computable<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://mindyourdecisions.com/blog/2016/07/03/distance-between-two-random-points-in-a-square-sunday-puzzle/" class="uri"&gt;https://mindyourdecisions.com/blog/2016/07/03/distance-between-two-random-points-in-a-square-sunday-puzzle/&lt;/a&gt;&lt;/p&gt;'><sup>28</sup></a>.
It is equal to <span class="math inline">\(\frac{2+\sqrt{2}+5\ln{(1+\sqrt{2})}}{15} \approx 0.5214\)</span>.</p>
<div id="creation-of-the-data" class="section level3" number="2.7.1">
<h3>
<span class="header-section-number">2.7.1</span> Creation of the data<a class="anchor" aria-label="anchor" href="#creation-of-the-data"><i class="fas fa-link"></i></a>
</h3>
<p>The point set is created with the <strong>spatstat</strong> package.</p>
<p></p>
<div class="sourceCode" id="cb170"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_points</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="http://spatstat.org/">"spatstat"</a></span><span class="op">)</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spatstat.random/man/runifpoint.html">runifpoint</a></span><span class="op">(</span><span class="va">n_points</span><span class="op">)</span></span></code></pre></div>
<p></p>
</div>
<div id="spatstat" class="section level3" number="2.7.2">
<h3>
<span class="header-section-number">2.7.2</span> Spatstat<a class="anchor" aria-label="anchor" href="#spatstat"><i class="fas fa-link"></i></a>
</h3>
<p>The <code><a href="https://rdrr.io/pkg/spatstat.geom/man/pairdist.html">pairdist()</a></code> function of <strong>spatstat</strong> returns the matrix of distances between points.
The average distance is calculated by dividing the sum by the number of pairs of distinct points.</p>
<p></p>
<div class="sourceCode" id="cb171"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/spatstat.geom/man/pairdist.html">pairdist</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="va">n_points</span> <span class="op">/</span> <span class="op">(</span><span class="va">n_points</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">mb</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="WwR_files/figure-html/pairdist-1.png" width="80%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb172"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span></span></code></pre></div>
<pre><code>## [1] 0.5154879</code></pre>
<p></p>
<p>The function is fast because it is coded in C in the <strong>spatstat</strong> package for the core of its calculations.</p>
</div>
<div id="apply" class="section level3" number="2.7.3">
<h3>
<span class="header-section-number">2.7.3</span> apply<a class="anchor" aria-label="anchor" href="#apply"><i class="fas fa-link"></i></a>
</h3>
<p>The distance can be calculated by two nested <code><a href="https://rdrr.io/r/base/lapply.html">sapply()</a></code>.</p>
<p></p>
<div class="sourceCode" id="cb174"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fsapply1</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">distances</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span></span>
<span>    <span class="fl">1</span><span class="op">:</span><span class="va">n_points</span>, </span>
<span>    FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span></span>
<span>        <span class="fl">1</span><span class="op">:</span><span class="va">n_points</span>, </span>
<span>        FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">j</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="op">(</span><span class="va">X</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">X</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="op">(</span><span class="va">X</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">X</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span> </span>
<span>  <span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">distances</span><span class="op">)</span> <span class="op">/</span> <span class="va">n_points</span> <span class="op">/</span> <span class="op">(</span><span class="va">n_points</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu">fsapply1</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>##    user  system elapsed 
##   3.137   0.046   3.297</code></pre>
<div class="sourceCode" id="cb176"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span></span></code></pre></div>
<pre><code>## [1] 0.5154879</code></pre>
<p></p>
<p>Some time can be saved by replacing <code>sapply</code> with <code>vapply</code>: the format of the results does not have to be determined by the function.
The gain is negligible on a long computation like this one but important for short computations.</p>
<p></p>
<div class="sourceCode" id="cb178"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fsapply2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">distances</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">vapply</a></span><span class="op">(</span></span>
<span>    <span class="fl">1</span><span class="op">:</span><span class="va">n_points</span>, </span>
<span>    FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">vapply</a></span><span class="op">(</span></span>
<span>        <span class="fl">1</span><span class="op">:</span><span class="va">n_points</span>, </span>
<span>        FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">j</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="op">(</span><span class="va">X</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">X</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="op">(</span><span class="va">X</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">X</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span>        <span class="op">}</span>, </span>
<span>        FUN.VALUE <span class="op">=</span> <span class="fl">0</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span>, </span>
<span>    FUN.VALUE <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">1000</span> <span class="op">+</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">distances</span><span class="op">)</span> <span class="op">/</span> <span class="va">n_points</span> <span class="op">/</span> <span class="op">(</span><span class="va">n_points</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu">fsapply2</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>##    user  system elapsed 
##   2.873   0.023   2.903</code></pre>
<div class="sourceCode" id="cb180"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span></span></code></pre></div>
<pre><code>## [1] 0.5154879</code></pre>
<p></p>
<p>The output format is not always obvious to write:</p>
<ul>
<li>it must respect the size of the data: a vector of size 1000 for the outer loop, a scalar for the inner loop.</li>
<li>it must respect the type: <code>0L</code> for an integer, <code>0</code> for a real number. In the outer loop, adding <code>0</code> to the vector of integers turns it into a vector of real numbers.</li>
</ul>
<p>A more significant improvement is to compute the square roots only at the end of the loop, to take advantage of the vectorization of the function.</p>
<p></p>
<div class="sourceCode" id="cb182"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fsapply3</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">distances</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">vapply</a></span><span class="op">(</span></span>
<span>    <span class="fl">1</span><span class="op">:</span><span class="va">n_points</span>, </span>
<span>    FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">vapply</a></span><span class="op">(</span></span>
<span>        <span class="fl">1</span><span class="op">:</span><span class="va">n_points</span>, </span>
<span>        FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">j</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="op">(</span><span class="va">X</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">X</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="op">(</span><span class="va">X</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">X</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span></span>
<span>        <span class="op">}</span>, </span>
<span>        FUN.VALUE <span class="op">=</span> <span class="fl">0</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span>, </span>
<span>    FUN.VALUE <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">1000</span> <span class="op">+</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">distances</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="va">n_points</span> <span class="op">/</span> <span class="op">(</span><span class="va">n_points</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu">fsapply3</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>##    user  system elapsed 
##   2.931   0.026   2.969</code></pre>
<div class="sourceCode" id="cb184"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span></span></code></pre></div>
<pre><code>## [1] 0.5154879</code></pre>
<p></p>
<p>The computations are performed twice (distance between points <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span>, but also between points <span class="math inline">\(j\)</span> and <span class="math inline">\(i\)</span>): a test on the indices allows to divide the time almost by 2 (not quite because the loops without computation, which return <span class="math inline">\(0\)</span>, take time).</p>
<p></p>
<div class="sourceCode" id="cb186"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fsapply4</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">distances</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">vapply</a></span><span class="op">(</span></span>
<span>    <span class="fl">1</span><span class="op">:</span><span class="va">n_points</span>, </span>
<span>    FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">vapply</a></span><span class="op">(</span></span>
<span>        <span class="fl">1</span><span class="op">:</span><span class="va">n_points</span>, </span>
<span>        FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">j</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="kw">if</span> <span class="op">(</span><span class="va">j</span> <span class="op">&gt;</span> <span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="op">(</span><span class="va">X</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">X</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="op">(</span><span class="va">X</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">X</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span></span>
<span>          <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>            <span class="fl">0</span></span>
<span>          <span class="op">}</span></span>
<span>        <span class="op">}</span>, </span>
<span>        FUN.VALUE <span class="op">=</span> <span class="fl">0</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span>, </span>
<span>    FUN.VALUE <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">1000</span> <span class="op">+</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">distances</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="va">n_points</span> <span class="op">/</span> <span class="op">(</span><span class="va">n_points</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu">fsapply4</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>##    user  system elapsed 
##   1.884   0.019   1.904</code></pre>
<div class="sourceCode" id="cb188"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span></span></code></pre></div>
<pre><code>## [1] 0.5154879</code></pre>
<p></p>
<p>In parallel, the computation time is not improved on Windows because the individual tasks are too short.
On MacOS or Linux, the computation is accelerated.</p>
<p></p>
<div class="sourceCode" id="cb190"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fsapply5</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">distances</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html">mclapply</a></span><span class="op">(</span></span>
<span>    <span class="fl">1</span><span class="op">:</span><span class="va">n_points</span>, </span>
<span>    <span class="co"># Avoid naming the argument because it is named FUN in mclapply()</span></span>
<span>    <span class="co"># but fun in parLapply() used by  mclapply.hack()</span></span>
<span>    <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">vapply</a></span><span class="op">(</span></span>
<span>        <span class="fl">1</span><span class="op">:</span><span class="va">n_points</span>, </span>
<span>        FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">j</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="kw">if</span> <span class="op">(</span><span class="va">j</span> <span class="op">&gt;</span> <span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="op">(</span><span class="va">X</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">X</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="op">(</span><span class="va">X</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">X</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span></span>
<span>          <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>            <span class="fl">0</span></span>
<span>          <span class="op">}</span></span>
<span>        <span class="op">}</span>,</span>
<span>        FUN.VALUE <span class="op">=</span> <span class="fl">0</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">simplify2array</a></span><span class="op">(</span><span class="va">distances</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="va">n_points</span> <span class="op">/</span> <span class="op">(</span><span class="va">n_points</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu">fsapply5</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>##    user  system elapsed 
##   1.701   0.331   1.218</code></pre>
<div class="sourceCode" id="cb192"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span></span></code></pre></div>
<pre><code>## [1] 0.5154879</code></pre>
<p></p>
</div>
<div id="future.apply" class="section level3" number="2.7.4">
<h3>
<span class="header-section-number">2.7.4</span> future.apply<a class="anchor" aria-label="anchor" href="#future.apply"><i class="fas fa-link"></i></a>
</h3>
<p>The <code>fsapply4()</code> function optimised above can be parallelled directly by prefixing the <code>vapply</code> function with <code>future_</code>.
Only the main loop is parallelized: nesting <code><a href="https://future.apply.futureverse.org/reference/future_lapply.html">future_vapply()</a></code> would collapse performance.</p>
<p></p>
<div class="sourceCode" id="cb194"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://future.apply.futureverse.org">"future.apply"</a></span><span class="op">)</span></span>
<span><span class="co"># Socket strategy on all available cores except 1</span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html">plan</a></span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="fu"><a href="https://parallelly.futureverse.org/reference/availableCores.html">availableCores</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">future_fsapply4_</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">distances</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://future.apply.futureverse.org/reference/future_lapply.html">future_vapply</a></span><span class="op">(</span></span>
<span>    <span class="fl">1</span><span class="op">:</span><span class="va">n_points</span>, </span>
<span>    FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">vapply</a></span><span class="op">(</span></span>
<span>        <span class="fl">1</span><span class="op">:</span><span class="va">n_points</span>, </span>
<span>        FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">j</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="kw">if</span> <span class="op">(</span><span class="va">j</span> <span class="op">&gt;</span> <span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="op">(</span><span class="va">X</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">X</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="op">(</span><span class="va">X</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">X</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span></span>
<span>          <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>            <span class="fl">0</span></span>
<span>          <span class="op">}</span></span>
<span>        <span class="op">}</span>, </span>
<span>        FUN.VALUE <span class="op">=</span> <span class="fl">0</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span>, </span>
<span>    FUN.VALUE <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">1000</span> <span class="op">+</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">distances</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="va">n_points</span> <span class="op">/</span> <span class="op">(</span><span class="va">n_points</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu">future_fsapply4_</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.079   0.012   1.371</code></pre>
<div class="sourceCode" id="cb196"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span></span></code></pre></div>
<pre><code>## [1] 0.5154879</code></pre>
<div class="sourceCode" id="cb198"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html">plan</a></span><span class="op">(</span><span class="va">sequential</span><span class="op">)</span></span></code></pre></div>
<p></p>
</div>
<div id="for-loop" class="section level3" number="2.7.5">
<h3>
<span class="header-section-number">2.7.5</span> for loop<a class="anchor" aria-label="anchor" href="#for-loop"><i class="fas fa-link"></i></a>
</h3>
<p>A for loop is faster and consumes less memory because it does not store the distance matrix.</p>
<p></p>
<div class="sourceCode" id="cb199"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">distance</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">ffor</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">n_points</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="op">(</span><span class="va">i</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="va">n_points</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">distance</span> <span class="op">&lt;-</span> <span class="va">distance</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="op">(</span><span class="va">X</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">X</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="op">(</span><span class="va">X</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">X</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">distance</span> <span class="op">/</span> <span class="va">n_points</span> <span class="op">/</span> <span class="op">(</span><span class="va">n_points</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># Calculation time, stored</span></span>
<span><span class="op">(</span><span class="va">for_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu">ffor</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.967   0.011   1.097</code></pre>
<div class="sourceCode" id="cb201"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span></span></code></pre></div>
<pre><code>## [1] 0.5154879</code></pre>
<p></p>
<p>This is the simplest and most efficient way to write this code with core R and no parallelization.</p>
</div>
<div id="foreach-loop" class="section level3" number="2.7.6">
<h3>
<span class="header-section-number">2.7.6</span> foreach loop<a class="anchor" aria-label="anchor" href="#foreach-loop"><i class="fas fa-link"></i></a>
</h3>
<p>Parallelization executes for loops inside a foreach loop, which is quite efficient.
However, distances are calculated twice.</p>
<p></p>
<div class="sourceCode" id="cb203"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html">registerDoParallel</a></span><span class="op">(</span>cores <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">fforeach3</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">Y</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">distances</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">foreach</a></span><span class="op">(</span>i <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/iterators/man/icount.html">icount</a></span><span class="op">(</span><span class="va">Y</span><span class="op">$</span><span class="va">n</span><span class="op">)</span>, .combine <span class="op">=</span> <span class="st">'+'</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">%dopar%</a></span> <span class="op">{</span></span>
<span>    <span class="va">distance</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">Y</span><span class="op">$</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">distance</span> <span class="op">&lt;-</span> <span class="va">distance</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="op">(</span><span class="va">Y</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">Y</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="op">(</span><span class="va">Y</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">Y</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">distance</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">distances</span> <span class="op">/</span> <span class="va">Y</span><span class="op">$</span><span class="va">n</span> <span class="op">/</span> <span class="op">(</span><span class="va">Y</span><span class="op">$</span><span class="va">n</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu">fforeach3</span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>##    user  system elapsed 
##   3.312   0.741   2.267</code></pre>
<div class="sourceCode" id="cb205"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span></span></code></pre></div>
<pre><code>## [1] 0.5154879</code></pre>
<p></p>
<p>It is possible to nest two foreach loops, but they are extremely slow compared with a simple loop.
The test is run here with 10 times fewer points, so 100 times fewer distances to calculate.</p>
<p></p>
<div class="sourceCode" id="cb207"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_points_reduced</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spatstat.random/man/runifpoint.html">runifpoint</a></span><span class="op">(</span><span class="va">n_points_reduced</span><span class="op">)</span></span>
<span><span class="va">fforeach1</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">Y</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">distances</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">foreach</a></span><span class="op">(</span>i <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_points_reduced</span>, .combine <span class="op">=</span> <span class="st">'cbind'</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">%:%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">foreach</a></span><span class="op">(</span>j <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_points_reduced</span>, .combine <span class="op">=</span> <span class="st">'c'</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">%do%</a></span> <span class="op">{</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="va">j</span> <span class="op">&gt;</span> <span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="op">(</span><span class="va">Y</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">Y</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="op">(</span><span class="va">Y</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">Y</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>        <span class="fl">0</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">distances</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="va">n_points_reduced</span> <span class="op">/</span> <span class="op">(</span><span class="va">n_points_reduced</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu">fforeach1</span><span class="op">(</span><span class="va">Y</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>##    user  system elapsed 
##   1.145   0.019   1.191</code></pre>
<div class="sourceCode" id="cb209"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span></span></code></pre></div>
<pre><code>## [1] 0.5304197</code></pre>
<p></p>
<p>Nested foreach loops should be reserved for very long tasks (several seconds at least) to compensate the fixed costs of setting them up.</p>
</div>
<div id="rcpp" class="section level3" number="2.7.7">
<h3>
<span class="header-section-number">2.7.7</span> RCpp<a class="anchor" aria-label="anchor" href="#rcpp"><i class="fas fa-link"></i></a>
</h3>
<p>The C++ function to calculate distances is the following.</p>
<p></p>
<div class="sourceCode" id="cb211"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb211-1"><a href="chap-utiliseR.html#cb211-1" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb211-2"><a href="chap-utiliseR.html#cb211-2" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> Rcpp<span class="op">;</span></span>
<span id="cb211-3"><a href="chap-utiliseR.html#cb211-3" tabindex="-1"></a></span>
<span id="cb211-4"><a href="chap-utiliseR.html#cb211-4" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb211-5"><a href="chap-utiliseR.html#cb211-5" tabindex="-1"></a><span class="dt">double</span> MeanDistance<span class="op">(</span>NumericVector x<span class="op">,</span> NumericVector y<span class="op">)</span> <span class="op">{</span></span>
<span id="cb211-6"><a href="chap-utiliseR.html#cb211-6" tabindex="-1"></a>  <span class="dt">double</span> distance <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb211-7"><a href="chap-utiliseR.html#cb211-7" tabindex="-1"></a>  <span class="dt">double</span> dx<span class="op">,</span> dy<span class="op">;</span></span>
<span id="cb211-8"><a href="chap-utiliseR.html#cb211-8" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="op">(</span>x<span class="op">.</span>length<span class="op">()</span> <span class="op">-</span> <span class="dv">1</span><span class="op">);</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb211-9"><a href="chap-utiliseR.html#cb211-9" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> i <span class="op">+</span> <span class="dv">1</span><span class="op">;</span> j <span class="op">&lt;</span> x<span class="op">.</span>length<span class="op">();</span> j<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb211-10"><a href="chap-utiliseR.html#cb211-10" tabindex="-1"></a>    <span class="co">// Calculate distance</span></span>
<span id="cb211-11"><a href="chap-utiliseR.html#cb211-11" tabindex="-1"></a>        dx <span class="op">=</span> x<span class="op">[</span>i<span class="op">]</span> <span class="op">-</span> x<span class="op">[</span>j<span class="op">];</span></span>
<span id="cb211-12"><a href="chap-utiliseR.html#cb211-12" tabindex="-1"></a>        dy <span class="op">=</span> y<span class="op">[</span>i<span class="op">]</span> <span class="op">-</span> y<span class="op">[</span>j<span class="op">];</span></span>
<span id="cb211-13"><a href="chap-utiliseR.html#cb211-13" tabindex="-1"></a>        distance <span class="op">+=</span> sqrt<span class="op">(</span>dx <span class="op">*</span> dx <span class="op">+</span> dy <span class="op">*</span> dy<span class="op">);</span></span>
<span id="cb211-14"><a href="chap-utiliseR.html#cb211-14" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb211-15"><a href="chap-utiliseR.html#cb211-15" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb211-16"><a href="chap-utiliseR.html#cb211-16" tabindex="-1"></a>  <span class="cf">return</span> distance <span class="op">/</span> <span class="op">(</span><span class="dt">double</span><span class="op">)(</span>x<span class="op">.</span>length<span class="op">()</span> <span class="op">/</span> <span class="dv">2</span> <span class="op">*</span> <span class="op">(</span>x<span class="op">.</span>length<span class="op">()</span> <span class="op">-</span> <span class="dv">1</span><span class="op">));</span></span>
<span id="cb211-17"><a href="chap-utiliseR.html#cb211-17" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p></p>
<p>It is called in R very simply.
The computation time is very short.</p>
<p></p>
<div class="sourceCode" id="cb212"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu">MeanDistance</span><span class="op">(</span><span class="va">X</span><span class="op">$</span><span class="va">x</span>, <span class="va">X</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">mb</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="WwR_files/figure-html/RCpp-1.png" width="80%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb213"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span></span></code></pre></div>
<pre><code>## [1] 0.5154879</code></pre>
<p></p>
</div>
<div id="rcppparallel" class="section level3" number="2.7.8">
<h3>
<span class="header-section-number">2.7.8</span> RcppParallel<a class="anchor" aria-label="anchor" href="#rcppparallel"><i class="fas fa-link"></i></a>
</h3>
<p><strong>RcppParallel</strong> allows to interface parallelized C++ code, at the cost of a more complex syntax than <strong>RCpp</strong>.
Documentation is available<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="http://rcppcore.github.io/RcppParallel/" class="uri"&gt;http://rcppcore.github.io/RcppParallel/&lt;/a&gt;&lt;/p&gt;'><sup>29</sup></a>.</p>
<p>The C++ function exported to R does not perform the computations but only organizes the parallel execution of another, non-exported, function of type <code>Worker</code>.</p>
<p>Two (C++) parallelization functions are available for two types of tasks:</p>
<ul>
<li>
<code>parallelReduce</code> to accumulate a value, used here to sum distances.</li>
<li>
<code>parallelFor</code> to fill a result matrix.</li>
</ul>
<p>The syntax of the <code>Worker</code> is a bit tricky but simple enough to adapt: the constructors initialize the C variables from the values passed by R and declare the parallelization.</p>
<p></p>
<div class="sourceCode" id="cb215"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb215-1"><a href="chap-utiliseR.html#cb215-1" tabindex="-1"></a><span class="co">// [[Rcpp::depends(RcppParallel)]]</span></span>
<span id="cb215-2"><a href="chap-utiliseR.html#cb215-2" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb215-3"><a href="chap-utiliseR.html#cb215-3" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;RcppParallel.h&gt;</span></span>
<span id="cb215-4"><a href="chap-utiliseR.html#cb215-4" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> Rcpp<span class="op">;</span></span>
<span id="cb215-5"><a href="chap-utiliseR.html#cb215-5" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> RcppParallel<span class="op">;</span></span>
<span id="cb215-6"><a href="chap-utiliseR.html#cb215-6" tabindex="-1"></a></span>
<span id="cb215-7"><a href="chap-utiliseR.html#cb215-7" tabindex="-1"></a><span class="co">// Working function, not exported</span></span>
<span id="cb215-8"><a href="chap-utiliseR.html#cb215-8" tabindex="-1"></a><span class="kw">struct</span> TotalDistanceWrkr <span class="op">:</span> <span class="kw">public</span> Worker</span>
<span id="cb215-9"><a href="chap-utiliseR.html#cb215-9" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb215-10"><a href="chap-utiliseR.html#cb215-10" tabindex="-1"></a>  <span class="co">// source vectors</span></span>
<span id="cb215-11"><a href="chap-utiliseR.html#cb215-11" tabindex="-1"></a>  <span class="at">const</span> RVector<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Rx<span class="op">;</span></span>
<span id="cb215-12"><a href="chap-utiliseR.html#cb215-12" tabindex="-1"></a>  <span class="at">const</span> RVector<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Ry<span class="op">;</span></span>
<span id="cb215-13"><a href="chap-utiliseR.html#cb215-13" tabindex="-1"></a>  </span>
<span id="cb215-14"><a href="chap-utiliseR.html#cb215-14" tabindex="-1"></a>  <span class="co">// accumulated value</span></span>
<span id="cb215-15"><a href="chap-utiliseR.html#cb215-15" tabindex="-1"></a>  <span class="dt">double</span> distance<span class="op">;</span></span>
<span id="cb215-16"><a href="chap-utiliseR.html#cb215-16" tabindex="-1"></a>   </span>
<span id="cb215-17"><a href="chap-utiliseR.html#cb215-17" tabindex="-1"></a>  <span class="co">// constructors</span></span>
<span id="cb215-18"><a href="chap-utiliseR.html#cb215-18" tabindex="-1"></a>  TotalDistanceWrkr<span class="op">(</span><span class="at">const</span> NumericVector x<span class="op">,</span> <span class="at">const</span> NumericVector y<span class="op">)</span> <span class="op">:</span></span>
<span id="cb215-19"><a href="chap-utiliseR.html#cb215-19" tabindex="-1"></a>    Rx<span class="op">(</span>x<span class="op">),</span> Ry<span class="op">(</span>y<span class="op">),</span> distance<span class="op">(</span><span class="dv">0</span><span class="op">)</span> <span class="op">{}</span></span>
<span id="cb215-20"><a href="chap-utiliseR.html#cb215-20" tabindex="-1"></a>  TotalDistanceWrkr<span class="op">(</span><span class="at">const</span> TotalDistanceWrkr<span class="op">&amp;</span> totalDistanceWrkr<span class="op">,</span> Split<span class="op">)</span> <span class="op">:</span></span>
<span id="cb215-21"><a href="chap-utiliseR.html#cb215-21" tabindex="-1"></a>    Rx<span class="op">(</span>totalDistanceWrkr<span class="op">.</span>Rx<span class="op">),</span> Ry<span class="op">(</span>totalDistanceWrkr<span class="op">.</span>Ry<span class="op">),</span>  distance<span class="op">(</span><span class="dv">0</span><span class="op">)</span> <span class="op">{}</span></span>
<span id="cb215-22"><a href="chap-utiliseR.html#cb215-22" tabindex="-1"></a>  </span>
<span id="cb215-23"><a href="chap-utiliseR.html#cb215-23" tabindex="-1"></a>  <span class="co">// count neighbors</span></span>
<span id="cb215-24"><a href="chap-utiliseR.html#cb215-24" tabindex="-1"></a>  <span class="dt">void</span> <span class="kw">operator</span><span class="op">()(</span><span class="bu">std::</span>size_t begin<span class="op">,</span> <span class="bu">std::</span>size_t end<span class="op">)</span> <span class="op">{</span></span>
<span id="cb215-25"><a href="chap-utiliseR.html#cb215-25" tabindex="-1"></a>    <span class="dt">double</span> dx<span class="op">,</span> dy<span class="op">;</span></span>
<span id="cb215-26"><a href="chap-utiliseR.html#cb215-26" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">int</span> Npoints <span class="op">=</span> Rx<span class="op">.</span>length<span class="op">();</span></span>
<span id="cb215-27"><a href="chap-utiliseR.html#cb215-27" tabindex="-1"></a></span>
<span id="cb215-28"><a href="chap-utiliseR.html#cb215-28" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">unsigned</span> <span class="dt">int</span> i <span class="op">=</span> begin<span class="op">;</span> i <span class="op">&lt;</span> end<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb215-29"><a href="chap-utiliseR.html#cb215-29" tabindex="-1"></a>      <span class="cf">for</span> <span class="op">(</span><span class="dt">unsigned</span> <span class="dt">int</span> j <span class="op">=</span> i <span class="op">+</span> <span class="dv">1</span><span class="op">;</span> j <span class="op">&lt;</span> Npoints<span class="op">;</span> j<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb215-30"><a href="chap-utiliseR.html#cb215-30" tabindex="-1"></a>          <span class="co">// Calculate squared distance</span></span>
<span id="cb215-31"><a href="chap-utiliseR.html#cb215-31" tabindex="-1"></a>          dx <span class="op">=</span> Rx<span class="op">[</span>i<span class="op">]</span> <span class="op">-</span> Rx<span class="op">[</span>j<span class="op">];</span></span>
<span id="cb215-32"><a href="chap-utiliseR.html#cb215-32" tabindex="-1"></a>          dy <span class="op">=</span> Ry<span class="op">[</span>i<span class="op">]</span> <span class="op">-</span> Ry<span class="op">[</span>j<span class="op">];</span></span>
<span id="cb215-33"><a href="chap-utiliseR.html#cb215-33" tabindex="-1"></a>          distance <span class="op">+=</span> sqrt<span class="op">(</span>dx <span class="op">*</span> dx <span class="op">+</span> dy <span class="op">*</span> dy<span class="op">);</span></span>
<span id="cb215-34"><a href="chap-utiliseR.html#cb215-34" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb215-35"><a href="chap-utiliseR.html#cb215-35" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb215-36"><a href="chap-utiliseR.html#cb215-36" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb215-37"><a href="chap-utiliseR.html#cb215-37" tabindex="-1"></a></span>
<span id="cb215-38"><a href="chap-utiliseR.html#cb215-38" tabindex="-1"></a>  <span class="co">// join my value with that of another Sum</span></span>
<span id="cb215-39"><a href="chap-utiliseR.html#cb215-39" tabindex="-1"></a>  <span class="dt">void</span> join<span class="op">(</span><span class="at">const</span> TotalDistanceWrkr<span class="op">&amp;</span> rhs<span class="op">)</span> <span class="op">{</span> </span>
<span id="cb215-40"><a href="chap-utiliseR.html#cb215-40" tabindex="-1"></a>    distance <span class="op">+=</span> rhs<span class="op">.</span>distance<span class="op">;</span> </span>
<span id="cb215-41"><a href="chap-utiliseR.html#cb215-41" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb215-42"><a href="chap-utiliseR.html#cb215-42" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb215-43"><a href="chap-utiliseR.html#cb215-43" tabindex="-1"></a></span>
<span id="cb215-44"><a href="chap-utiliseR.html#cb215-44" tabindex="-1"></a></span>
<span id="cb215-45"><a href="chap-utiliseR.html#cb215-45" tabindex="-1"></a><span class="co">// Exported function</span></span>
<span id="cb215-46"><a href="chap-utiliseR.html#cb215-46" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb215-47"><a href="chap-utiliseR.html#cb215-47" tabindex="-1"></a><span class="dt">double</span> TotalDistance<span class="op">(</span>NumericVector x<span class="op">,</span> NumericVector y<span class="op">)</span> <span class="op">{</span></span>
<span id="cb215-48"><a href="chap-utiliseR.html#cb215-48" tabindex="-1"></a>  </span>
<span id="cb215-49"><a href="chap-utiliseR.html#cb215-49" tabindex="-1"></a>  <span class="co">// Declare TotalDistanceWrkr instance</span></span>
<span id="cb215-50"><a href="chap-utiliseR.html#cb215-50" tabindex="-1"></a>  TotalDistanceWrkr totalDistanceWrkr<span class="op">(</span>x<span class="op">,</span> y<span class="op">);</span></span>
<span id="cb215-51"><a href="chap-utiliseR.html#cb215-51" tabindex="-1"></a>  </span>
<span id="cb215-52"><a href="chap-utiliseR.html#cb215-52" tabindex="-1"></a>  <span class="co">// call parallel_reduce to start the work</span></span>
<span id="cb215-53"><a href="chap-utiliseR.html#cb215-53" tabindex="-1"></a>  parallelReduce<span class="op">(</span><span class="dv">0</span><span class="op">,</span> x<span class="op">.</span>length<span class="op">(),</span> totalDistanceWrkr<span class="op">);</span></span>
<span id="cb215-54"><a href="chap-utiliseR.html#cb215-54" tabindex="-1"></a>  </span>
<span id="cb215-55"><a href="chap-utiliseR.html#cb215-55" tabindex="-1"></a>  <span class="co">// return the result</span></span>
<span id="cb215-56"><a href="chap-utiliseR.html#cb215-56" tabindex="-1"></a>  <span class="cf">return</span> totalDistanceWrkr<span class="op">.</span>distance<span class="op">;</span></span>
<span id="cb215-57"><a href="chap-utiliseR.html#cb215-57" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p></p>
<p>The usage in R is identical to the usage of C++ functions interfaced by <strong>RCpp</strong>.</p>
<p></p>
<div class="sourceCode" id="cb216"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">mb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span></span>
<span>  <span class="va">d</span> <span class="op">&lt;-</span> <span class="fu">TotalDistance</span><span class="op">(</span><span class="va">X</span><span class="op">$</span><span class="va">x</span>, <span class="va">X</span><span class="op">$</span><span class="va">y</span><span class="op">)</span> <span class="op">/</span> <span class="va">n_points</span> <span class="op">/</span> <span class="op">(</span><span class="va">n_points</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span></span>
<span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## Unit: microseconds
##                                                      expr
##  d &lt;- TotalDistance(X$x, X$y)/n_points/(n_points - 1) * 2
##     min       lq     mean  median      uq      max neval
##  328.41 389.8895 583.3136 563.217 586.382 5381.906   100</code></pre>
<div class="sourceCode" id="cb218"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># suppressMessages to eliminate superfluous messages</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">mb</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="WwR_files/figure-html/RcppParallel-1.png" width="80%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb219"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span></span></code></pre></div>
<pre><code>## [1] 0.5154879</code></pre>
<p></p>
<p>The setup time for parallel tasks is much longer than the serial computation time.</p>
<p>Multiplying the number of points by 50, the serial computation time must be multiplied by about 2500.</p>
<p></p>
<div class="sourceCode" id="cb221"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_points</span> <span class="op">&lt;-</span> <span class="fl">50000</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spatstat.random/man/runifpoint.html">runifpoint</a></span><span class="op">(</span><span class="va">n_points</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu">MeanDistance</span><span class="op">(</span><span class="va">X</span><span class="op">$</span><span class="va">x</span>, <span class="va">X</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>##    user  system elapsed 
##   5.573   0.037   5.644</code></pre>
<p></p>
<p>In parallel, the time increases little: parallelization becomes really efficient.
This time is to be compared to that of the reference for loop, multiplied by 2500, that is <code>2742</code> seconds.</p>
<p></p>
<div class="sourceCode" id="cb223"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span></span>
<span>  <span class="va">d</span> <span class="op">&lt;-</span> <span class="fu">TotalDistance</span><span class="op">(</span><span class="va">X</span><span class="op">$</span><span class="va">x</span>, <span class="va">X</span><span class="op">$</span><span class="va">y</span><span class="op">)</span> <span class="op">/</span> <span class="va">n_points</span> <span class="op">/</span> <span class="op">(</span><span class="va">n_points</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code>##    user  system elapsed 
##   1.293   0.003   0.437</code></pre>
<p></p>
</div>
<div id="conclusions-on-code-speed-optimization" class="section level3" number="2.7.9">
<h3>
<span class="header-section-number">2.7.9</span> Conclusions on code speed optimization<a class="anchor" aria-label="anchor" href="#conclusions-on-code-speed-optimization"><i class="fas fa-link"></i></a>
</h3>
<p>From this case study, several lessons can be learned:</p>
<ul>
<li>A for loop is a good basis for repetitive calculations, faster than <code><a href="https://rdrr.io/r/base/lapply.html">vapply()</a></code>, simple to read and write.</li>
<li>
<strong>foreach</strong> loops are extremely effective for parallelizing for loops;</li>
<li>Optimized functions may exist in R packages for common tasks (here, the <code><a href="https://rdrr.io/pkg/spatstat.geom/man/pairdist.html">pairdist()</a></code> function of <strong>spatstat</strong> is two orders of magnitude faster than the for loop).</li>
<li>The <strong>future.apply</strong> package makes it very easy to parallelize code that has already been written with <code>*apply()</code> functions, regardless of the hardware used;</li>
<li>The use of C++ code allows to speed up the calculations significantly, by three orders of magnitude here.</li>
<li>Parallelization of the C++ code further divides the computation time by about half the number of cores for long computations.</li>
</ul>
<p>Beyond this example, optimizing computation time in R can be complicated if it involves parallelization and writing C++ code.
The effort must therefore be concentrated on the really long computations while the readability of the code must remain the priority for the current code.
C code is quite easy to integrate with <strong>RCpp</strong> and its parallelization is not very expensive with <strong>RCppParallel</strong>.</p>
<p>The use of for loops is no longer penalized since version 3.5 of R.
Writing vector code, using <code><a href="https://rdrr.io/r/base/lapply.html">sapply()</a></code> is still justified for its readability.</p>
<p>The choice of parallelizing the code must be evaluated according to the execution time of each parallelizable task.
If it exceeds a few seconds, parallelization is justified.</p>
</div>
</div>
<div id="sec:targets" class="section level2" number="2.8">
<h2>
<span class="header-section-number">2.8</span> Workflow<a class="anchor" aria-label="anchor" href="#sec:targets"><i class="fas fa-link"></i></a>
</h2>
<p>The <strong>targets</strong> package allows you to manage a <em>workflow</em>, i.e. to break down the code into elementary tasks called <em>targets</em> that follow each other, the result of which is stored in a variable, itself saved on disk.
In case of a change in the code or in the data used, only the targets concerned are reevaluated.</p>
<p>The operation of the flow is similar to that of a cache, but does not depend on the computer on which it runs.
It is also possible to integrate the flow into a document project (see section <a href="chap-rediger.html#sec:targetsmd">4.9</a>), and even to use a computing cluster to process the tasks in parallel.</p>
<div id="how-it-works-1" class="section level3" number="2.8.1">
<h3>
<span class="header-section-number">2.8.1</span> How it works<a class="anchor" aria-label="anchor" href="#how-it-works-1"><i class="fas fa-link"></i></a>
</h3>
<p>The documentation<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://books.ropensci.org/targets/" class="uri"&gt;https://books.ropensci.org/targets/&lt;/a&gt;&lt;/p&gt;'><sup>30</sup></a> of <strong>targets</strong> is detailed and provides a worked example to learn how to use the package<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://books.ropensci.org/targets/walkthrough.html" class="uri"&gt;https://books.ropensci.org/targets/walkthrough.html&lt;/a&gt;&lt;/p&gt;'><sup>31</sup></a>.
It is not repeated here, but the principles of how the flow works are explained..</p>
<p>The workflow is unique for a given project.
It is coded in the <code>_targets.R</code> file at the root of the project.
It contains:</p>
<ul>
<li>Global commands, such as loading packages.</li>
<li>A list of targets, which describe the code to be executed and the variable that stores their result.</li>
</ul>
<p>The workflow is run by the <code><a href="https://docs.ropensci.org/targets/reference/tar_make.html">tar_make()</a></code> function, which updates the targets that need it.
Its content is placed in the <code>_targets</code> folder.
Stored variables are read by <code><a href="https://docs.ropensci.org/targets/reference/tar_read.html">tar_read()</a></code>.</p>
<p>If the project requires long computations, <strong>targets</strong> can be used to run only those that are necessary.
If the project is shared or placed under source control (chapter <a href="chap-git.html#chap-git">3</a>), the result of the computations is also integrated.
Finally, if the project is a document (chapter <a href="chap-rediger.html#chap-rediger">4</a>), its formatting is completely independent of the calculation of its content, for possibly considerable time saving.</p>
</div>
<div id="minimal-example" class="section level3" number="2.8.2">
<h3>
<span class="header-section-number">2.8.2</span> Minimal example<a class="anchor" aria-label="anchor" href="#minimal-example"><i class="fas fa-link"></i></a>
</h3>
<p>The following example is even simpler than the one in the <strong>targets</strong> manual, which will allow you to go further.
It takes up the previous case study: a set of points is generated and the average distance between the points is calculated.
A map of the points is also drawn.
Each of these three operations is a target in the vocabulary of <strong>targets</strong>.</p>
<p>The workflow file is therefore the following:</p>
<p></p>
<div class="sourceCode" id="cb225"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># File _targets.R </span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://docs.ropensci.org/targets/">"targets"</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_option_set.html">tar_option_set</a></span><span class="op">(</span>packages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"spatstat"</span>, <span class="st">"dbmss"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  <span class="co"># Draw points</span></span>
<span>  <span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_target.html">tar_target</a></span><span class="op">(</span><span class="va">X</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/spatstat.random/man/runifpoint.html">runifpoint</a></span><span class="op">(</span><span class="va">n_points</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co"># Choose Parameters</span></span>
<span>  <span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_target.html">tar_target</a></span><span class="op">(</span><span class="va">n_points</span>,</span>
<span>    <span class="fl">1000</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co"># Average Distance</span></span>
<span>  <span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_target.html">tar_target</a></span><span class="op">(</span><span class="va">d</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/spatstat.geom/man/pairdist.html">pairdist</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="va">n_points</span> <span class="op">/</span> <span class="op">(</span><span class="va">n_points</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co"># Map</span></span>
<span>  <span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_target.html">tar_target</a></span><span class="op">(</span><span class="va">map</span>, </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="fu">as.wmppp</span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p></p>
<p>The global commands consist in loading the <strong>targets</strong> package itself and then listing the packages needed for the code.
The execution of the workflow takes place in a new instance of R.</p>
<p>The targets are then listed.
Each one is declared by the <code><a href="https://docs.ropensci.org/targets/reference/tar_target.html">tar_target()</a></code> function whose first argument is the name of the target, which will be the name of the variable that will receive the result.
The second argument is the code that produces the result.
Targets are very simple here and can be written in a single command.
When this is not the case, each target can be written as a function, stored in a separate code file loaded by the <code><a href="https://rdrr.io/r/base/source.html">source()</a></code> function at the beginning of the workflow file.</p>
<p>The <code>tar_visnetwork</code> command displays the sequence of targets and their possibly obsolete status.</p>
<p></p>
<div class="sourceCode" id="cb226"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://docs.ropensci.org/targets/">"targets"</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_visnetwork.html">tar_visnetwork</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="visNetwork html-widget html-fill-item" id="htmlwidget-4c2873e5859f69562509" style="width:80%;height:504px;"></div>
<script type="application/json" data-for="htmlwidget-4c2873e5859f69562509">{"x":{"nodes":{"name":["d","map","n_points","X"],"type":["stem","stem","stem","stem"],"description":[null,null,null,null],"status":["outdated","outdated","outdated","outdated"],"seconds":[null,null,null,null],"bytes":[null,null,null,null],"branches":[null,null,null,null],"label":["d","map","n_points","X"],"color":["#78B7C5","#78B7C5","#78B7C5","#78B7C5"],"id":["d","map","n_points","X"],"level":[3,3,1,2],"shape":["dot","dot","dot","dot"]},"edges":{"from":["n_points","X","n_points","X"],"to":["X","d","d","map"],"arrows":["to","to","to","to"]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"edges":{"smooth":{"type":"cubicBezier","forceDirection":"horizontal"}},"physics":{"stabilization":false},"interaction":{"zoomSpeed":1},"layout":{"hierarchical":{"enabled":true,"direction":"LR"}}},"groups":null,"width":null,"height":null,"idselection":{"enabled":false,"style":"width: 150px; height: 26px","useLabels":true,"main":"Select by id"},"byselection":{"enabled":false,"style":"width: 150px; height: 26px","multiple":false,"hideColor":"rgba(200,200,200,0.5)","highlight":false},"main":{"text":"","style":"font-family:Georgia, Times New Roman, Times, serif;font-weight:bold;font-size:20px;text-align:center;"},"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","highlight":{"enabled":true,"hoverNearest":false,"degree":{"from":1,"to":1},"algorithm":"hierarchical","hideColor":"rgba(200,200,200,0.5)","labelOnly":true},"collapse":{"enabled":true,"fit":false,"resetHighlight":true,"clusterOptions":null,"keepCoord":true,"labelSuffix":"(cluster)"},"legend":{"width":0.2,"useGroups":false,"position":"right","ncol":1,"stepX":100,"stepY":100,"zoom":true,"nodes":{"label":["Outdated","Stem"],"color":["#78B7C5","#899DA4"],"shape":["dot","dot"]},"nodesToDataframe":true},"tooltipStay":300,"tooltipStyle":"position: fixed;visibility:hidden;padding: 5px;white-space: nowrap;font-family: verdana;font-size:14px;font-color:#000000;background-color: #f5f4ed;-moz-border-radius: 3px;-webkit-border-radius: 3px;border-radius: 3px;border: 1px solid #808074;box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);"},"evals":[],"jsHooks":[]}</script><p></p>
<p>The order of declaration of the targets in the list is not important: they are ordered automatically.</p>
<p>The workflow is run by <code><a href="https://docs.ropensci.org/targets/reference/tar_make.html">tar_make()</a></code>.</p>
<p></p>
<div class="sourceCode" id="cb227"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_make.html">tar_make</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## ▶ dispatched target n_points
## ● completed target n_points [0.902 seconds, 53 bytes]
## ▶ dispatched target X
## ● completed target X [0.002 seconds, 11.058 kilobytes]
## ▶ dispatched target d
## ● completed target d [0.006 seconds, 55 bytes]
## ▶ dispatched target map
## ● completed target map [0.013 seconds, 187.39 kilobytes]
## ▶ ended pipeline [1.03 seconds]</code></pre>
<p></p>
<p>The workflow is now up to date and <code><a href="https://docs.ropensci.org/targets/reference/tar_make.html">tar_make()</a></code> does not recompute anything.</p>
<p></p>
<div class="sourceCode" id="cb229"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_visnetwork.html">tar_visnetwork</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="visNetwork html-widget html-fill-item" id="htmlwidget-c5409db81165a82e2db3" style="width:80%;height:504px;"></div>
<script type="application/json" data-for="htmlwidget-c5409db81165a82e2db3">{"x":{"nodes":{"name":["d","map","n_points","X"],"type":["stem","stem","stem","stem"],"description":[null,null,null,null],"status":["uptodate","uptodate","uptodate","uptodate"],"seconds":[0.006,0.013,0.902,0.002],"bytes":[55,187390,53,11058],"branches":[null,null,null,null],"label":["d","map","n_points","X"],"color":["#354823","#354823","#354823","#354823"],"id":["d","map","n_points","X"],"level":[3,3,1,2],"shape":["dot","dot","dot","dot"]},"edges":{"from":["n_points","X","n_points","X"],"to":["X","d","d","map"],"arrows":["to","to","to","to"]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"edges":{"smooth":{"type":"cubicBezier","forceDirection":"horizontal"}},"physics":{"stabilization":false},"interaction":{"zoomSpeed":1},"layout":{"hierarchical":{"enabled":true,"direction":"LR"}}},"groups":null,"width":null,"height":null,"idselection":{"enabled":false,"style":"width: 150px; height: 26px","useLabels":true,"main":"Select by id"},"byselection":{"enabled":false,"style":"width: 150px; height: 26px","multiple":false,"hideColor":"rgba(200,200,200,0.5)","highlight":false},"main":{"text":"","style":"font-family:Georgia, Times New Roman, Times, serif;font-weight:bold;font-size:20px;text-align:center;"},"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","highlight":{"enabled":true,"hoverNearest":false,"degree":{"from":1,"to":1},"algorithm":"hierarchical","hideColor":"rgba(200,200,200,0.5)","labelOnly":true},"collapse":{"enabled":true,"fit":false,"resetHighlight":true,"clusterOptions":null,"keepCoord":true,"labelSuffix":"(cluster)"},"legend":{"width":0.2,"useGroups":false,"position":"right","ncol":1,"stepX":100,"stepY":100,"zoom":true,"nodes":{"label":["Up to date","Stem"],"color":["#354823","#899DA4"],"shape":["dot","dot"]},"nodesToDataframe":true},"tooltipStay":300,"tooltipStyle":"position: fixed;visibility:hidden;padding: 5px;white-space: nowrap;font-family: verdana;font-size:14px;font-color:#000000;background-color: #f5f4ed;-moz-border-radius: 3px;-webkit-border-radius: 3px;border-radius: 3px;border: 1px solid #808074;box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);"},"evals":[],"jsHooks":[]}</script><div class="sourceCode" id="cb230"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_make.html">tar_make</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## ✔ skipping targets (1 so far)...
## ✔ skipped pipeline [0.046 seconds]</code></pre>
<p></p>
<p>The results are read by <code><a href="https://docs.ropensci.org/targets/reference/tar_read.html">tar_read()</a></code>.</p>
<p></p>
<div class="sourceCode" id="cb232"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_read.html">tar_read</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 0.5165293</code></pre>
<div class="sourceCode" id="cb234"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_read.html">tar_read</a></span><span class="op">(</span><span class="va">map</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="WwR_files/figure-html/tar_read-1.png" width="80%" style="display: block; margin: auto;"></div>
<p></p>
</div>
<div id="practical-interest" class="section level3" number="2.8.3">
<h3>
<span class="header-section-number">2.8.3</span> Practical interest<a class="anchor" aria-label="anchor" href="#practical-interest"><i class="fas fa-link"></i></a>
</h3>
<p>In this example, <strong>targets</strong> complicates writing the code and <code><a href="https://docs.ropensci.org/targets/reference/tar_make.html">tar_make()</a></code> is much slower than simply executing the code it processes because it has to check if the targets are up to date.
In a real project that requires long computations, processing the status of the targets is negligible and the time saved by just evaluating the necessary targets is considerable.
The definition of targets remains a constraint, but forces the user to structure their project rigorously.</p>

</div>
</div>
</div>

  <div class="chapter-nav">
<div class="prev"><a href="chap-logiciels.html"><span class="header-section-number">1</span> Software</a></div>
<div class="next"><a href="chap-git.html"><span class="header-section-number">3</span> Git and GitHub</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#chap-utiliseR"><span class="header-section-number">2</span> Use R</a></li>
<li>
<a class="nav-link" href="#the-languages-of-r"><span class="header-section-number">2.1</span> The languages of R</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#base"><span class="header-section-number">2.1.1</span> Base</a></li>
<li><a class="nav-link" href="#sec:S3"><span class="header-section-number">2.1.2</span> S3</a></li>
<li><a class="nav-link" href="#s4"><span class="header-section-number">2.1.3</span> S4</a></li>
<li><a class="nav-link" href="#rc"><span class="header-section-number">2.1.4</span> RC</a></li>
<li><a class="nav-link" href="#s6"><span class="header-section-number">2.1.5</span> S6</a></li>
<li><a class="nav-link" href="#tidyverse"><span class="header-section-number">2.1.6</span> Tidyverse</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#sec:environnements"><span class="header-section-number">2.2</span> Environments</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#organization"><span class="header-section-number">2.2.1</span> Organization</a></li>
<li><a class="nav-link" href="#search"><span class="header-section-number">2.2.2</span> Search</a></li>
<li><a class="nav-link" href="#package-namespaces"><span class="header-section-number">2.2.3</span> Package namespaces</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#measuring-execution-time"><span class="header-section-number">2.3</span> Measuring execution time</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#system.time"><span class="header-section-number">2.3.1</span> system.time</a></li>
<li><a class="nav-link" href="#microbenchmark"><span class="header-section-number">2.3.2</span> microbenchmark</a></li>
<li><a class="nav-link" href="#profiling"><span class="header-section-number">2.3.3</span> Profiling</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#loops"><span class="header-section-number">2.4</span> Loops</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#vector-functions"><span class="header-section-number">2.4.1</span> Vector functions</a></li>
<li><a class="nav-link" href="#lapply"><span class="header-section-number">2.4.2</span> lapply</a></li>
<li><a class="nav-link" href="#for-loops"><span class="header-section-number">2.4.3</span> For loops</a></li>
<li><a class="nav-link" href="#replicate"><span class="header-section-number">2.4.4</span> replicate</a></li>
<li><a class="nav-link" href="#vectorize"><span class="header-section-number">2.4.5</span> Vectorize</a></li>
<li><a class="nav-link" href="#marginal-statistics"><span class="header-section-number">2.4.6</span> Marginal statistics</a></li>
</ul>
</li>
<li><a class="nav-link" href="#sec:cpp"><span class="header-section-number">2.5</span> C++ code</a></li>
<li>
<a class="nav-link" href="#parallelizing-r"><span class="header-section-number">2.6</span> Parallelizing R</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#mclapply-fork"><span class="header-section-number">2.6.1</span> mclapply (fork)</a></li>
<li><a class="nav-link" href="#parlapply-socket"><span class="header-section-number">2.6.2</span> parLapply (socket)</a></li>
<li><a class="nav-link" href="#foreach"><span class="header-section-number">2.6.3</span> foreach</a></li>
<li><a class="nav-link" href="#future"><span class="header-section-number">2.6.4</span> future</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#sec:cas"><span class="header-section-number">2.7</span> Case study</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#creation-of-the-data"><span class="header-section-number">2.7.1</span> Creation of the data</a></li>
<li><a class="nav-link" href="#spatstat"><span class="header-section-number">2.7.2</span> Spatstat</a></li>
<li><a class="nav-link" href="#apply"><span class="header-section-number">2.7.3</span> apply</a></li>
<li><a class="nav-link" href="#future.apply"><span class="header-section-number">2.7.4</span> future.apply</a></li>
<li><a class="nav-link" href="#for-loop"><span class="header-section-number">2.7.5</span> for loop</a></li>
<li><a class="nav-link" href="#foreach-loop"><span class="header-section-number">2.7.6</span> foreach loop</a></li>
<li><a class="nav-link" href="#rcpp"><span class="header-section-number">2.7.7</span> RCpp</a></li>
<li><a class="nav-link" href="#rcppparallel"><span class="header-section-number">2.7.8</span> RcppParallel</a></li>
<li><a class="nav-link" href="#conclusions-on-code-speed-optimization"><span class="header-section-number">2.7.9</span> Conclusions on code speed optimization</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#sec:targets"><span class="header-section-number">2.8</span> Workflow</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#how-it-works-1"><span class="header-section-number">2.8.1</span> How it works</a></li>
<li><a class="nav-link" href="#minimal-example"><span class="header-section-number">2.8.2</span> Minimal example</a></li>
<li><a class="nav-link" href="#practical-interest"><span class="header-section-number">2.8.3</span> Practical interest</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/EricMarcon/WorkingWithR/blob/master/02-UseR.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/EricMarcon/WorkingWithR/edit/master/02-UseR.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Working with R</strong>" was written by Eric Marcon. It was last built on 01/21/2025.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
