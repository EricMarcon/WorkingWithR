<!DOCTYPE html>
<html lang="en-US" xml:lang="en-US">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>2 Use R | Working with R</title>
  <meta name="description" content="Organization of work around R and RStudio" />
  <meta name="generator" content="bookdown 0.27 and GitBook 2.6.7" />

  <meta property="og:title" content="2 Use R | Working with R" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="Organization of work around R and RStudio" />
  <meta name="github-repo" content="EricMarcon/WorkingWithR" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="2 Use R | Working with R" />
  
  <meta name="twitter:description" content="Organization of work around R and RStudio" />
  

<meta name="author" content="Eric Marcon" />


<meta name="date" content="2022-06-28" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="chap-logiciels.html"/>
<link rel="next" href="chap-git.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script>
<link href="libs/vis-9.1.0/vis-network.min.css" rel="stylesheet" />
<script src="libs/vis-9.1.0/vis-network.min.js"></script>
<script src="libs/visNetwork-binding-2.1.0/visNetwork.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />
<link href="libs/tabwid-1.0.0/tabwid.css" rel="stylesheet" />
<link href="libs/tabwid-1.0.0/scrool.css" rel="stylesheet" />
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-7NVD1TWMCJ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-7NVD1TWMCJ');
</script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Working With R</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Présentation</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#objectives"><i class="fa fa-check"></i>Objectives</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#conventions"><i class="fa fa-check"></i>Conventions</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="chap-logiciels.html"><a href="chap-logiciels.html"><i class="fa fa-check"></i><b>1</b> Software</a>
<ul>
<li class="chapter" data-level="1.1" data-path="chap-logiciels.html"><a href="chap-logiciels.html#r"><i class="fa fa-check"></i><b>1.1</b> R</a>
<ul>
<li class="chapter" data-level="1.1.1" data-path="chap-logiciels.html"><a href="chap-logiciels.html#installation"><i class="fa fa-check"></i><b>1.1.1</b> Installation</a></li>
<li class="chapter" data-level="1.1.2" data-path="chap-logiciels.html"><a href="chap-logiciels.html#rtools"><i class="fa fa-check"></i><b>1.1.2</b> Rtools</a></li>
<li class="chapter" data-level="1.1.3" data-path="chap-logiciels.html"><a href="chap-logiciels.html#update"><i class="fa fa-check"></i><b>1.1.3</b> Update</a></li>
<li class="chapter" data-level="1.1.4" data-path="chap-logiciels.html"><a href="chap-logiciels.html#sec:librairies"><i class="fa fa-check"></i><b>1.1.4</b> Libraries</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="chap-logiciels.html"><a href="chap-logiciels.html#rstudio"><i class="fa fa-check"></i><b>1.2</b> RStudio</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="chap-logiciels.html"><a href="chap-logiciels.html#installation-1"><i class="fa fa-check"></i><b>1.2.1</b> Installation</a></li>
<li class="chapter" data-level="1.2.2" data-path="chap-logiciels.html"><a href="chap-logiciels.html#file-encoding"><i class="fa fa-check"></i><b>1.2.2</b> File encoding</a></li>
<li class="chapter" data-level="1.2.3" data-path="chap-logiciels.html"><a href="chap-logiciels.html#working-folder"><i class="fa fa-check"></i><b>1.2.3</b> Working folder</a></li>
<li class="chapter" data-level="1.2.4" data-path="chap-logiciels.html"><a href="chap-logiciels.html#sec:solution-dossiers"><i class="fa fa-check"></i><b>1.2.4</b> Solution chosen</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="chap-logiciels.html"><a href="chap-logiciels.html#packages"><i class="fa fa-check"></i><b>1.3</b> Packages</a>
<ul>
<li class="chapter" data-level="1.3.1" data-path="chap-logiciels.html"><a href="chap-logiciels.html#installation-from-cran"><i class="fa fa-check"></i><b>1.3.1</b> Installation from CRAN</a></li>
<li class="chapter" data-level="1.3.2" data-path="chap-logiciels.html"><a href="chap-logiciels.html#installation-from-github"><i class="fa fa-check"></i><b>1.3.2</b> Installation from GitHub</a></li>
<li class="chapter" data-level="1.3.3" data-path="chap-logiciels.html"><a href="chap-logiciels.html#installation-from-bioconductor"><i class="fa fa-check"></i><b>1.3.3</b> Installation from Bioconductor</a></li>
<li class="chapter" data-level="1.3.4" data-path="chap-logiciels.html"><a href="chap-logiciels.html#selected-solution"><i class="fa fa-check"></i><b>1.3.4</b> Selected solution</a></li>
</ul></li>
<li class="chapter" data-level="1.4" data-path="chap-logiciels.html"><a href="chap-logiciels.html#git-and-github"><i class="fa fa-check"></i><b>1.4</b> git and GitHub</a>
<ul>
<li class="chapter" data-level="1.4.1" data-path="chap-logiciels.html"><a href="chap-logiciels.html#git"><i class="fa fa-check"></i><b>1.4.1</b> git</a></li>
<li class="chapter" data-level="1.4.2" data-path="chap-logiciels.html"><a href="chap-logiciels.html#github"><i class="fa fa-check"></i><b>1.4.2</b> GitHub</a></li>
<li class="chapter" data-level="1.4.3" data-path="chap-logiciels.html"><a href="chap-logiciels.html#sec:SSH"><i class="fa fa-check"></i><b>1.4.3</b> SSH authentication</a></li>
<li class="chapter" data-level="1.4.4" data-path="chap-logiciels.html"><a href="chap-logiciels.html#sec:pat"><i class="fa fa-check"></i><b>1.4.4</b> Obtaining a personal access token</a></li>
</ul></li>
<li class="chapter" data-level="1.5" data-path="chap-logiciels.html"><a href="chap-logiciels.html#latex-compiler"><i class="fa fa-check"></i><b>1.5</b> LaTeX compiler</a>
<ul>
<li class="chapter" data-level="1.5.1" data-path="chap-logiciels.html"><a href="chap-logiciels.html#tinytex"><i class="fa fa-check"></i><b>1.5.1</b> tinytex</a></li>
<li class="chapter" data-level="1.5.2" data-path="chap-logiciels.html"><a href="chap-logiciels.html#miktex"><i class="fa fa-check"></i><b>1.5.2</b> MiKTeX</a></li>
</ul></li>
<li class="chapter" data-level="1.6" data-path="chap-logiciels.html"><a href="chap-logiciels.html#sec:Zotero"><i class="fa fa-check"></i><b>1.6</b> Zotero</a></li>
<li class="chapter" data-level="1.7" data-path="chap-logiciels.html"><a href="chap-logiciels.html#go"><i class="fa fa-check"></i><b>1.7</b> Go</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="chap-utiliseR.html"><a href="chap-utiliseR.html"><i class="fa fa-check"></i><b>2</b> Use R</a>
<ul>
<li class="chapter" data-level="2.1" data-path="chap-utiliseR.html"><a href="chap-utiliseR.html#the-languages-of-r"><i class="fa fa-check"></i><b>2.1</b> The languages of R</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="chap-utiliseR.html"><a href="chap-utiliseR.html#base"><i class="fa fa-check"></i><b>2.1.1</b> Base</a></li>
<li class="chapter" data-level="2.1.2" data-path="chap-utiliseR.html"><a href="chap-utiliseR.html#sec:S3"><i class="fa fa-check"></i><b>2.1.2</b> S3</a></li>
<li class="chapter" data-level="2.1.3" data-path="chap-utiliseR.html"><a href="chap-utiliseR.html#s4"><i class="fa fa-check"></i><b>2.1.3</b> S4</a></li>
<li class="chapter" data-level="2.1.4" data-path="chap-utiliseR.html"><a href="chap-utiliseR.html#rc"><i class="fa fa-check"></i><b>2.1.4</b> RC</a></li>
<li class="chapter" data-level="2.1.5" data-path="chap-utiliseR.html"><a href="chap-utiliseR.html#s6"><i class="fa fa-check"></i><b>2.1.5</b> S6</a></li>
<li class="chapter" data-level="2.1.6" data-path="chap-utiliseR.html"><a href="chap-utiliseR.html#tidyverse"><i class="fa fa-check"></i><b>2.1.6</b> Tidyverse</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="chap-utiliseR.html"><a href="chap-utiliseR.html#sec:environnements"><i class="fa fa-check"></i><b>2.2</b> Environments</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="chap-utiliseR.html"><a href="chap-utiliseR.html#organization"><i class="fa fa-check"></i><b>2.2.1</b> Organization</a></li>
<li class="chapter" data-level="2.2.2" data-path="chap-utiliseR.html"><a href="chap-utiliseR.html#search"><i class="fa fa-check"></i><b>2.2.2</b> Search</a></li>
<li class="chapter" data-level="2.2.3" data-path="chap-utiliseR.html"><a href="chap-utiliseR.html#espaces-de-nom-des-packages"><i class="fa fa-check"></i><b>2.2.3</b> Espaces de nom des packages</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="chap-utiliseR.html"><a href="chap-utiliseR.html#measuring-execution-time"><i class="fa fa-check"></i><b>2.3</b> Measuring execution time</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="chap-utiliseR.html"><a href="chap-utiliseR.html#system.time"><i class="fa fa-check"></i><b>2.3.1</b> system.time</a></li>
<li class="chapter" data-level="2.3.2" data-path="chap-utiliseR.html"><a href="chap-utiliseR.html#microbenchmark"><i class="fa fa-check"></i><b>2.3.2</b> microbenchmark</a></li>
<li class="chapter" data-level="2.3.3" data-path="chap-utiliseR.html"><a href="chap-utiliseR.html#profiling"><i class="fa fa-check"></i><b>2.3.3</b> Profiling</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="chap-utiliseR.html"><a href="chap-utiliseR.html#loops"><i class="fa fa-check"></i><b>2.4</b> Loops</a>
<ul>
<li class="chapter" data-level="2.4.1" data-path="chap-utiliseR.html"><a href="chap-utiliseR.html#vector-functions"><i class="fa fa-check"></i><b>2.4.1</b> Vector functions</a></li>
<li class="chapter" data-level="2.4.2" data-path="chap-utiliseR.html"><a href="chap-utiliseR.html#lapply"><i class="fa fa-check"></i><b>2.4.2</b> lapply</a></li>
<li class="chapter" data-level="2.4.3" data-path="chap-utiliseR.html"><a href="chap-utiliseR.html#for-loops"><i class="fa fa-check"></i><b>2.4.3</b> For loops</a></li>
<li class="chapter" data-level="2.4.4" data-path="chap-utiliseR.html"><a href="chap-utiliseR.html#replicate"><i class="fa fa-check"></i><b>2.4.4</b> replicate</a></li>
<li class="chapter" data-level="2.4.5" data-path="chap-utiliseR.html"><a href="chap-utiliseR.html#vectorize"><i class="fa fa-check"></i><b>2.4.5</b> Vectorize</a></li>
<li class="chapter" data-level="2.4.6" data-path="chap-utiliseR.html"><a href="chap-utiliseR.html#marginal-statistics"><i class="fa fa-check"></i><b>2.4.6</b> Marginal statistics</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="chap-utiliseR.html"><a href="chap-utiliseR.html#sec:cpp"><i class="fa fa-check"></i><b>2.5</b> C++ code</a></li>
<li class="chapter" data-level="2.6" data-path="chap-utiliseR.html"><a href="chap-utiliseR.html#parallelizing-r"><i class="fa fa-check"></i><b>2.6</b> Parallelizing R</a>
<ul>
<li class="chapter" data-level="2.6.1" data-path="chap-utiliseR.html"><a href="chap-utiliseR.html#mclapply-fork"><i class="fa fa-check"></i><b>2.6.1</b> mclapply (fork)</a></li>
<li class="chapter" data-level="2.6.2" data-path="chap-utiliseR.html"><a href="chap-utiliseR.html#parlapply-socket"><i class="fa fa-check"></i><b>2.6.2</b> parLapply (socket)</a></li>
<li class="chapter" data-level="2.6.3" data-path="chap-utiliseR.html"><a href="chap-utiliseR.html#foreach"><i class="fa fa-check"></i><b>2.6.3</b> foreach</a></li>
</ul></li>
<li class="chapter" data-level="2.7" data-path="chap-utiliseR.html"><a href="chap-utiliseR.html#sec:cas"><i class="fa fa-check"></i><b>2.7</b> Case study</a>
<ul>
<li class="chapter" data-level="2.7.1" data-path="chap-utiliseR.html"><a href="chap-utiliseR.html#creation-of-the-data"><i class="fa fa-check"></i><b>2.7.1</b> Creation of the data</a></li>
<li class="chapter" data-level="2.7.2" data-path="chap-utiliseR.html"><a href="chap-utiliseR.html#spatstat"><i class="fa fa-check"></i><b>2.7.2</b> Spatstat</a></li>
<li class="chapter" data-level="2.7.3" data-path="chap-utiliseR.html"><a href="chap-utiliseR.html#apply"><i class="fa fa-check"></i><b>2.7.3</b> apply</a></li>
<li class="chapter" data-level="2.7.4" data-path="chap-utiliseR.html"><a href="chap-utiliseR.html#boucle-for"><i class="fa fa-check"></i><b>2.7.4</b> boucle for</a></li>
<li class="chapter" data-level="2.7.5" data-path="chap-utiliseR.html"><a href="chap-utiliseR.html#boucle-foreach"><i class="fa fa-check"></i><b>2.7.5</b> boucle foreach</a></li>
<li class="chapter" data-level="2.7.6" data-path="chap-utiliseR.html"><a href="chap-utiliseR.html#rcpp"><i class="fa fa-check"></i><b>2.7.6</b> RCpp</a></li>
<li class="chapter" data-level="2.7.7" data-path="chap-utiliseR.html"><a href="chap-utiliseR.html#rcppparallel"><i class="fa fa-check"></i><b>2.7.7</b> RcppParallel</a></li>
<li class="chapter" data-level="2.7.8" data-path="chap-utiliseR.html"><a href="chap-utiliseR.html#conclusions-on-code-speed-optimization"><i class="fa fa-check"></i><b>2.7.8</b> Conclusions on code speed optimization</a></li>
</ul></li>
<li class="chapter" data-level="2.8" data-path="chap-utiliseR.html"><a href="chap-utiliseR.html#sec:targets"><i class="fa fa-check"></i><b>2.8</b> Workflow</a>
<ul>
<li class="chapter" data-level="2.8.1" data-path="chap-utiliseR.html"><a href="chap-utiliseR.html#how-it-works-1"><i class="fa fa-check"></i><b>2.8.1</b> How it works</a></li>
<li class="chapter" data-level="2.8.2" data-path="chap-utiliseR.html"><a href="chap-utiliseR.html#minimal-example"><i class="fa fa-check"></i><b>2.8.2</b> Minimal example</a></li>
<li class="chapter" data-level="2.8.3" data-path="chap-utiliseR.html"><a href="chap-utiliseR.html#practical-interest"><i class="fa fa-check"></i><b>2.8.3</b> Practical interest</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="chap-git.html"><a href="chap-git.html"><i class="fa fa-check"></i><b>3</b> Git and GitHub</a>
<ul>
<li class="chapter" data-level="3.1" data-path="chap-git.html"><a href="chap-git.html#sec:principes-git"><i class="fa fa-check"></i><b>3.1</b> Principles</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="chap-git.html"><a href="chap-git.html#sec:git-cds"><i class="fa fa-check"></i><b>3.1.1</b> Source control</a></li>
<li class="chapter" data-level="3.1.2" data-path="chap-git.html"><a href="chap-git.html#git-and-github-1"><i class="fa fa-check"></i><b>3.1.2</b> git and GitHub</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="chap-git.html"><a href="chap-git.html#sec:creerdepot"><i class="fa fa-check"></i><b>3.2</b> Create a new repository</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="chap-git.html"><a href="chap-git.html#from-an-existing-project"><i class="fa fa-check"></i><b>3.2.1</b> From an existing project</a></li>
<li class="chapter" data-level="3.2.2" data-path="chap-git.html"><a href="chap-git.html#taking-files-into-account"><i class="fa fa-check"></i><b>3.2.2</b> Taking files into account</a></li>
<li class="chapter" data-level="3.2.3" data-path="chap-git.html"><a href="chap-git.html#committing-changes"><i class="fa fa-check"></i><b>3.2.3</b> Committing changes</a></li>
<li class="chapter" data-level="3.2.4" data-path="chap-git.html"><a href="chap-git.html#create-an-empty-repository-on-github"><i class="fa fa-check"></i><b>3.2.4</b> Create an empty repository on GitHub</a></li>
<li class="chapter" data-level="3.2.5" data-path="chap-git.html"><a href="chap-git.html#linking-git-and-github"><i class="fa fa-check"></i><b>3.2.5</b> Linking git and GitHub</a></li>
<li class="chapter" data-level="3.2.6" data-path="chap-git.html"><a href="chap-git.html#push-the-first-modifications"><i class="fa fa-check"></i><b>3.2.6</b> Push the first modifications</a></li>
<li class="chapter" data-level="3.2.7" data-path="chap-git.html"><a href="chap-git.html#clone-a-repository-from-github"><i class="fa fa-check"></i><b>3.2.7</b> Clone a repository from GitHub</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="chap-git.html"><a href="chap-git.html#common-usage"><i class="fa fa-check"></i><b>3.3</b> Common usage</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="chap-git.html"><a href="chap-git.html#pull-modify-commit-push"><i class="fa fa-check"></i><b>3.3.1</b> Pull, modify, commit, push</a></li>
<li class="chapter" data-level="3.3.2" data-path="chap-git.html"><a href="chap-git.html#resolve-conflicts"><i class="fa fa-check"></i><b>3.3.2</b> Resolve conflicts</a></li>
<li class="chapter" data-level="3.3.3" data-path="chap-git.html"><a href="chap-git.html#see-the-differences"><i class="fa fa-check"></i><b>3.3.3</b> See the differences</a></li>
<li class="chapter" data-level="3.3.4" data-path="chap-git.html"><a href="chap-git.html#revert"><i class="fa fa-check"></i><b>3.3.4</b> Revert</a></li>
<li class="chapter" data-level="3.3.5" data-path="chap-git.html"><a href="chap-git.html#view-history"><i class="fa fa-check"></i><b>3.3.5</b> View history</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="chap-git.html"><a href="chap-git.html#sec:branches"><i class="fa fa-check"></i><b>3.4</b> Branches</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="chap-git.html"><a href="chap-git.html#create-a-new-branch"><i class="fa fa-check"></i><b>3.4.1</b> Create a new branch</a></li>
<li class="chapter" data-level="3.4.2" data-path="chap-git.html"><a href="chap-git.html#change-branch"><i class="fa fa-check"></i><b>3.4.2</b> Change branch</a></li>
<li class="chapter" data-level="3.4.3" data-path="chap-git.html"><a href="chap-git.html#pushing-the-new-branch"><i class="fa fa-check"></i><b>3.4.3</b> Pushing the new branch</a></li>
<li class="chapter" data-level="3.4.4" data-path="chap-git.html"><a href="chap-git.html#filesystem-behavior"><i class="fa fa-check"></i><b>3.4.4</b> Filesystem behavior</a></li>
<li class="chapter" data-level="3.4.5" data-path="chap-git.html"><a href="chap-git.html#merge-with-merge"><i class="fa fa-check"></i><b>3.4.5</b> Merge with `merge</a></li>
<li class="chapter" data-level="3.4.6" data-path="chap-git.html"><a href="chap-git.html#merging-with-a-pull-request"><i class="fa fa-check"></i><b>3.4.6</b> Merging with a pull request</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="chap-git.html"><a href="chap-git.html#advanced-usage"><i class="fa fa-check"></i><b>3.5</b> Advanced usage</a>
<ul>
<li class="chapter" data-level="3.5.1" data-path="chap-git.html"><a href="chap-git.html#git-commands"><i class="fa fa-check"></i><b>3.5.1</b> Git commands</a></li>
<li class="chapter" data-level="3.5.2" data-path="chap-git.html"><a href="chap-git.html#size-of-a-repository"><i class="fa fa-check"></i><b>3.5.2</b> Size of a repository</a></li>
<li class="chapter" data-level="3.5.3" data-path="chap-git.html"><a href="chap-git.html#delete-a-folder"><i class="fa fa-check"></i><b>3.5.3</b> Delete a folder</a></li>
<li class="chapter" data-level="3.5.4" data-path="chap-git.html"><a href="chap-git.html#revert-1"><i class="fa fa-check"></i><b>3.5.4</b> Revert</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="chap-git.html"><a href="chap-git.html#sec:confidential"><i class="fa fa-check"></i><b>3.6</b> Confidential data in a public repository</a>
<ul>
<li class="chapter" data-level="3.6.1" data-path="chap-git.html"><a href="chap-git.html#generating-a-key-pair-for-the-project-owner"><i class="fa fa-check"></i><b>3.6.1</b> Generating a key pair for the project owner</a></li>
<li class="chapter" data-level="3.6.2" data-path="chap-git.html"><a href="chap-git.html#generating-a-key-pair-for-the-project"><i class="fa fa-check"></i><b>3.6.2</b> Generating a key pair for the project</a></li>
<li class="chapter" data-level="3.6.3" data-path="chap-git.html"><a href="chap-git.html#creating-a-safe"><i class="fa fa-check"></i><b>3.6.3</b> Creating a safe</a></li>
<li class="chapter" data-level="3.6.4" data-path="chap-git.html"><a href="chap-git.html#adding-users"><i class="fa fa-check"></i><b>3.6.4</b> Adding users</a></li>
<li class="chapter" data-level="3.6.5" data-path="chap-git.html"><a href="chap-git.html#storing-the-data"><i class="fa fa-check"></i><b>3.6.5</b> Storing the data</a></li>
</ul></li>
<li class="chapter" data-level="3.7" data-path="chap-git.html"><a href="chap-git.html#sec:github-pages"><i class="fa fa-check"></i><b>3.7</b> GitHub pages</a>
<ul>
<li class="chapter" data-level="3.7.1" data-path="chap-git.html"><a href="chap-git.html#activation"><i class="fa fa-check"></i><b>3.7.1</b> Activation</a></li>
<li class="chapter" data-level="3.7.2" data-path="chap-git.html"><a href="chap-git.html#badges"><i class="fa fa-check"></i><b>3.7.2</b> Badges</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="chap-rediger.html"><a href="chap-rediger.html"><i class="fa fa-check"></i><b>4</b> Writing</a>
<ul>
<li class="chapter" data-level="4.1" data-path="chap-rediger.html"><a href="chap-rediger.html#markdown-notebook-r-notebook"><i class="fa fa-check"></i><b>4.1</b> Markdown notebook (R Notebook)</a></li>
<li class="chapter" data-level="4.2" data-path="chap-rediger.html"><a href="chap-rediger.html#r-markdown-templates"><i class="fa fa-check"></i><b>4.2</b> R Markdown templates</a></li>
<li class="chapter" data-level="4.3" data-path="chap-rediger.html"><a href="chap-rediger.html#articles-with-bookdown"><i class="fa fa-check"></i><b>4.3</b> Articles with bookdown</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="chap-rediger.html"><a href="chap-rediger.html#writing"><i class="fa fa-check"></i><b>4.3.1</b> Writing</a></li>
<li class="chapter" data-level="4.3.2" data-path="chap-rediger.html"><a href="chap-rediger.html#sec:memo"><i class="fa fa-check"></i><b>4.3.2</b> Simple Article template</a></li>
<li class="chapter" data-level="4.3.3" data-path="chap-rediger.html"><a href="chap-rediger.html#other-templates"><i class="fa fa-check"></i><b>4.3.3</b> Other templates</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="chap-rediger.html"><a href="chap-rediger.html#beamer-presentation"><i class="fa fa-check"></i><b>4.4</b> Beamer Presentation</a></li>
<li class="chapter" data-level="4.5" data-path="chap-rediger.html"><a href="chap-rediger.html#memoir"><i class="fa fa-check"></i><b>4.5</b> memoir</a>
<ul>
<li class="chapter" data-level="4.5.1" data-path="chap-rediger.html"><a href="chap-rediger.html#create-1"><i class="fa fa-check"></i><b>4.5.1</b> Create</a></li>
<li class="chapter" data-level="4.5.2" data-path="chap-rediger.html"><a href="chap-rediger.html#write-1"><i class="fa fa-check"></i><b>4.5.2</b> Write</a></li>
<li class="chapter" data-level="4.5.3" data-path="chap-rediger.html"><a href="chap-rediger.html#knit-1"><i class="fa fa-check"></i><b>4.5.3</b> Knit</a></li>
<li class="chapter" data-level="4.5.4" data-path="chap-rediger.html"><a href="chap-rediger.html#finishing"><i class="fa fa-check"></i><b>4.5.4</b> Finishing</a></li>
<li class="chapter" data-level="4.5.5" data-path="chap-rediger.html"><a href="chap-rediger.html#gitbook-site"><i class="fa fa-check"></i><b>4.5.5</b> Gitbook site</a></li>
<li class="chapter" data-level="4.5.6" data-path="chap-rediger.html"><a href="chap-rediger.html#sec:rediger-ouvrage-ci"><i class="fa fa-check"></i><b>4.5.6</b> Continuous integration</a></li>
<li class="chapter" data-level="4.5.7" data-path="chap-rediger.html"><a href="chap-rediger.html#google-analytics"><i class="fa fa-check"></i><b>4.5.7</b> Google Analytics</a></li>
</ul></li>
<li class="chapter" data-level="4.6" data-path="chap-rediger.html"><a href="chap-rediger.html#r-markdown-web-site"><i class="fa fa-check"></i><b>4.6</b> R Markdown web site</a>
<ul>
<li class="chapter" data-level="4.6.1" data-path="chap-rediger.html"><a href="chap-rediger.html#template"><i class="fa fa-check"></i><b>4.6.1</b> Template</a></li>
<li class="chapter" data-level="4.6.2" data-path="chap-rediger.html"><a href="chap-rediger.html#improvements"><i class="fa fa-check"></i><b>4.6.2</b> Improvements</a></li>
<li class="chapter" data-level="4.6.3" data-path="chap-rediger.html"><a href="chap-rediger.html#source-control"><i class="fa fa-check"></i><b>4.6.3</b> Source control</a></li>
</ul></li>
<li class="chapter" data-level="4.7" data-path="chap-rediger.html"><a href="chap-rediger.html#sec:blogdown"><i class="fa fa-check"></i><b>4.7</b> Personal web site: blogdown</a>
<ul>
<li class="chapter" data-level="4.7.1" data-path="chap-rediger.html"><a href="chap-rediger.html#installing-the-tools"><i class="fa fa-check"></i><b>4.7.1</b> Installing the tools</a></li>
<li class="chapter" data-level="4.7.2" data-path="chap-rediger.html"><a href="chap-rediger.html#create-2"><i class="fa fa-check"></i><b>4.7.2</b> Create</a></li>
<li class="chapter" data-level="4.7.3" data-path="chap-rediger.html"><a href="chap-rediger.html#building-the-site"><i class="fa fa-check"></i><b>4.7.3</b> Building the site</a></li>
<li class="chapter" data-level="4.7.4" data-path="chap-rediger.html"><a href="chap-rediger.html#multilingual-site"><i class="fa fa-check"></i><b>4.7.4</b> Multilingual site</a></li>
<li class="chapter" data-level="4.7.5" data-path="chap-rediger.html"><a href="chap-rediger.html#set-up"><i class="fa fa-check"></i><b>4.7.5</b> Set up</a></li>
<li class="chapter" data-level="4.7.6" data-path="chap-rediger.html"><a href="chap-rediger.html#write-2"><i class="fa fa-check"></i><b>4.7.6</b> Write</a></li>
<li class="chapter" data-level="4.7.7" data-path="chap-rediger.html"><a href="chap-rediger.html#sec:rediger-web-ci"><i class="fa fa-check"></i><b>4.7.7</b> Continuous integration</a></li>
<li class="chapter" data-level="4.7.8" data-path="chap-rediger.html"><a href="chap-rediger.html#updates-1"><i class="fa fa-check"></i><b>4.7.8</b> Updates</a></li>
</ul></li>
<li class="chapter" data-level="4.8" data-path="chap-rediger.html"><a href="chap-rediger.html#exporting-figures"><i class="fa fa-check"></i><b>4.8</b> Exporting figures</a>
<ul>
<li class="chapter" data-level="4.8.1" data-path="chap-rediger.html"><a href="chap-rediger.html#vector-and-raster-formats"><i class="fa fa-check"></i><b>4.8.1</b> Vector and Raster Formats</a></li>
<li class="chapter" data-level="4.8.2" data-path="chap-rediger.html"><a href="chap-rediger.html#functions"><i class="fa fa-check"></i><b>4.8.2</b> Functions</a></li>
<li class="chapter" data-level="4.8.3" data-path="chap-rediger.html"><a href="chap-rediger.html#ragg-package"><i class="fa fa-check"></i><b>4.8.3</b> ragg package</a></li>
</ul></li>
<li class="chapter" data-level="4.9" data-path="chap-rediger.html"><a href="chap-rediger.html#sec:targetsmd"><i class="fa fa-check"></i><b>4.9</b> Workflow</a>
<ul>
<li class="chapter" data-level="4.9.1" data-path="chap-rediger.html"><a href="chap-rediger.html#declaration-of-the-workflow"><i class="fa fa-check"></i><b>4.9.1</b> Declaration of the workflow</a></li>
<li class="chapter" data-level="4.9.2" data-path="chap-rediger.html"><a href="chap-rediger.html#declaration-of-targets"><i class="fa fa-check"></i><b>4.9.2</b> Declaration of targets</a></li>
<li class="chapter" data-level="4.9.3" data-path="chap-rediger.html"><a href="chap-rediger.html#running-the-flow"><i class="fa fa-check"></i><b>4.9.3</b> Running the flow</a></li>
<li class="chapter" data-level="4.9.4" data-path="chap-rediger.html"><a href="chap-rediger.html#using-the-results"><i class="fa fa-check"></i><b>4.9.4</b> Using the results</a></li>
<li class="chapter" data-level="4.9.5" data-path="chap-rediger.html"><a href="chap-rediger.html#source-control-1"><i class="fa fa-check"></i><b>4.9.5</b> Source control</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="chap-package.html"><a href="chap-package.html"><i class="fa fa-check"></i><b>5</b> Package</a>
<ul>
<li class="chapter" data-level="5.1" data-path="chap-package.html"><a href="chap-package.html#first-package"><i class="fa fa-check"></i><b>5.1</b> First package</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="chap-package.html"><a href="chap-package.html#creation"><i class="fa fa-check"></i><b>5.1.1</b> Creation</a></li>
<li class="chapter" data-level="5.1.2" data-path="chap-package.html"><a href="chap-package.html#first-function"><i class="fa fa-check"></i><b>5.1.2</b> First function</a></li>
<li class="chapter" data-level="5.1.3" data-path="chap-package.html"><a href="chap-package.html#sec:package-cds"><i class="fa fa-check"></i><b>5.1.3</b> Source control</a></li>
<li class="chapter" data-level="5.1.4" data-path="chap-package.html"><a href="chap-package.html#package.r"><i class="fa fa-check"></i><b>5.1.4</b> package.R</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="chap-package.html"><a href="chap-package.html#package-organization"><i class="fa fa-check"></i><b>5.2</b> Package organization</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="chap-package.html"><a href="chap-package.html#sec:package-description"><i class="fa fa-check"></i><b>5.2.1</b> DESCRIPTION file</a></li>
<li class="chapter" data-level="5.2.2" data-path="chap-package.html"><a href="chap-package.html#news.md-file"><i class="fa fa-check"></i><b>5.2.2</b> NEWS.md file</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="chap-package.html"><a href="chap-package.html#vignette"><i class="fa fa-check"></i><b>5.3</b> Vignette</a></li>
<li class="chapter" data-level="5.4" data-path="chap-package.html"><a href="chap-package.html#pkgdown"><i class="fa fa-check"></i><b>5.4</b> pkgdown</a></li>
<li class="chapter" data-level="5.5" data-path="chap-package.html"><a href="chap-package.html#package-specific-code"><i class="fa fa-check"></i><b>5.5</b> Package specific code</a>
<ul>
<li class="chapter" data-level="5.5.1" data-path="chap-package.html"><a href="chap-package.html#importing-functions"><i class="fa fa-check"></i><b>5.5.1</b> Importing functions</a></li>
<li class="chapter" data-level="5.5.2" data-path="chap-package.html"><a href="chap-package.html#s3-methods"><i class="fa fa-check"></i><b>5.5.2</b> S3 methods</a></li>
<li class="chapter" data-level="5.5.3" data-path="chap-package.html"><a href="chap-package.html#in-practice"><i class="fa fa-check"></i><b>5.5.3</b> In practice</a></li>
<li class="chapter" data-level="5.5.4" data-path="chap-package.html"><a href="chap-package.html#c-code"><i class="fa fa-check"></i><b>5.5.4</b> C++ code</a></li>
<li class="chapter" data-level="5.5.5" data-path="chap-package.html"><a href="chap-package.html#tidy-package"><i class="fa fa-check"></i><b>5.5.5</b> Tidy package</a></li>
</ul></li>
<li class="chapter" data-level="5.6" data-path="chap-package.html"><a href="chap-package.html#bibliography-1"><i class="fa fa-check"></i><b>5.6</b> Bibliography</a>
<ul>
<li class="chapter" data-level="5.6.1" data-path="chap-package.html"><a href="chap-package.html#preparation"><i class="fa fa-check"></i><b>5.6.1</b> Preparation</a></li>
<li class="chapter" data-level="5.6.2" data-path="chap-package.html"><a href="chap-package.html#citations"><i class="fa fa-check"></i><b>5.6.2</b> Citations</a></li>
</ul></li>
<li class="chapter" data-level="5.7" data-path="chap-package.html"><a href="chap-package.html#data"><i class="fa fa-check"></i><b>5.7</b> Data</a></li>
<li class="chapter" data-level="5.8" data-path="chap-package.html"><a href="chap-package.html#unit-tests"><i class="fa fa-check"></i><b>5.8</b> Unit tests</a></li>
<li class="chapter" data-level="5.9" data-path="chap-package.html"><a href="chap-package.html#gitignore-file"><i class="fa fa-check"></i><b>5.9</b> .gitignore file</a></li>
<li class="chapter" data-level="5.10" data-path="chap-package.html"><a href="chap-package.html#sec:package-ci5"><i class="fa fa-check"></i><b>5.10</b> Continuous integration</a></li>
<li class="chapter" data-level="5.11" data-path="chap-package.html"><a href="chap-package.html#sec:package-cran"><i class="fa fa-check"></i><b>5.11</b> CRAN</a>
<ul>
<li class="chapter" data-level="5.11.1" data-path="chap-package.html"><a href="chap-package.html#testing-the-package"><i class="fa fa-check"></i><b>5.11.1</b> Testing the package</a></li>
<li class="chapter" data-level="5.11.2" data-path="chap-package.html"><a href="chap-package.html#submission"><i class="fa fa-check"></i><b>5.11.2</b> Submission</a></li>
<li class="chapter" data-level="5.11.3" data-path="chap-package.html"><a href="chap-package.html#maintenance"><i class="fa fa-check"></i><b>5.11.3</b> Maintenance</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="chap-ci.html"><a href="chap-ci.html"><i class="fa fa-check"></i><b>6</b> Continuous integration</a>
<ul>
<li class="chapter" data-level="6.1" data-path="chap-ci.html"><a href="chap-ci.html#tools"><i class="fa fa-check"></i><b>6.1</b> Tools</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="chap-ci.html"><a href="chap-ci.html#github-actions"><i class="fa fa-check"></i><b>6.1.1</b> GitHub Actions</a></li>
<li class="chapter" data-level="6.1.2" data-path="chap-ci.html"><a href="chap-ci.html#codecov"><i class="fa fa-check"></i><b>6.1.2</b> Codecov</a></li>
<li class="chapter" data-level="6.1.3" data-path="chap-ci.html"><a href="chap-ci.html#github-pages"><i class="fa fa-check"></i><b>6.1.3</b> GitHub Pages</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="chap-ci.html"><a href="chap-ci.html#principles"><i class="fa fa-check"></i><b>6.2</b> Principles</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="chap-ci.html"><a href="chap-ci.html#getting-a-personal-access-token"><i class="fa fa-check"></i><b>6.2.1</b> Getting a personal access token</a></li>
<li class="chapter" data-level="6.2.2" data-path="chap-ci.html"><a href="chap-ci.html#sec:secrets-ci"><i class="fa fa-check"></i><b>6.2.2</b> Project secrets</a></li>
<li class="chapter" data-level="6.2.3" data-path="chap-ci.html"><a href="chap-ci.html#activation-of-the-repository-on-codecov"><i class="fa fa-check"></i><b>6.2.3</b> Activation of the repository on CodeCov</a></li>
<li class="chapter" data-level="6.2.4" data-path="chap-ci.html"><a href="chap-ci.html#scripting-github-actions"><i class="fa fa-check"></i><b>6.2.4</b> Scripting GitHub actions</a></li>
<li class="chapter" data-level="6.2.5" data-path="chap-ci.html"><a href="chap-ci.html#sec:confidentielCI"><i class="fa fa-check"></i><b>6.2.5</b> Confidential data in a public repository</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="chap-ci.html"><a href="chap-ci.html#script-templates"><i class="fa fa-check"></i><b>6.3</b> Script templates</a>
<ul>
<li class="chapter" data-level="6.3.1" data-path="chap-ci.html"><a href="chap-ci.html#sec:memoiR-ci"><i class="fa fa-check"></i><b>6.3.1</b> memoiR</a></li>
<li class="chapter" data-level="6.3.2" data-path="chap-ci.html"><a href="chap-ci.html#sec:bookdown-ci"><i class="fa fa-check"></i><b>6.3.2</b> Book or thesis</a></li>
<li class="chapter" data-level="6.3.3" data-path="chap-ci.html"><a href="chap-ci.html#articles-or-slideshows"><i class="fa fa-check"></i><b>6.3.3</b> Articles or slideshows</a></li>
<li class="chapter" data-level="6.3.4" data-path="chap-ci.html"><a href="chap-ci.html#sec:blogdown-ci"><i class="fa fa-check"></i><b>6.3.4</b> Blogdown website</a></li>
<li class="chapter" data-level="6.3.5" data-path="chap-ci.html"><a href="chap-ci.html#sec:package-ci6"><i class="fa fa-check"></i><b>6.3.5</b> R Packages</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="chap-ci.html"><a href="chap-ci.html#sec:ci-badges"><i class="fa fa-check"></i><b>6.4</b> Add badges</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="chap-shiny.html"><a href="chap-shiny.html"><i class="fa fa-check"></i><b>7</b> Shiny</a>
<ul>
<li class="chapter" data-level="7.1" data-path="chap-shiny.html"><a href="chap-shiny.html#first-application"><i class="fa fa-check"></i><b>7.1</b> First application</a></li>
<li class="chapter" data-level="7.2" data-path="chap-shiny.html"><a href="chap-shiny.html#more-elaborate-application"><i class="fa fa-check"></i><b>7.2</b> More elaborate application</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="chap-shiny.html"><a href="chap-shiny.html#working-method"><i class="fa fa-check"></i><b>7.2.1</b> Working method</a></li>
<li class="chapter" data-level="7.2.2" data-path="chap-shiny.html"><a href="chap-shiny.html#example"><i class="fa fa-check"></i><b>7.2.2</b> Example</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="chap-shiny.html"><a href="chap-shiny.html#sec:hebergement-shiny"><i class="fa fa-check"></i><b>7.3</b> Hosting</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="chap-enseigner.html"><a href="chap-enseigner.html"><i class="fa fa-check"></i><b>8</b> Teaching with R</a>
<ul>
<li class="chapter" data-level="8.1" data-path="chap-enseigner.html"><a href="chap-enseigner.html#learnr"><i class="fa fa-check"></i><b>8.1</b> learnr</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="chap-enseigner.html"><a href="chap-enseigner.html#first-tutorial"><i class="fa fa-check"></i><b>8.1.1</b> First tutorial</a></li>
<li class="chapter" data-level="8.1.2" data-path="chap-enseigner.html"><a href="chap-enseigner.html#broadcasting"><i class="fa fa-check"></i><b>8.1.2</b> Broadcasting</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="chap-enseigner.html"><a href="chap-enseigner.html#github-classrooms"><i class="fa fa-check"></i><b>8.2</b> GitHub Classrooms</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="chap-enseigner.html"><a href="chap-enseigner.html#registration"><i class="fa fa-check"></i><b>8.2.1</b> Registration</a></li>
<li class="chapter" data-level="8.2.2" data-path="chap-enseigner.html"><a href="chap-enseigner.html#organizations"><i class="fa fa-check"></i><b>8.2.2</b> Organizations</a></li>
<li class="chapter" data-level="8.2.3" data-path="chap-enseigner.html"><a href="chap-enseigner.html#new-classroom"><i class="fa fa-check"></i><b>8.2.3</b> New Classroom</a></li>
<li class="chapter" data-level="8.2.4" data-path="chap-enseigner.html"><a href="chap-enseigner.html#prepare-a-repository-template"><i class="fa fa-check"></i><b>8.2.4</b> Prepare a repository template</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="chap-conclusion.html"><a href="chap-conclusion.html"><i class="fa fa-check"></i><b>9</b> Conclusion</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li>
  <a href="https://github.com/EricMarcon/WorkingWithR" target="blank">
    Hosted on GitHub, published with bookdown
  </a>
</li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Working with R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="chap-utiliseR" class="section level1 hasAnchor" number="2">
<h1><span class="header-section-number">2</span> Use R<a href="chap-utiliseR.html#chap-utiliseR" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>The literature devoted to learning R is flourishing.
The following books are an arbitrary selection but useful for progress:</p>
<ul>
<li><a href="https://r4ds.had.co.nz/">R for Data Science</a> <span class="citation">(<a href="#ref-Wickham2016" role="doc-biblioref">Wickham and Grolemund 2016</a>)</span> presents a complete working method, consistent with the tidyverse.</li>
<li><a href="http://adv-r.had.co.nz/">Advanced R</a> <span class="citation">(<a href="#ref-Wickham2014" role="doc-biblioref">Wickham 2014</a>)</span> is the reference for mastering the subtleties of the language and understanding how R works.</li>
<li>Finally, <a href="https://csgillespie.github.io/efficientR/">Efficient R programming</a> <span class="citation">(<a href="#ref-Gillespie2016" role="doc-biblioref">Gillespie and Lovelace 2016</a>)</span> deals with code optimization.</li>
</ul>
<p>Some advanced aspects of coding are seen here.
Details on the different languages of R are useful for creating packages.
The environments are presented next, for the proper understanding of the search for objects called by the code.
Finally, the optimization of code performance is discussed in detail (loops, C++ code and parallelization) and illustrated by a case study.</p>
<div id="the-languages-of-r" class="section level2 hasAnchor" number="2.1">
<h2><span class="header-section-number">2.1</span> The languages of R<a href="chap-utiliseR.html#the-languages-of-r" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>R includes several programming languages.
The most common is S3, but it is not the only one<a href="#fn17" class="footnote-ref" id="fnref17"><sup>17</sup></a>.</p>
<div id="base" class="section level3 hasAnchor" number="2.1.1">
<h3><span class="header-section-number">2.1.1</span> Base<a href="chap-utiliseR.html#base" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The core of R is the primitive functions and basic data structures like the <code>sum</code> function and <code>matrix</code> data:</p>
<p></p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="chap-utiliseR.html#cb18-1" aria-hidden="true" tabindex="-1"></a>pryr<span class="sc">::</span><span class="fu">otype</span>(sum)</span></code></pre></div>
<pre><code>## [1] &quot;base&quot;</code></pre>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="chap-utiliseR.html#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">typeof</span>(sum)</span></code></pre></div>
<pre><code>## [1] &quot;builtin&quot;</code></pre>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="chap-utiliseR.html#cb22-1" aria-hidden="true" tabindex="-1"></a>pryr<span class="sc">::</span><span class="fu">otype</span>(<span class="fu">matrix</span>(<span class="dv">1</span>))</span></code></pre></div>
<pre><code>## [1] &quot;base&quot;</code></pre>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="chap-utiliseR.html#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">typeof</span>(<span class="fu">matrix</span>(<span class="dv">1</span>))</span></code></pre></div>
<pre><code>## [1] &quot;double&quot;</code></pre>
<p></p>
<p>The <strong>pryr</strong> package allows to display the language in which objects are defined.
The <code>typeof()</code> function displays the internal storage type of the objects:</p>
<ul>
<li><code>sum()</code> function belongs to the basic language of R and is a builtin function;</li>
<li>the elements of the numerical matrix containing a single 1 are double precision reals, and the matrix itself is defined in the basic language.</li>
</ul>
<p>Primitive functions are coded in C and are very fast.
They are always available, whatever the packages loaded.
Their use is therefore to be preferred.</p>
</div>
<div id="sec:S3" class="section level3 hasAnchor" number="2.1.2">
<h3><span class="header-section-number">2.1.2</span> S3<a href="chap-utiliseR.html#sec:S3" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>S3 is the most used language, often the only one known by R users.</p>
<p>It is an object-oriented language in which classes, i.e. the type of objects, are declarative.</p>
<p></p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="chap-utiliseR.html#cb26-1" aria-hidden="true" tabindex="-1"></a>MyFirstName <span class="ot">&lt;-</span> <span class="st">&quot;Eric&quot;</span></span>
<span id="cb26-2"><a href="chap-utiliseR.html#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(MyFirstName) <span class="ot">&lt;-</span> <span class="st">&quot;FirstName&quot;</span></span></code></pre></div>
<p></p>
<p>The variable <code>MyFirstName</code> is here classed as <code>FirstName</code> by a simple declaration.</p>
<p>Unlike the way a classical object-oriented language works<a href="#fn18" class="footnote-ref" id="fnref18"><sup>18</sup></a>, S3 methods are related to functions, not objects.</p>
<p></p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="chap-utiliseR.html#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Default display</span></span>
<span id="cb27-2"><a href="chap-utiliseR.html#cb27-2" aria-hidden="true" tabindex="-1"></a>MyFirstName</span></code></pre></div>
<pre><code>## [1] &quot;Eric&quot;
## attr(,&quot;class&quot;)
## [1] &quot;FirstName&quot;</code></pre>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="chap-utiliseR.html#cb29-1" aria-hidden="true" tabindex="-1"></a>print.Firstname <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">cat</span>(<span class="st">&quot;The first name is&quot;</span>, x)</span>
<span id="cb29-2"><a href="chap-utiliseR.html#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Modified display</span></span>
<span id="cb29-3"><a href="chap-utiliseR.html#cb29-3" aria-hidden="true" tabindex="-1"></a>MyFirstName</span></code></pre></div>
<pre><code>## [1] &quot;Eric&quot;
## attr(,&quot;class&quot;)
## [1] &quot;FirstName&quot;</code></pre>
<p></p>
<p>In this example, the <code>print()</code> method applied to the “Firstname” class is modified.
In a classical object-oriented language, the method would be defined in the class <code>Firstname</code>.
In R, methods are defined from generic methods.</p>
<p>print` is a generic method (“a generic”) declared in <strong>base</strong>.</p>
<p></p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="chap-utiliseR.html#cb31-1" aria-hidden="true" tabindex="-1"></a>pryr<span class="sc">::</span><span class="fu">otype</span>(print)</span></code></pre></div>
<pre><code>## [1] &quot;base&quot;</code></pre>
<p></p>
<p>Its code is just a <code>UseMethod("print")</code> declaration:</p>
<p></p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="chap-utiliseR.html#cb33-1" aria-hidden="true" tabindex="-1"></a>print</span></code></pre></div>
<pre><code>## function (x, ...) 
## UseMethod(&quot;print&quot;)
## &lt;bytecode: 0x7ff5a19c7678&gt;
## &lt;environment: namespace:base&gt;</code></pre>
<p></p>
<p>There are many S3 methods for <code>print</code>:</p>
<p></p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="chap-utiliseR.html#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">methods</span>(<span class="st">&quot;print&quot;</span>))</span></code></pre></div>
<pre><code>## [1] &quot;print.acf&quot;      &quot;print.AES&quot;      &quot;print.all_vars&quot;
## [4] &quot;print.anova&quot;    &quot;print.any_vars&quot; &quot;print.aov&quot;</code></pre>
<p></p>
<p>Each applies to a class. <code>print.default</code> is used as a last resort and relies on the type of the object, not its S3 class.</p>
<p></p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="chap-utiliseR.html#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">typeof</span>(MyFirstName)</span></code></pre></div>
<pre><code>## [1] &quot;character&quot;</code></pre>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="chap-utiliseR.html#cb39-1" aria-hidden="true" tabindex="-1"></a>pryr<span class="sc">::</span><span class="fu">otype</span>(MyFirstName)</span></code></pre></div>
<pre><code>## [1] &quot;S3&quot;</code></pre>
<p></p>
<p>An object can belong to several classes, which allows a form of inheritance of methods.
In a classical object oriented language, inheritance allows to define more precise classes (“FrenchFirstName”) which inherit from more general classes (“Prenom”) and thus benefit from their methods without having to redefine them.
In R, inheritance is simply declaring a vector of increasingly broad classes for an object:</p>
<p></p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="chap-utiliseR.html#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Definition of classes by a vector</span></span>
<span id="cb41-2"><a href="chap-utiliseR.html#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(MyFirstName) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;FrenchFirstName&quot;</span>, <span class="st">&quot;FirstName&quot;</span>)</span>
<span id="cb41-3"><a href="chap-utiliseR.html#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Alternative code, with inherits()</span></span>
<span id="cb41-4"><a href="chap-utiliseR.html#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="fu">inherits</span>(MyFirstName, <span class="at">what =</span> <span class="st">&quot;FrenchFirstName&quot;</span>)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="chap-utiliseR.html#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">inherits</span>(MyFirstName, <span class="at">what =</span> <span class="st">&quot;FirstName&quot;</span>)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p></p>
<p>The generic looks for a method for each class, in the order of their declaration.</p>
<p></p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="chap-utiliseR.html#cb45-1" aria-hidden="true" tabindex="-1"></a>print.FrenchFirstName <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">cat</span>(<span class="st">&quot;French first name:&quot;</span>,</span>
<span id="cb45-2"><a href="chap-utiliseR.html#cb45-2" aria-hidden="true" tabindex="-1"></a>    x)</span>
<span id="cb45-3"><a href="chap-utiliseR.html#cb45-3" aria-hidden="true" tabindex="-1"></a>MyFirstName</span></code></pre></div>
<pre><code>## French first name: Eric</code></pre>
<p></p>
<p>In summary, S3 is the common language of R.
Almost all packages are written in S3.
Generics are everywhere but go unnoticed, for example in packages:</p>
<p></p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="chap-utiliseR.html#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;entropart&quot;</span>)</span>
<span id="cb47-2"><a href="chap-utiliseR.html#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="fu">.S3methods</span>(<span class="at">class =</span> <span class="st">&quot;SpeciesDistribution&quot;</span>)</span></code></pre></div>
<pre><code>## [1] autoplot plot    
## see &#39;?methods&#39; for accessing help and source code</code></pre>
<p></p>
<p>The <code>.S3methods()</code> function displays all available methods for a class, as opposed to <code>methods()</code> which displays all classes for which the method passed as an argument is defined.</p>
<p>Many primitive functions in R are generic methods.
To find out about them, use the <code>help(InternalMethods)</code> helper.</p>
</div>
<div id="s4" class="section level3 hasAnchor" number="2.1.3">
<h3><span class="header-section-number">2.1.3</span> S4<a href="chap-utiliseR.html#s4" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>S4 is an evolution of S3 that structures classes to get closer to a classical object oriented language:</p>
<ul>
<li>classes must be explicitly defined, not simply declared;</li>
<li>attributes (i.e. variables describing objects), called <em>slots</em>, are explicitly declared;</li>
<li>the constructor, i.e. the method that creates a new instance of a class (i.e. a variable containing an object of the class), is explicit.</li>
</ul>
<p>Using the previous example, the S4 syntax is as follows:</p>
<p></p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="chap-utiliseR.html#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Definition of the class Person, with its slots</span></span>
<span id="cb49-2"><a href="chap-utiliseR.html#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="fu">setClass</span>(<span class="st">&quot;Person&quot;</span>,  </span>
<span id="cb49-3"><a href="chap-utiliseR.html#cb49-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">slots =</span> <span class="fu">list</span>(<span class="at">LastName =</span> <span class="st">&quot;character&quot;</span>, <span class="at">FirstName =</span> <span class="st">&quot;character&quot;</span>))</span>
<span id="cb49-4"><a href="chap-utiliseR.html#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="co">#  Construction of an instance</span></span>
<span id="cb49-5"><a href="chap-utiliseR.html#cb49-5" aria-hidden="true" tabindex="-1"></a>Me <span class="ot">&lt;-</span> <span class="fu">new</span>(<span class="st">&quot;Person&quot;</span>, <span class="at">LastName =</span> <span class="st">&quot;Marcon&quot;</span>, <span class="at">FirstName =</span> <span class="st">&quot;Eric&quot;</span>)</span>
<span id="cb49-6"><a href="chap-utiliseR.html#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Langage</span></span>
<span id="cb49-7"><a href="chap-utiliseR.html#cb49-7" aria-hidden="true" tabindex="-1"></a>pryr<span class="sc">::</span><span class="fu">otype</span>(Me)</span></code></pre></div>
<pre><code>## [1] &quot;S4&quot;</code></pre>
<p></p>
<p>Methods always belong to functions.
They are declared by the <code>setMethod()</code> function:</p>
<p></p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="chap-utiliseR.html#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">setMethod</span>(<span class="st">&quot;print&quot;</span>, <span class="at">signature =</span> <span class="st">&quot;Person&quot;</span>, <span class="cf">function</span>(x, ...) {</span>
<span id="cb51-2"><a href="chap-utiliseR.html#cb51-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">&quot;The person is:&quot;</span>, x<span class="sc">@</span>FirstName, x<span class="sc">@</span>LastName)</span>
<span id="cb51-3"><a href="chap-utiliseR.html#cb51-3" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb51-4"><a href="chap-utiliseR.html#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(Me)</span></code></pre></div>
<pre><code>## The person is: Eric Marcon</code></pre>
<p></p>
<p>The attributes are called by the syntax <code>variable@slot</code>.</p>
<p>In summary, S4 is more rigorous than S3.
Some packages on CRAN : <strong>Matrix</strong>, <strong>sp</strong>, <strong>odbc</strong>… and many on Bioconductor are written in S4 but the language is now clearly abandoned in favor of S3, notably because of the success of the <strong>tidyverse</strong>.</p>
</div>
<div id="rc" class="section level3 hasAnchor" number="2.1.4">
<h3><span class="header-section-number">2.1.4</span> RC<a href="chap-utiliseR.html#rc" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>RC was introduced in R 2.12 (2010) with the <strong>methods</strong> package.</p>
<p>Methods belong to classes, as in C++: they are declared in the class and called from the objects.</p>
<p></p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="chap-utiliseR.html#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;methods&quot;</span>)</span>
<span id="cb53-2"><a href="chap-utiliseR.html#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Declaration of the class</span></span>
<span id="cb53-3"><a href="chap-utiliseR.html#cb53-3" aria-hidden="true" tabindex="-1"></a>PersonRC <span class="ot">&lt;-</span> <span class="fu">setRefClass</span>(<span class="st">&quot;PersonRC&quot;</span>, </span>
<span id="cb53-4"><a href="chap-utiliseR.html#cb53-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">fields =</span> <span class="fu">list</span>(<span class="at">LastName =</span> <span class="st">&quot;character&quot;</span>, <span class="at">FirstName =</span> <span class="st">&quot;character&quot;</span>),</span>
<span id="cb53-5"><a href="chap-utiliseR.html#cb53-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">methods =</span> <span class="fu">list</span>(<span class="at">print =</span> <span class="cf">function</span>() <span class="fu">cat</span>(FirstName, LastName)))</span>
<span id="cb53-6"><a href="chap-utiliseR.html#cb53-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Constructeur</span></span>
<span id="cb53-7"><a href="chap-utiliseR.html#cb53-7" aria-hidden="true" tabindex="-1"></a>MeRC <span class="ot">&lt;-</span> <span class="fu">new</span>(<span class="st">&quot;PersonRC&quot;</span>, <span class="at">LastName =</span> <span class="st">&quot;Marcon&quot;</span>, <span class="at">FirstName =</span><span class="st">&quot;Eric&quot;</span>)</span>
<span id="cb53-8"><a href="chap-utiliseR.html#cb53-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Language</span></span>
<span id="cb53-9"><a href="chap-utiliseR.html#cb53-9" aria-hidden="true" tabindex="-1"></a>pryr<span class="sc">::</span><span class="fu">otype</span>(MeRC)</span></code></pre></div>
<pre><code>## [1] &quot;RC&quot;</code></pre>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="chap-utiliseR.html#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Call the print method</span></span>
<span id="cb55-2"><a href="chap-utiliseR.html#cb55-2" aria-hidden="true" tabindex="-1"></a>MeRC<span class="sc">$</span><span class="fu">print</span>()</span></code></pre></div>
<pre><code>## Eric Marcon</code></pre>
<p></p>
<p>RC is a confidential language, although it is the first “true” object-oriented language of R.</p>
</div>
<div id="s6" class="section level3 hasAnchor" number="2.1.5">
<h3><span class="header-section-number">2.1.5</span> S6<a href="chap-utiliseR.html#s6" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>S6<a href="#fn19" class="footnote-ref" id="fnref19"><sup>19</sup></a> enhances RC but is not included in R: it requires installing its package.</p>
<p>Attributes and methods can be public or private.
An <code>initialize()</code> method is used as a constructor.</p>
<p></p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="chap-utiliseR.html#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(R6)</span>
<span id="cb57-2"><a href="chap-utiliseR.html#cb57-2" aria-hidden="true" tabindex="-1"></a>PersonR6 <span class="ot">&lt;-</span> <span class="fu">R6Class</span>(<span class="st">&quot;PersonR6&quot;</span>, <span class="at">public =</span> <span class="fu">list</span>(<span class="at">LastName =</span> <span class="st">&quot;character&quot;</span>,</span>
<span id="cb57-3"><a href="chap-utiliseR.html#cb57-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">FirstName =</span> <span class="st">&quot;character&quot;</span>, <span class="at">initialize =</span> <span class="cf">function</span>(<span class="at">LastName =</span> <span class="cn">NA</span>,</span>
<span id="cb57-4"><a href="chap-utiliseR.html#cb57-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">FirstName =</span> <span class="cn">NA</span>) {</span>
<span id="cb57-5"><a href="chap-utiliseR.html#cb57-5" aria-hidden="true" tabindex="-1"></a>        self<span class="sc">$</span>LastName <span class="ot">&lt;-</span> LastName</span>
<span id="cb57-6"><a href="chap-utiliseR.html#cb57-6" aria-hidden="true" tabindex="-1"></a>        self<span class="sc">$</span>FirstName <span class="ot">&lt;-</span> FirstName</span>
<span id="cb57-7"><a href="chap-utiliseR.html#cb57-7" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">print =</span> <span class="cf">function</span>() <span class="fu">cat</span>(self<span class="sc">$</span>FirstName, self<span class="sc">$</span>LastName)))</span>
<span id="cb57-8"><a href="chap-utiliseR.html#cb57-8" aria-hidden="true" tabindex="-1"></a>MeR6 <span class="ot">&lt;-</span> PersonR6<span class="sc">$</span><span class="fu">new</span>(<span class="at">LastName =</span> <span class="st">&quot;Marcon&quot;</span>, <span class="at">FirstName =</span> <span class="st">&quot;Eric&quot;</span>)</span>
<span id="cb57-9"><a href="chap-utiliseR.html#cb57-9" aria-hidden="true" tabindex="-1"></a>MeR6<span class="sc">$</span><span class="fu">print</span>()</span></code></pre></div>
<pre><code>## Eric Marcon</code></pre>
<p></p>
<p>S6 allows to program rigorously in object but is very little used.
The performances of S6 are much better than those of RC but are inferior to those of S3<a href="#fn20" class="footnote-ref" id="fnref20"><sup>20</sup></a>.</p>
<p>The non-inclusion of R6 to R is shown by <strong>pryr</strong>:</p>
<p></p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="chap-utiliseR.html#cb59-1" aria-hidden="true" tabindex="-1"></a>pryr<span class="sc">::</span><span class="fu">otype</span>(MeR6)</span></code></pre></div>
<pre><code>## [1] &quot;S3&quot;</code></pre>
<p></p>
</div>
<div id="tidyverse" class="section level3 hasAnchor" number="2.1.6">
<h3><span class="header-section-number">2.1.6</span> Tidyverse<a href="chap-utiliseR.html#tidyverse" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The tidyverse is a set of coherent packages that have evolved the way R is programmed.
The set of essential packages can be loaded by the <strong>tidyverse</strong> package which has no other use:</p>
<p></p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="chap-utiliseR.html#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;tidyverse&quot;</span>)</span></code></pre></div>
<p></p>
<p>This is not a new language per se but rather an extension of S3, with deep technical modifications, notably the unconventional evaluation of expressions<a href="#fn21" class="footnote-ref" id="fnref21"><sup>21</sup></a>, which it is not essential to master in detail.</p>
<p>Its principles are written in a manifesto<a href="#fn22" class="footnote-ref" id="fnref22"><sup>22</sup></a>.
Its most visible contribution for the user is the sequence of commands in a flow (code pipeline).</p>
<p>In standard programming, the sequence of functions is written by successive nesting, which makes it difficult to read, especially when arguments are needed:</p>
<p></p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="chap-utiliseR.html#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Base-2 logarithm of the mean of 100 random numbers in a</span></span>
<span id="cb62-2"><a href="chap-utiliseR.html#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="co"># uniform distribution</span></span>
<span id="cb62-3"><a href="chap-utiliseR.html#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="fu">log</span>(<span class="fu">mean</span>(<span class="fu">runif</span>(<span class="dv">100</span>)), <span class="at">base =</span> <span class="dv">2</span>)</span></code></pre></div>
<pre><code>## [1] -1.127903</code></pre>
<p></p>
<p>In the tidyverse, the functions are chained together, which often better matches the programmer’s thinking about data processing:</p>
<p></p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="chap-utiliseR.html#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 100 random numbers in a uniform distribution</span></span>
<span id="cb64-2"><a href="chap-utiliseR.html#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="fu">runif</span>(<span class="dv">100</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb64-3"><a href="chap-utiliseR.html#cb64-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Mean</span></span>
<span id="cb64-4"><a href="chap-utiliseR.html#cb64-4" aria-hidden="true" tabindex="-1"></a>  mean <span class="sc">%&gt;%</span> </span>
<span id="cb64-5"><a href="chap-utiliseR.html#cb64-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Base-2 logarithm</span></span>
<span id="cb64-6"><a href="chap-utiliseR.html#cb64-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">log</span>(<span class="at">base=</span><span class="dv">2</span>)</span></code></pre></div>
<pre><code>## [1] -0.9772102</code></pre>
<p></p>
<p>The pipe <code>%&gt;%</code> is an operator that calls the next function by passing it as first argument the result of the previous function.
Additional arguments are passed normally: for the readability of the code, it is essential to name them.
Most of the R functions can be used without difficulty in the tidyverse, even though they were not designed for this purpose: it is sufficient that their first argument is the data to be processed.</p>
<p>The pipeline allows only one value to be passed to the next function, which prohibits multidimensional functions, such as <code>f(x,y)</code>.
The preferred data structure is the <em>tibble</em>, which is an improved dataframe: its <code>print()</code> method is more readable, and it corrects some unintuitive dataframe behavior, such as the automatic conversion of single-column dataframes to vectors.
The columns of the dataframe or tibble allow to pass as much data as needed.</p>
<p>Finally, data visualization is supported by <strong>ggplot2</strong> which relies on a theoretically sound graph grammar <span class="citation">(<a href="#ref-Wickham2010" role="doc-biblioref">Wickham 2010</a>)</span>.
Schematically, a graph is constructed according to the following model:</p>
<pre><code>ggplot(data = &lt;DATA&gt;) + 
  &lt;GEOM_FUNCTION&gt;(
     mapping = aes(&lt;MAPPINGS&gt;),
     stat = &lt;STAT&gt;, 
     position = &lt;POSITION&gt;
  ) +
  &lt;COORDINATE_FUNCTION&gt; +
  &lt;FACET_FUNCTION&gt;</code></pre>
<ul>
<li>the data is necessarily a dataframe;</li>
<li>the geometry is the type of graph chosen (points, lines, histograms or other);</li>
<li>the aesthetics (function <code>aes()</code>) designates what is represented: it is the correspondence between the columns of the dataframe and the elements necessary for the geometry;</li>
<li>statistics is the treatment applied to the data before passing it to the geometry (often “identity”, i.e. no transformation but “boxplot” for a moustache box).
The data can be transformed by a scale function, such as <code>scale_y_log10()</code>;</li>
<li>the position is the location of the objects on the graph (often “identity”; “stack” for a stacked histogram, “jitter” to move the overlapping points slightly in a <code>geom_point</code>);</li>
<li>the coordinates define the display of the graph (<code>coord_fixed()</code> to avoid distorting a map for example);</li>
<li>finally, the facets offer the possibility to display several aspects of the same data by producing one graph per modality of a variable.</li>
</ul>
<p>The set formed by the pipeline and <strong>ggplot2</strong> allows complex processing in a readable code.
Figure <a href="chap-utiliseR.html#fig:diamonds">2.1</a> shows the result of the following code:</p>

<p></p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="chap-utiliseR.html#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Diamonds data provided by ggplot2</span></span>
<span id="cb67-2"><a href="chap-utiliseR.html#cb67-2" aria-hidden="true" tabindex="-1"></a>diamonds <span class="sc">%&gt;%</span> </span>
<span id="cb67-3"><a href="chap-utiliseR.html#cb67-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Keep only diamonds larger than half a carat</span></span>
<span id="cb67-4"><a href="chap-utiliseR.html#cb67-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(carat <span class="sc">&gt;</span> <span class="fl">0.5</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb67-5"><a href="chap-utiliseR.html#cb67-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Graph: price vs. weight</span></span>
<span id="cb67-6"><a href="chap-utiliseR.html#cb67-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> carat, <span class="at">y =</span> price)) <span class="sc">+</span></span>
<span id="cb67-7"><a href="chap-utiliseR.html#cb67-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Scatter plot</span></span>
<span id="cb67-8"><a href="chap-utiliseR.html#cb67-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb67-9"><a href="chap-utiliseR.html#cb67-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Logarithmic scale</span></span>
<span id="cb67-10"><a href="chap-utiliseR.html#cb67-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_log10</span>() <span class="sc">+</span> </span>
<span id="cb67-11"><a href="chap-utiliseR.html#cb67-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_log10</span>() <span class="sc">+</span> </span>
<span id="cb67-12"><a href="chap-utiliseR.html#cb67-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Linear regression</span></span>
<span id="cb67-13"><a href="chap-utiliseR.html#cb67-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:diamonds"></span>
<img src="WwR_files/figure-html/diamonds-1.png" alt="Price of diamonds according to their weight. Demonstration of the ggplot2 code combined with tidyverse data processing." width="80%" />
<p class="caption">
Figure 2.1: Price of diamonds according to their weight. Demonstration of the <strong>ggplot2</strong> code combined with tidyverse data processing.
</p>
</div>
<p></p>
<p>In this figure, two geometries (scatterplot and linear regression) share the same aesthetics (price vs. carat weight) which is therefore declared upstream, in the <code>ggplot()</code> function.</p>
<p>The tidyverse is documented in detail in <span class="citation">Wickham and Grolemund (<a href="#ref-Wickham2016" role="doc-biblioref">2016</a>)</span> and <strong>ggplot2</strong> in <span class="citation">Wickham (<a href="#ref-Wickham2017" role="doc-biblioref">2017</a>)</span>.</p>
</div>
</div>
<div id="sec:environnements" class="section level2 hasAnchor" number="2.2">
<h2><span class="header-section-number">2.2</span> Environments<a href="chap-utiliseR.html#sec:environnements" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>R’s objects, data and functions, are named.
Since R is modular, with the ability to add any number of packages to it, it is very likely that name conflicts will arise.
To deal with them, R has a rigorous system of name precedence: code runs in a defined environment, inheriting from parent environments.</p>
<div id="organization" class="section level3 hasAnchor" number="2.2.1">
<h3><span class="header-section-number">2.2.1</span> Organization<a href="chap-utiliseR.html#organization" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>R starts in an empty environment.
Each loaded package creates a child environment to form a stack of environments, of which each new element is called a “child” of the previous one, which is its “parent”.</p>
<p>The console is in the global environment, the child of the last loaded package.</p>
<p></p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="chap-utiliseR.html#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="fu">search</span>()</span></code></pre></div>
<pre><code>##  [1] &quot;.GlobalEnv&quot;         &quot;package:R6&quot;        
##  [3] &quot;package:entropart&quot;  &quot;package:forcats&quot;   
##  [5] &quot;package:stringr&quot;    &quot;package:dplyr&quot;     
##  [7] &quot;package:purrr&quot;      &quot;package:readr&quot;     
##  [9] &quot;package:tidyr&quot;      &quot;package:tibble&quot;    
## [11] &quot;package:ggplot2&quot;    &quot;package:tidyverse&quot; 
## [13] &quot;package:kableExtra&quot; &quot;package:stats&quot;     
## [15] &quot;package:graphics&quot;   &quot;package:grDevices&quot; 
## [17] &quot;package:utils&quot;      &quot;package:datasets&quot;  
## [19] &quot;package:methods&quot;    &quot;Autoloads&quot;         
## [21] &quot;package:base&quot;</code></pre>
<p></p>
<p>The code of a function called from the console runs in a child environment of the global environment:</p>
<p></p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="chap-utiliseR.html#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Current environment</span></span>
<span id="cb70-2"><a href="chap-utiliseR.html#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="fu">environment</span>()</span></code></pre></div>
<pre><code>## &lt;environment: R_GlobalEnv&gt;</code></pre>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="chap-utiliseR.html#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The function f displays its environment</span></span>
<span id="cb72-2"><a href="chap-utiliseR.html#cb72-2" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>() <span class="fu">environment</span>()</span>
<span id="cb72-3"><a href="chap-utiliseR.html#cb72-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the environment of the function</span></span>
<span id="cb72-4"><a href="chap-utiliseR.html#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="fu">f</span>()</span></code></pre></div>
<pre><code>## &lt;environment: 0x7ff5afa46b58&gt;</code></pre>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="chap-utiliseR.html#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Parent environment of the function&#39;s environment</span></span>
<span id="cb74-2"><a href="chap-utiliseR.html#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="fu">parent.env</span>(<span class="fu">f</span>())</span></code></pre></div>
<pre><code>## &lt;environment: R_GlobalEnv&gt;</code></pre>
<p></p>
</div>
<div id="search" class="section level3 hasAnchor" number="2.2.2">
<h3><span class="header-section-number">2.2.2</span> Search<a href="chap-utiliseR.html#search" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The search for objects starts in the local environment.
If it is not found, it is searched in the parent environment, then in the parent of the parent, until the environments are exhausted which generates an error indicating that the object was not found.</p>
<p>Example:</p>
<p></p>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="chap-utiliseR.html#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Variable q defined in the global environment</span></span>
<span id="cb76-2"><a href="chap-utiliseR.html#cb76-2" aria-hidden="true" tabindex="-1"></a>q <span class="ot">&lt;-</span> <span class="st">&quot;GlobalEnv&quot;</span></span>
<span id="cb76-3"><a href="chap-utiliseR.html#cb76-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Function defining q in its environment</span></span>
<span id="cb76-4"><a href="chap-utiliseR.html#cb76-4" aria-hidden="true" tabindex="-1"></a>qLocalFunction <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb76-5"><a href="chap-utiliseR.html#cb76-5" aria-hidden="true" tabindex="-1"></a>    q <span class="ot">&lt;-</span> <span class="st">&quot;Function&quot;</span></span>
<span id="cb76-6"><a href="chap-utiliseR.html#cb76-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(q)</span>
<span id="cb76-7"><a href="chap-utiliseR.html#cb76-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb76-8"><a href="chap-utiliseR.html#cb76-8" aria-hidden="true" tabindex="-1"></a><span class="co"># The local variable is returned</span></span>
<span id="cb76-9"><a href="chap-utiliseR.html#cb76-9" aria-hidden="true" tabindex="-1"></a><span class="fu">qLocalFunction</span>()</span></code></pre></div>
<pre><code>## [1] &quot;Function&quot;</code></pre>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="chap-utiliseR.html#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function (poorly written) using a variable it does not</span></span>
<span id="cb78-2"><a href="chap-utiliseR.html#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="co"># define</span></span>
<span id="cb78-3"><a href="chap-utiliseR.html#cb78-3" aria-hidden="true" tabindex="-1"></a>qGlobalEnv <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb78-4"><a href="chap-utiliseR.html#cb78-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(q)</span>
<span id="cb78-5"><a href="chap-utiliseR.html#cb78-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb78-6"><a href="chap-utiliseR.html#cb78-6" aria-hidden="true" tabindex="-1"></a><span class="co"># The global environment variable is returned</span></span>
<span id="cb78-7"><a href="chap-utiliseR.html#cb78-7" aria-hidden="true" tabindex="-1"></a><span class="fu">qGlobalEnv</span>()</span></code></pre></div>
<pre><code>## [1] &quot;GlobalEnv&quot;</code></pre>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="chap-utiliseR.html#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Delete this variable</span></span>
<span id="cb80-2"><a href="chap-utiliseR.html#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(q)</span>
<span id="cb80-3"><a href="chap-utiliseR.html#cb80-3" aria-hidden="true" tabindex="-1"></a><span class="co"># The function base::q is returned</span></span>
<span id="cb80-4"><a href="chap-utiliseR.html#cb80-4" aria-hidden="true" tabindex="-1"></a><span class="fu">qGlobalEnv</span>()</span></code></pre></div>
<pre><code>## function (save = &quot;default&quot;, status = 0, runLast = TRUE) 
## .Internal(quit(save, status, runLast))
## &lt;bytecode: 0x7ff5b0ab4710&gt;
## &lt;environment: namespace:base&gt;</code></pre>
<p></p>
<p>The variable <code>q</code> is defined in the global environment.
The function <code>qLocalFunction</code> defines its own variable <code>q</code>.
The function call returns the function’s local value because it is in the function’s environment.</p>
<p>The <code>qGlobalEnv</code> function returns the <code>q</code> variable that it does not define locally.
So it looks for it in its parent environment and finds the variable defined in the global environment.
By removing the variable from the global environment with <code>rm(q)</code>, the <code>qGlobalEnv()</code> function scans the stack of environments until it finds an object named <code>q</code> in the <strong>base</strong> package, which is the function to exit R.
It could have found another object if a package containing a <code>q</code> object had been loaded.</p>
<p>To avoid this erratic behavior, a function should <em>never</em> call an object not defined in its own environment.</p>
</div>
<div id="espaces-de-nom-des-packages" class="section level3 hasAnchor" number="2.2.3">
<h3><span class="header-section-number">2.2.3</span> Espaces de nom des packages<a href="chap-utiliseR.html#espaces-de-nom-des-packages" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Package namespaces</p>
<p>It is time to define precisely what packages make visible.
Packages contain objects (functions and data) which they <em>export</em> or not.
They are usually called by the <code>library()</code> function, which does two things:</p>
<ul>
<li>it <em>loads</em> the package into memory, allowing access to all its objects with the syntax <code>package::object</code> for exported objects and <code>package:::object</code> for non-exported ones;</li>
<li>it then <em>attaches</em> the package, which places its environment on top of the stack.</li>
</ul>
<p>It is possible to detach a package with the <code>unloadNamespace()</code> function to remove it from the environment stack.
Example:</p>
<p></p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="chap-utiliseR.html#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># entropart loaded and attached</span></span>
<span id="cb82-2"><a href="chap-utiliseR.html#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;entropart&quot;</span>)</span>
<span id="cb82-3"><a href="chap-utiliseR.html#cb82-3" aria-hidden="true" tabindex="-1"></a><span class="co"># is it attached?</span></span>
<span id="cb82-4"><a href="chap-utiliseR.html#cb82-4" aria-hidden="true" tabindex="-1"></a><span class="fu">isNamespaceLoaded</span>(<span class="st">&quot;entropart&quot;</span>)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="chap-utiliseR.html#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># stack of environments</span></span>
<span id="cb84-2"><a href="chap-utiliseR.html#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="fu">search</span>()</span></code></pre></div>
<pre><code>##  [1] &quot;.GlobalEnv&quot;         &quot;package:R6&quot;        
##  [3] &quot;package:entropart&quot;  &quot;package:forcats&quot;   
##  [5] &quot;package:stringr&quot;    &quot;package:dplyr&quot;     
##  [7] &quot;package:purrr&quot;      &quot;package:readr&quot;     
##  [9] &quot;package:tidyr&quot;      &quot;package:tibble&quot;    
## [11] &quot;package:ggplot2&quot;    &quot;package:tidyverse&quot; 
## [13] &quot;package:kableExtra&quot; &quot;package:stats&quot;     
## [15] &quot;package:graphics&quot;   &quot;package:grDevices&quot; 
## [17] &quot;package:utils&quot;      &quot;package:datasets&quot;  
## [19] &quot;package:methods&quot;    &quot;Autoloads&quot;         
## [21] &quot;package:base&quot;</code></pre>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="chap-utiliseR.html#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Diversity(), a function exported by entropart is found</span></span>
<span id="cb86-2"><a href="chap-utiliseR.html#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="fu">Diversity</span>(<span class="dv">1</span>, <span class="at">CheckArguments =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<pre><code>## None 
##    1</code></pre>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="chap-utiliseR.html#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Detach and unload entropart</span></span>
<span id="cb88-2"><a href="chap-utiliseR.html#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="fu">unloadNamespace</span>(<span class="st">&quot;entropart&quot;</span>)</span>
<span id="cb88-3"><a href="chap-utiliseR.html#cb88-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Is it attached?</span></span>
<span id="cb88-4"><a href="chap-utiliseR.html#cb88-4" aria-hidden="true" tabindex="-1"></a><span class="fu">isNamespaceLoaded</span>(<span class="st">&quot;entropart&quot;</span>)</span></code></pre></div>
<pre><code>## [1] FALSE</code></pre>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="chap-utiliseR.html#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Stack of environments, without entropart</span></span>
<span id="cb90-2"><a href="chap-utiliseR.html#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="fu">search</span>()</span></code></pre></div>
<pre><code>##  [1] &quot;.GlobalEnv&quot;         &quot;package:R6&quot;        
##  [3] &quot;package:forcats&quot;    &quot;package:stringr&quot;   
##  [5] &quot;package:dplyr&quot;      &quot;package:purrr&quot;     
##  [7] &quot;package:readr&quot;      &quot;package:tidyr&quot;     
##  [9] &quot;package:tibble&quot;     &quot;package:ggplot2&quot;   
## [11] &quot;package:tidyverse&quot;  &quot;package:kableExtra&quot;
## [13] &quot;package:stats&quot;      &quot;package:graphics&quot;  
## [15] &quot;package:grDevices&quot;  &quot;package:utils&quot;     
## [17] &quot;package:datasets&quot;   &quot;package:methods&quot;   
## [19] &quot;Autoloads&quot;          &quot;package:base&quot;</code></pre>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="chap-utiliseR.html#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Diversity() cannot be found</span></span>
<span id="cb92-2"><a href="chap-utiliseR.html#cb92-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tryCatch</span>(<span class="fu">Diversity</span>(<span class="dv">1</span>), <span class="at">error =</span> <span class="cf">function</span>(e) <span class="fu">print</span>(e))</span></code></pre></div>
<pre><code>## &lt;simpleError in Diversity(1): could not find function &quot;Diversity&quot;&gt;</code></pre>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="chap-utiliseR.html#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co"># but can be called with its full name</span></span>
<span id="cb94-2"><a href="chap-utiliseR.html#cb94-2" aria-hidden="true" tabindex="-1"></a>entropart<span class="sc">::</span><span class="fu">Diversity</span>(<span class="dv">1</span>, <span class="at">CheckArguments =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<pre><code>## None 
##    1</code></pre>
<p></p>
<p>Calling <code>entropart::Diversity()</code> loads the package (i.e., implicitly executes <code>loadNamespace("entropart")</code>) but does not attach it.</p>
<p>In practice, one should limit the number of attached packages to limit the risk of calling an unwanted function, homonymous to the desired function.
In critical cases, the full name of the function should be used: <code>package::function()</code>.</p>
<p>A common problem is the <code>filter()</code> function of <strong>dplyr</strong>, which is the namesake of the <strong>stats</strong> function.
The <strong>stats</strong> package is usually loaded before <strong>dplyr</strong>, a package in the tidyverse.
Thus, <code>stats::filter()</code> must be called explicitly.</p>
<p>However, the <strong>dplyr</strong> or <strong>tidyverse</strong> package (which attaches all the tidyverse packages) can be loaded systematically by creating a <code>.RProfile</code> at the root of the project containing the command:</p>
<p></p>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="chap-utiliseR.html#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;tidyverse&quot;</span>)</span></code></pre></div>
<p></p>
<p>In this case, <strong>dplyr</strong> is loaded <em>before</em> <strong>stats</strong> so its function is inaccessible.</p>
</div>
</div>
<div id="measuring-execution-time" class="section level2 hasAnchor" number="2.3">
<h2><span class="header-section-number">2.3</span> Measuring execution time<a href="chap-utiliseR.html#measuring-execution-time" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The execution time of long code can be measured very simply by the <code>system.time</code> command.
For very short execution times, it is necessary to repeat the measurement: this is the purpose of the <strong>microbenchmark</strong> package.</p>
<div id="system.time" class="section level3 hasAnchor" number="2.3.1">
<h3><span class="header-section-number">2.3.1</span> system.time<a href="chap-utiliseR.html#system.time" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The function returns the execution time of the code.</p>
<p></p>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="chap-utiliseR.html#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Mean absolute deviation of 1000 values in a uniform</span></span>
<span id="cb97-2"><a href="chap-utiliseR.html#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="co"># distribution, repeated 100 times</span></span>
<span id="cb97-3"><a href="chap-utiliseR.html#cb97-3" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(<span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>) <span class="fu">mad</span>(<span class="fu">runif</span>(<span class="dv">1000</span>)))</span></code></pre></div>
<pre><code>##    user  system elapsed 
##    0.02    0.00    0.02</code></pre>
<p></p>
</div>
<div id="microbenchmark" class="section level3 hasAnchor" number="2.3.2">
<h3><span class="header-section-number">2.3.2</span> microbenchmark<a href="chap-utiliseR.html#microbenchmark" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <strong>microbenchmark</strong> package is the most advanced.</p>
<p>The goal is to compare the speed of computing the square of a vector (or a number) by multiplying it by itself (<span class="math inline">\(x \times x\)</span>) or by raising it to the power of 2 (<span class="math inline">\(x^2\)</span>).</p>
<p></p>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb99-1"><a href="chap-utiliseR.html#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Functions to test</span></span>
<span id="cb99-2"><a href="chap-utiliseR.html#cb99-2" aria-hidden="true" tabindex="-1"></a>f1 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) x <span class="sc">*</span> x</span>
<span id="cb99-3"><a href="chap-utiliseR.html#cb99-3" aria-hidden="true" tabindex="-1"></a>f2 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) x<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb99-4"><a href="chap-utiliseR.html#cb99-4" aria-hidden="true" tabindex="-1"></a>f3 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) x<span class="sc">^</span><span class="fl">2.1</span></span>
<span id="cb99-5"><a href="chap-utiliseR.html#cb99-5" aria-hidden="true" tabindex="-1"></a>f4 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) x<span class="sc">^</span><span class="dv">3</span></span>
<span id="cb99-6"><a href="chap-utiliseR.html#cb99-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialization</span></span>
<span id="cb99-7"><a href="chap-utiliseR.html#cb99-7" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">10000</span>)</span>
<span id="cb99-8"><a href="chap-utiliseR.html#cb99-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Test</span></span>
<span id="cb99-9"><a href="chap-utiliseR.html#cb99-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;microbenchmark&quot;</span>)</span>
<span id="cb99-10"><a href="chap-utiliseR.html#cb99-10" aria-hidden="true" tabindex="-1"></a>(mb <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(<span class="fu">f1</span>(X), <span class="fu">f2</span>(X), <span class="fu">f3</span>(X), <span class="fu">f4</span>(X)))</span></code></pre></div>
<pre><code>## Unit: microseconds
##   expr     min       lq      mean   median       uq
##  f1(X)  40.911  42.7485  58.29117  44.2760  46.7075
##  f2(X)  48.659  50.2035  64.96233  51.7325  53.7270
##  f3(X) 282.466 285.2055 308.81200 292.1070 300.1025
##  f4(X) 413.217 418.0230 446.05368 430.1820 435.2425
##       max neval
##  1266.303   100
##  1228.687   100
##  1457.306   100
##  1814.411   100</code></pre>
<p></p>
<p>The returned table contains the minimum, median, mean, max and first and third quartile times, as well as the number of repetitions.
The median value is to be compared.
The number of repetitions is by default 100, to be modulated (argument <code>times</code>) according to the complexity of the calculation.</p>
<p>The test result, a <code>microbenchmark</code> object, is a raw table of execution times.
The statistical analysis is done by the <code>print</code> and <code>summary</code> methods.
To choose the columns to display, use the following syntax:</p>
<p></p>
<div class="sourceCode" id="cb101"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb101-1"><a href="chap-utiliseR.html#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mb)[, <span class="fu">c</span>(<span class="st">&quot;expr&quot;</span>, <span class="st">&quot;median&quot;</span>)]</span></code></pre></div>
<pre><code>##    expr   median
## 1 f1(X)  44.2760
## 2 f2(X)  51.7325
## 3 f3(X) 292.1070
## 4 f4(X) 430.1820</code></pre>
<p></p>
<p>To make calculations on these results, we must store them in a variable.
To prevent the results from being displayed in the console, the simplest solution is to use the <code>capture.output</code> function by assigning its result to a variable.</p>
<p></p>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="chap-utiliseR.html#cb103-1" aria-hidden="true" tabindex="-1"></a>dummy <span class="ot">&lt;-</span> <span class="fu">capture.output</span>(mbs <span class="ot">&lt;-</span> <span class="fu">summary</span>(mb))</span></code></pre></div>
<p></p>
<p>The previous test is displayed again.</p>
<p></p>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb104-1"><a href="chap-utiliseR.html#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mb)[, <span class="fu">c</span>(<span class="st">&quot;expr&quot;</span>, <span class="st">&quot;median&quot;</span>)]</span></code></pre></div>
<pre><code>##    expr   median
## 1 f1(X)  44.2760
## 2 f2(X)  51.7325
## 3 f3(X) 292.1070
## 4 f4(X) 430.1820</code></pre>
<p></p>
<p>The computation time is about the same between <span class="math inline">\(x \times x\)</span> and <span class="math inline">\(x^2\)</span>.
The power calculation is much longer, especially if the power is not integer, because it requires a logarithm calculation.
The computation of the power 2 is therefore optimized by R to avoid the use of log.</p>
<p>Two graphical representations are available: the violins represent the probability density of the execution time; the boxplots are classical.</p>
<p></p>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb106-1"><a href="chap-utiliseR.html#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;ggplot2&quot;</span>)</span>
<span id="cb106-2"><a href="chap-utiliseR.html#cb106-2" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(mb)</span></code></pre></div>
<p><img src="WwR_files/figure-html/boxplot-1.png" width="80%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="chap-utiliseR.html#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(mb)</span></code></pre></div>
<p><img src="WwR_files/figure-html/boxplot-2.png" width="80%" style="display: block; margin: auto;" /></p>
<p></p>
</div>
<div id="profiling" class="section level3 hasAnchor" number="2.3.3">
<h3><span class="header-section-number">2.3.3</span> Profiling<a href="chap-utiliseR.html#profiling" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><strong>profvis</strong> is RStudio’s profiling tool.</p>
<p>It tracks the execution time of each line of code and the memory used.
The goal is to detect slow code portions that need to be improved.</p>
<p></p>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb108-1"><a href="chap-utiliseR.html#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(profvis)</span>
<span id="cb108-2"><a href="chap-utiliseR.html#cb108-2" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">profvis</span>({</span>
<span id="cb108-3"><a href="chap-utiliseR.html#cb108-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cosine calculations</span></span>
<span id="cb108-4"><a href="chap-utiliseR.html#cb108-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cos</span>(<span class="fu">runif</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">7</span>))</span>
<span id="cb108-5"><a href="chap-utiliseR.html#cb108-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1/2 second pause</span></span>
<span id="cb108-6"><a href="chap-utiliseR.html#cb108-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pause</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb108-7"><a href="chap-utiliseR.html#cb108-7" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb108-8"><a href="chap-utiliseR.html#cb108-8" aria-hidden="true" tabindex="-1"></a>htmlwidgets<span class="sc">::</span><span class="fu">saveWidget</span>(p, <span class="st">&quot;docs/profile.html&quot;</span>)</span></code></pre></div>
<p></p>
<p>The result is an HTML file containing the profiling report<a href="#fn23" class="footnote-ref" id="fnref23"><sup>23</sup></a>.
It can be observed that the time to draw the random numbers is similar to that of the cosine calculation.</p>
<p>Read the complete documentation<a href="#fn24" class="footnote-ref" id="fnref24"><sup>24</sup></a> on the RStudio website.</p>
</div>
</div>
<div id="loops" class="section level2 hasAnchor" number="2.4">
<h2><span class="header-section-number">2.4</span> Loops<a href="chap-utiliseR.html#loops" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The most frequent case of long code to execute is loops: the same code is repeated a large number of times.</p>
<div id="vector-functions" class="section level3 hasAnchor" number="2.4.1">
<h3><span class="header-section-number">2.4.1</span> Vector functions<a href="chap-utiliseR.html#vector-functions" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Most of R’s functions are vector functions: loops are processed internally, extremely fast.
Therefore, you should think in terms of vectors rather than scalars.</p>
<p></p>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb109-1"><a href="chap-utiliseR.html#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Draw two vectors of three random numbers between 0 and 1</span></span>
<span id="cb109-2"><a href="chap-utiliseR.html#cb109-2" aria-hidden="true" tabindex="-1"></a>x1 <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">3</span>)</span>
<span id="cb109-3"><a href="chap-utiliseR.html#cb109-3" aria-hidden="true" tabindex="-1"></a>x2 <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">3</span>)</span>
<span id="cb109-4"><a href="chap-utiliseR.html#cb109-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Square root of the three numbers in x1</span></span>
<span id="cb109-5"><a href="chap-utiliseR.html#cb109-5" aria-hidden="true" tabindex="-1"></a><span class="fu">sqrt</span>(x1)</span></code></pre></div>
<pre><code>## [1] 0.9427738 0.8665204 0.4586981</code></pre>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb111-1"><a href="chap-utiliseR.html#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Respective sums of the three numbers of x1 and x2</span></span>
<span id="cb111-2"><a href="chap-utiliseR.html#cb111-2" aria-hidden="true" tabindex="-1"></a>x1 <span class="sc">+</span> x2</span></code></pre></div>
<pre><code>## [1] 1.6262539 1.6881583 0.9063973</code></pre>
<p></p>
<p>We also have to write vector functions on their first argument.
The function <code>lnq</code> of the package <strong>entropart</strong> returns the distorted logarithm of order <span class="math inline">\(q\)</span> of a number <span class="math inline">\(x\)</span>.</p>
<p></p>
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb113-1"><a href="chap-utiliseR.html#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Code of the function</span></span>
<span id="cb113-2"><a href="chap-utiliseR.html#cb113-2" aria-hidden="true" tabindex="-1"></a>entropart<span class="sc">::</span>lnq</span></code></pre></div>
<pre><code>## function (x, q) 
## {
##     if (q == 1) {
##         return(log(x))
##     }
##     else {
##         Log &lt;- (x^(1 - q) - 1)/(1 - q)
##         Log[x &lt; 0] &lt;- NA
##         return(Log)
##     }
## }
## &lt;bytecode: 0x7ff591fdb510&gt;
## &lt;environment: namespace:entropart&gt;</code></pre>
<p></p>
<p>For a function to be vector, each line of its code must allow the first argument to be treated as a vector.
Here: <code>log(x)</code> and <code>x^</code> are a vector function and operator and the condition <code>[x &lt; 0]</code> also returns a vector.</p>
</div>
<div id="lapply" class="section level3 hasAnchor" number="2.4.2">
<h3><span class="header-section-number">2.4.2</span> lapply<a href="chap-utiliseR.html#lapply" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Code that cannot be written as a vector function requires loops.</p>
<p>lapply()` applies a function to each element of a list.
There are several versions of this function:</p>
<ul>
<li><code>lapply()</code> returns a list (saves the time of rearranging them in an array);</li>
<li><code>sapply()</code> returns a dataframe by collapsing the lists (this is done by the <code>simplify2array()</code> function);</li>
<li><code>vapply()</code> is almost identical but requires that the data type of the result be provided.</li>
</ul>
<p></p>
<div class="sourceCode" id="cb115"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb115-1"><a href="chap-utiliseR.html#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Draw 1000 values in a uniform distribution</span></span>
<span id="cb115-2"><a href="chap-utiliseR.html#cb115-2" aria-hidden="true" tabindex="-1"></a>x1 <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">1000</span>)</span>
<span id="cb115-3"><a href="chap-utiliseR.html#cb115-3" aria-hidden="true" tabindex="-1"></a><span class="co"># The square root can be calculated for the vector or each</span></span>
<span id="cb115-4"><a href="chap-utiliseR.html#cb115-4" aria-hidden="true" tabindex="-1"></a><span class="co"># value</span></span>
<span id="cb115-5"><a href="chap-utiliseR.html#cb115-5" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(<span class="fu">sqrt</span>(x1), <span class="fu">sapply</span>(x1, <span class="at">FUN =</span> sqrt))</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb117"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb117-1"><a href="chap-utiliseR.html#cb117-1" aria-hidden="true" tabindex="-1"></a>mb <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(<span class="fu">sqrt</span>(x1), <span class="fu">lapply</span>(x1, <span class="at">FUN =</span> sqrt), <span class="fu">sapply</span>(x1,</span>
<span id="cb117-2"><a href="chap-utiliseR.html#cb117-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">FUN =</span> sqrt), <span class="fu">vapply</span>(x1, <span class="at">FUN =</span> sqrt, <span class="at">FUN.VALUE =</span> <span class="dv">0</span>))</span>
<span id="cb117-3"><a href="chap-utiliseR.html#cb117-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mb)[, <span class="fu">c</span>(<span class="st">&quot;expr&quot;</span>, <span class="st">&quot;median&quot;</span>)]</span></code></pre></div>
<pre><code>##                                    expr   median
## 1                              sqrt(x1)   4.5920
## 2                lapply(x1, FUN = sqrt) 306.8430
## 3                sapply(x1, FUN = sqrt) 370.5795
## 4 vapply(x1, FUN = sqrt, FUN.VALUE = 0) 302.2140</code></pre>
<p></p>
<p><code>lapply()</code> is much slower than a vector function.
<code>sapply()</code> requires more time for <code>simplify2array()</code>, which must detect how to gather the results.
Finally, <code>vapply()</code> saves the time of determining the data type of the result and allows for faster computation with little effort.</p>
</div>
<div id="for-loops" class="section level3 hasAnchor" number="2.4.3">
<h3><span class="header-section-number">2.4.3</span> For loops<a href="chap-utiliseR.html#for-loops" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Loops are handled by the <code>for</code> function.
They have the reputation of being slow in R because the code inside the loop must be interpreted at each execution.
This is no longer the case since version 3.5 of R: loops are compiled systematically before execution.
The behavior of the just-in-time compiler is defined by the <code>enableJIT</code> function.
The default level is 3: all functions are compiled, and loops in the code are compiled too.</p>
<p>To evaluate the performance gain, the following code removes all automatic compilation, and compares the same loop compiled or not.</p>
<p></p>
<div class="sourceCode" id="cb119"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb119-1"><a href="chap-utiliseR.html#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;compiler&quot;</span>)</span>
<span id="cb119-2"><a href="chap-utiliseR.html#cb119-2" aria-hidden="true" tabindex="-1"></a><span class="co"># No automatic compilation</span></span>
<span id="cb119-3"><a href="chap-utiliseR.html#cb119-3" aria-hidden="true" tabindex="-1"></a><span class="fu">enableJIT</span>(<span class="at">level =</span> <span class="dv">0</span>)</span></code></pre></div>
<pre><code>## [1] 3</code></pre>
<div class="sourceCode" id="cb121"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb121-1"><a href="chap-utiliseR.html#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop to calculate the square root of a vector</span></span>
<span id="cb121-2"><a href="chap-utiliseR.html#cb121-2" aria-hidden="true" tabindex="-1"></a>Loop <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb121-3"><a href="chap-utiliseR.html#cb121-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialization of the result vector, essential</span></span>
<span id="cb121-4"><a href="chap-utiliseR.html#cb121-4" aria-hidden="true" tabindex="-1"></a>    Root <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;numeric&quot;</span>, <span class="at">length =</span> <span class="fu">length</span>(x))</span>
<span id="cb121-5"><a href="chap-utiliseR.html#cb121-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Loop</span></span>
<span id="cb121-6"><a href="chap-utiliseR.html#cb121-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(x)) Root[i] <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(x[i])</span>
<span id="cb121-7"><a href="chap-utiliseR.html#cb121-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(Root)</span>
<span id="cb121-8"><a href="chap-utiliseR.html#cb121-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb121-9"><a href="chap-utiliseR.html#cb121-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Compiled version</span></span>
<span id="cb121-10"><a href="chap-utiliseR.html#cb121-10" aria-hidden="true" tabindex="-1"></a>Loop2 <span class="ot">&lt;-</span> <span class="fu">cmpfun</span>(Loop)</span>
<span id="cb121-11"><a href="chap-utiliseR.html#cb121-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Comparison</span></span>
<span id="cb121-12"><a href="chap-utiliseR.html#cb121-12" aria-hidden="true" tabindex="-1"></a>mb <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(<span class="fu">Loop</span>(x1), <span class="fu">Loop2</span>(x1))</span>
<span id="cb121-13"><a href="chap-utiliseR.html#cb121-13" aria-hidden="true" tabindex="-1"></a>(mbs <span class="ot">&lt;-</span> <span class="fu">summary</span>(mb)[, <span class="fu">c</span>(<span class="st">&quot;expr&quot;</span>, <span class="st">&quot;median&quot;</span>)])</span></code></pre></div>
<pre><code>##        expr   median
## 1  Loop(x1) 808.5165
## 2 Loop2(x1)  78.0250</code></pre>
<div class="sourceCode" id="cb123"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb123-1"><a href="chap-utiliseR.html#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Automatic compilation by default since version 3.5</span></span>
<span id="cb123-2"><a href="chap-utiliseR.html#cb123-2" aria-hidden="true" tabindex="-1"></a><span class="fu">enableJIT</span>(<span class="at">level =</span> <span class="dv">3</span>)</span></code></pre></div>
<pre><code>## [1] 0</code></pre>
<p></p>
<p>The gain is considerable: from 1 to <code>10</code>.</p>
<p>For loops are now much faster than <code>vapply</code>.</p>
<p></p>
<div class="sourceCode" id="cb125"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb125-1"><a href="chap-utiliseR.html#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Test</span></span>
<span id="cb125-2"><a href="chap-utiliseR.html#cb125-2" aria-hidden="true" tabindex="-1"></a>mb <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(<span class="fu">vapply</span>(x1, <span class="at">FUN =</span> sqrt, <span class="dv">0</span>), <span class="fu">Loop</span>(x1))</span>
<span id="cb125-3"><a href="chap-utiliseR.html#cb125-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mb)[, <span class="fu">c</span>(<span class="st">&quot;expr&quot;</span>, <span class="st">&quot;median&quot;</span>)]</span></code></pre></div>
<pre><code>##                        expr   median
## 1 vapply(x1, FUN = sqrt, 0) 293.1250
## 2                  Loop(x1)  77.6925</code></pre>
<p></p>
<p>Be careful, the performance test can be misleading:</p>
<p></p>
<div class="sourceCode" id="cb127"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb127-1"><a href="chap-utiliseR.html#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Preparing the result vector</span></span>
<span id="cb127-2"><a href="chap-utiliseR.html#cb127-2" aria-hidden="true" tabindex="-1"></a>Root <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;numeric&quot;</span>, <span class="at">length =</span> <span class="fu">length</span>(x1))</span>
<span id="cb127-3"><a href="chap-utiliseR.html#cb127-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Test</span></span>
<span id="cb127-4"><a href="chap-utiliseR.html#cb127-4" aria-hidden="true" tabindex="-1"></a>mb <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(<span class="fu">vapply</span>(x1, <span class="at">FUN =</span> sqrt, <span class="dv">0</span>), </span>
<span id="cb127-5"><a href="chap-utiliseR.html#cb127-5" aria-hidden="true" tabindex="-1"></a>                     <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(x1)) </span>
<span id="cb127-6"><a href="chap-utiliseR.html#cb127-6" aria-hidden="true" tabindex="-1"></a>                       Root[i] <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(x1[i]))</span>
<span id="cb127-7"><a href="chap-utiliseR.html#cb127-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mb)[, <span class="fu">c</span>(<span class="st">&quot;expr&quot;</span>, <span class="st">&quot;median&quot;</span>)]</span></code></pre></div>
<pre><code>##                                             expr   median
## 1                      vapply(x1, FUN = sqrt, 0)  298.640
## 2 for (i in 1:length(x1)) Root[i] &lt;- sqrt(x1[i]) 3336.258</code></pre>
<p></p>
<p>In this code, the for loop is not compiled so it is much slower than in its normal use (in a function or at the top level of the code).</p>
<p>The long loops allow tracking of their progress by a text bar, which is another advantage.
The following function executes pauses of one tenth of a second for the time passed in parameter (in seconds).</p>
<p></p>
<div class="sourceCode" id="cb129"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb129-1"><a href="chap-utiliseR.html#cb129-1" aria-hidden="true" tabindex="-1"></a>MonitoredLoop <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">duration =</span> <span class="dv">1</span>) {</span>
<span id="cb129-2"><a href="chap-utiliseR.html#cb129-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Progress bar</span></span>
<span id="cb129-3"><a href="chap-utiliseR.html#cb129-3" aria-hidden="true" tabindex="-1"></a>    pgb <span class="ot">&lt;-</span> <span class="fu">txtProgressBar</span>(<span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> duration <span class="sc">*</span> <span class="dv">10</span>)</span>
<span id="cb129-4"><a href="chap-utiliseR.html#cb129-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Boucle</span></span>
<span id="cb129-5"><a href="chap-utiliseR.html#cb129-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(duration <span class="sc">*</span> <span class="dv">10</span>)) {</span>
<span id="cb129-6"><a href="chap-utiliseR.html#cb129-6" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pause for a tenth of a second</span></span>
<span id="cb129-7"><a href="chap-utiliseR.html#cb129-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">Sys.sleep</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">10</span>)</span>
<span id="cb129-8"><a href="chap-utiliseR.html#cb129-8" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Track progress</span></span>
<span id="cb129-9"><a href="chap-utiliseR.html#cb129-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">setTxtProgressBar</span>(pgb, i)</span>
<span id="cb129-10"><a href="chap-utiliseR.html#cb129-10" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb129-11"><a href="chap-utiliseR.html#cb129-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb129-12"><a href="chap-utiliseR.html#cb129-12" aria-hidden="true" tabindex="-1"></a><span class="fu">MonitoredLoop</span>()</span></code></pre></div>
<pre><code>## ============================================================</code></pre>
<p></p>
</div>
<div id="replicate" class="section level3 hasAnchor" number="2.4.4">
<h3><span class="header-section-number">2.4.4</span> replicate<a href="chap-utiliseR.html#replicate" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><code>replicate()</code> repeats a statement.</p>
<p></p>
<div class="sourceCode" id="cb131"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb131-1"><a href="chap-utiliseR.html#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="fu">replicate</span>(<span class="dv">3</span>, <span class="fu">runif</span>(<span class="dv">1</span>))</span></code></pre></div>
<pre><code>## [1] 0.9453453 0.5262818 0.7233425</code></pre>
<p></p>
<p>This code is equivalent to <code>runif(3)</code>, with performance similar to <code>vapply</code>: 50 to 100 times slower than a vector function.</p>
<p></p>
<div class="sourceCode" id="cb133"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb133-1"><a href="chap-utiliseR.html#cb133-1" aria-hidden="true" tabindex="-1"></a>mb <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(<span class="fu">replicate</span>(<span class="dv">1000</span>, <span class="fu">runif</span>(<span class="dv">1</span>)), <span class="fu">runif</span>(<span class="dv">1000</span>))</span>
<span id="cb133-2"><a href="chap-utiliseR.html#cb133-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mb)[, <span class="fu">c</span>(<span class="st">&quot;expr&quot;</span>, <span class="st">&quot;median&quot;</span>)]</span></code></pre></div>
<pre><code>##                        expr   median
## 1 replicate(1000, runif(1)) 3522.985
## 2               runif(1000)   34.459</code></pre>
<p></p>
</div>
<div id="vectorize" class="section level3 hasAnchor" number="2.4.5">
<h3><span class="header-section-number">2.4.5</span> Vectorize<a href="chap-utiliseR.html#vectorize" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><code>Vectorize()</code> makes a function that is not vectorized, by loops.
Write the loops instead.</p>
</div>
<div id="marginal-statistics" class="section level3 hasAnchor" number="2.4.6">
<h3><span class="header-section-number">2.4.6</span> Marginal statistics<a href="chap-utiliseR.html#marginal-statistics" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><code>apply</code> applies a function to the rows or columns of a two dimensional object.</p>
<p><code>colSums</code> and similar functions (<code>rowSums</code>, <code>colMeans</code>, <code>rowMeans</code>) are optimized.</p>
<p></p>
<div class="sourceCode" id="cb135"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb135-1"><a href="chap-utiliseR.html#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sum of the numeric columns of the diamonds dataset of ggplot2</span></span>
<span id="cb135-2"><a href="chap-utiliseR.html#cb135-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop identical to the action of apply(, 2, )</span></span>
<span id="cb135-3"><a href="chap-utiliseR.html#cb135-3" aria-hidden="true" tabindex="-1"></a>SumLoop <span class="ot">&lt;-</span> <span class="cf">function</span>(Table) {</span>
<span id="cb135-4"><a href="chap-utiliseR.html#cb135-4" aria-hidden="true" tabindex="-1"></a>  Sum <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;numeric&quot;</span>, <span class="at">length =</span> <span class="fu">ncol</span>(Table))</span>
<span id="cb135-5"><a href="chap-utiliseR.html#cb135-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(Table)) Sum[i] <span class="ot">&lt;-</span> <span class="fu">sum</span>(Table[, i])</span>
<span id="cb135-6"><a href="chap-utiliseR.html#cb135-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(Sum)</span>
<span id="cb135-7"><a href="chap-utiliseR.html#cb135-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb135-8"><a href="chap-utiliseR.html#cb135-8" aria-hidden="true" tabindex="-1"></a>mb <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(<span class="fu">SumLoop</span>(diamonds[<span class="sc">-</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>)]), </span>
<span id="cb135-9"><a href="chap-utiliseR.html#cb135-9" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">apply</span>(diamonds[<span class="sc">-</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>)], <span class="dv">2</span>, sum), </span>
<span id="cb135-10"><a href="chap-utiliseR.html#cb135-10" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">colSums</span>(diamonds[<span class="sc">-</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>)]))</span>
<span id="cb135-11"><a href="chap-utiliseR.html#cb135-11" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mb)[, <span class="fu">c</span>(<span class="st">&quot;expr&quot;</span>, <span class="st">&quot;median&quot;</span>)]</span></code></pre></div>
<pre><code>##                              expr   median
## 1       SumLoop(diamonds[-(2:4)]) 3.667384
## 2 apply(diamonds[-(2:4)], 2, sum) 9.538318
## 3       colSums(diamonds[-(2:4)]) 2.532469</code></pre>
<p></p>
<p><code>apply</code> clarifies the code but is slower than the loop, which is only slightly slower than <code>colSums</code>.</p>
</div>
</div>
<div id="sec:cpp" class="section level2 hasAnchor" number="2.5">
<h2><span class="header-section-number">2.5</span> C++ code<a href="chap-utiliseR.html#sec:cpp" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Integrating C++ code into R is greatly simplified by the <strong>Rcpp</strong> package but is still difficult to debug and therefore should be reserved for very simple code (to avoid errors) and repeated a large number of times (to be worth the effort).
The preparation of the data and their verification must be done in R, as well as the processing and presentation of the results.</p>
<p>The usual use is to include C++ code in a package, but use outside the package is possible:</p>
<ul>
<li>C++ code can be included in a C++ document (file with extension <code>.cpp</code>): it is compiled by the <code>sourceCpp()</code> command, which creates the R functions to call the C++ code.</li>
<li>In an RMarkdown document, Rcpp code snippets can be created to insert the C++ code: they are compiled and interfaced to R at the time of knitting.</li>
</ul>
<p>The following example shows how to create a C++ function to calculate the double of a numerical vector.</p>
<p></p>
<div class="sourceCode" id="cb137"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb137-1"><a href="chap-utiliseR.html#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb137-2"><a href="chap-utiliseR.html#cb137-2" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> Rcpp<span class="op">;</span></span>
<span id="cb137-3"><a href="chap-utiliseR.html#cb137-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-4"><a href="chap-utiliseR.html#cb137-4" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb137-5"><a href="chap-utiliseR.html#cb137-5" aria-hidden="true" tabindex="-1"></a>NumericVector timesTwo<span class="op">(</span>NumericVector x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb137-6"><a href="chap-utiliseR.html#cb137-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> x <span class="op">*</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb137-7"><a href="chap-utiliseR.html#cb137-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p></p>
<p>An R function with the same name as the C++ function is now available.</p>
<p></p>
<div class="sourceCode" id="cb138"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb138-1"><a href="chap-utiliseR.html#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="fu">timesTwo</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>)</span></code></pre></div>
<pre><code>## [1]  2  4  6  8 10</code></pre>
<p></p>
<p>The performance is two orders of magnitude faster than the R code (see the case study, section <a href="chap-utiliseR.html#sec:cas">2.7</a>).</p>
</div>
<div id="parallelizing-r" class="section level2 hasAnchor" number="2.6">
<h2><span class="header-section-number">2.6</span> Parallelizing R<a href="chap-utiliseR.html#parallelizing-r" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>When long computations can be split into independent tasks, the simultaneous (<em>parallel</em>) execution of these tasks reduces the total computation time to that of the longest task, to which is added the cost of setting up the parallelization (creation of the tasks, recovery of the results…).</p>
<p>Read Josh Errickson’s excellent introduction<a href="#fn25" class="footnote-ref" id="fnref25"><sup>25</sup></a> which details the issues and constraints of parallelization.</p>
<p>Two mechanisms are available for parallel code execution:</p>
<ul>
<li><em>fork</em>: the running process is duplicated on multiple cores of the computing computer’s processor.
This is the simplest method but it does not work under Windows (operating system limitation).</li>
<li><em>Socket</em>: a cluster is constituted, either physically (a set of computers running R is necessary) or logically (an instance of R on each core of the computer used).
The members of the cluster communicate through the network (the internal network of the computer used for a logical cluster).</li>
</ul>
<p>Different packages of R allow to implement these mechanisms.</p>
<div id="mclapply-fork" class="section level3 hasAnchor" number="2.6.1">
<h3><span class="header-section-number">2.6.1</span> mclapply (fork)<a href="chap-utiliseR.html#mclapply-fork" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>mclapply</code> function of the <strong>parallel</strong> package has the same syntax as <code>lapply</code> but parallelizes the execution of loops.
Under Windows, it has no effect since the system does not allow <em>fork</em>: it simply calls <code>lapply</code>.
However, a workaround exists to emulate <code>mclapply</code> on Windows by calling <code>parLapply</code>, which uses a cluster.</p>
<p></p>
<div class="sourceCode" id="cb140"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb140-1"><a href="chap-utiliseR.html#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="do">##</span></span>
<span id="cb140-2"><a href="chap-utiliseR.html#cb140-2" aria-hidden="true" tabindex="-1"></a><span class="do">## mclapply.hack.R</span></span>
<span id="cb140-3"><a href="chap-utiliseR.html#cb140-3" aria-hidden="true" tabindex="-1"></a><span class="do">##</span></span>
<span id="cb140-4"><a href="chap-utiliseR.html#cb140-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Nathan VanHoudnos</span></span>
<span id="cb140-5"><a href="chap-utiliseR.html#cb140-5" aria-hidden="true" tabindex="-1"></a><span class="do">## nathanvan AT northwestern FULL STOP edu</span></span>
<span id="cb140-6"><a href="chap-utiliseR.html#cb140-6" aria-hidden="true" tabindex="-1"></a><span class="do">## July 14, 2014</span></span>
<span id="cb140-7"><a href="chap-utiliseR.html#cb140-7" aria-hidden="true" tabindex="-1"></a><span class="do">##</span></span>
<span id="cb140-8"><a href="chap-utiliseR.html#cb140-8" aria-hidden="true" tabindex="-1"></a><span class="do">## A script to implement a hackish version of </span></span>
<span id="cb140-9"><a href="chap-utiliseR.html#cb140-9" aria-hidden="true" tabindex="-1"></a><span class="do">## parallel:mclapply() on Windows machines.</span></span>
<span id="cb140-10"><a href="chap-utiliseR.html#cb140-10" aria-hidden="true" tabindex="-1"></a><span class="do">## On Linux or Mac, the script has no effect</span></span>
<span id="cb140-11"><a href="chap-utiliseR.html#cb140-11" aria-hidden="true" tabindex="-1"></a><span class="do">## beyond loading the parallel library. </span></span>
<span id="cb140-12"><a href="chap-utiliseR.html#cb140-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-13"><a href="chap-utiliseR.html#cb140-13" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(parallel)    </span></code></pre></div>
<pre><code>## Loading required package: parallel</code></pre>
<div class="sourceCode" id="cb142"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb142-1"><a href="chap-utiliseR.html#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Define the hack</span></span>
<span id="cb142-2"><a href="chap-utiliseR.html#cb142-2" aria-hidden="true" tabindex="-1"></a><span class="co"># mc.cores argument added: Eric Marcon</span></span>
<span id="cb142-3"><a href="chap-utiliseR.html#cb142-3" aria-hidden="true" tabindex="-1"></a>mclapply.hack <span class="ot">&lt;-</span> <span class="cf">function</span>(..., <span class="at">mc.cores=</span><span class="fu">detectCores</span>()) {</span>
<span id="cb142-4"><a href="chap-utiliseR.html#cb142-4" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Create a cluster</span></span>
<span id="cb142-5"><a href="chap-utiliseR.html#cb142-5" aria-hidden="true" tabindex="-1"></a>  size.of.list <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">list</span>(...)[[<span class="dv">1</span>]])</span>
<span id="cb142-6"><a href="chap-utiliseR.html#cb142-6" aria-hidden="true" tabindex="-1"></a>  cl <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>( <span class="fu">min</span>(size.of.list, mc.cores) )</span>
<span id="cb142-7"><a href="chap-utiliseR.html#cb142-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-8"><a href="chap-utiliseR.html#cb142-8" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Find out the names of the loaded packages </span></span>
<span id="cb142-9"><a href="chap-utiliseR.html#cb142-9" aria-hidden="true" tabindex="-1"></a>  loaded.package.names <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb142-10"><a href="chap-utiliseR.html#cb142-10" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Base packages</span></span>
<span id="cb142-11"><a href="chap-utiliseR.html#cb142-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sessionInfo</span>()<span class="sc">$</span>basePkgs,</span>
<span id="cb142-12"><a href="chap-utiliseR.html#cb142-12" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Additional packages</span></span>
<span id="cb142-13"><a href="chap-utiliseR.html#cb142-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>( <span class="fu">sessionInfo</span>()<span class="sc">$</span>otherPkgs ))</span>
<span id="cb142-14"><a href="chap-utiliseR.html#cb142-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-15"><a href="chap-utiliseR.html#cb142-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tryCatch</span>( {</span>
<span id="cb142-16"><a href="chap-utiliseR.html#cb142-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb142-17"><a href="chap-utiliseR.html#cb142-17" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Copy over all of the objects within scope to</span></span>
<span id="cb142-18"><a href="chap-utiliseR.html#cb142-18" aria-hidden="true" tabindex="-1"></a>    <span class="do">## all clusters. </span></span>
<span id="cb142-19"><a href="chap-utiliseR.html#cb142-19" aria-hidden="true" tabindex="-1"></a>    this.env <span class="ot">&lt;-</span> <span class="fu">environment</span>()</span>
<span id="cb142-20"><a href="chap-utiliseR.html#cb142-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span>( <span class="fu">identical</span>( this.env, <span class="fu">globalenv</span>() ) <span class="sc">==</span> <span class="cn">FALSE</span> ) {</span>
<span id="cb142-21"><a href="chap-utiliseR.html#cb142-21" aria-hidden="true" tabindex="-1"></a>      <span class="fu">clusterExport</span>(cl,</span>
<span id="cb142-22"><a href="chap-utiliseR.html#cb142-22" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">ls</span>(<span class="at">all.names=</span><span class="cn">TRUE</span>, <span class="at">env=</span>this.env),</span>
<span id="cb142-23"><a href="chap-utiliseR.html#cb142-23" aria-hidden="true" tabindex="-1"></a>                    <span class="at">envir=</span>this.env)</span>
<span id="cb142-24"><a href="chap-utiliseR.html#cb142-24" aria-hidden="true" tabindex="-1"></a>      this.env <span class="ot">&lt;-</span> <span class="fu">parent.env</span>(<span class="fu">environment</span>())</span>
<span id="cb142-25"><a href="chap-utiliseR.html#cb142-25" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb142-26"><a href="chap-utiliseR.html#cb142-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">clusterExport</span>(cl,</span>
<span id="cb142-27"><a href="chap-utiliseR.html#cb142-27" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">ls</span>(<span class="at">all.names=</span><span class="cn">TRUE</span>, <span class="at">env=</span><span class="fu">globalenv</span>()),</span>
<span id="cb142-28"><a href="chap-utiliseR.html#cb142-28" aria-hidden="true" tabindex="-1"></a>                  <span class="at">envir=</span><span class="fu">globalenv</span>())</span>
<span id="cb142-29"><a href="chap-utiliseR.html#cb142-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb142-30"><a href="chap-utiliseR.html#cb142-30" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Load the libraries on all the clusters</span></span>
<span id="cb142-31"><a href="chap-utiliseR.html#cb142-31" aria-hidden="true" tabindex="-1"></a>    <span class="do">## N.B. length(cl) returns the number of clusters</span></span>
<span id="cb142-32"><a href="chap-utiliseR.html#cb142-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">parLapply</span>( cl, <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(cl), <span class="cf">function</span>(xx){</span>
<span id="cb142-33"><a href="chap-utiliseR.html#cb142-33" aria-hidden="true" tabindex="-1"></a>      <span class="fu">lapply</span>(loaded.package.names, <span class="cf">function</span>(yy) {</span>
<span id="cb142-34"><a href="chap-utiliseR.html#cb142-34" aria-hidden="true" tabindex="-1"></a>        <span class="fu">require</span>(yy , <span class="at">character.only=</span><span class="cn">TRUE</span>)})</span>
<span id="cb142-35"><a href="chap-utiliseR.html#cb142-35" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb142-36"><a href="chap-utiliseR.html#cb142-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb142-37"><a href="chap-utiliseR.html#cb142-37" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Run the lapply in parallel </span></span>
<span id="cb142-38"><a href="chap-utiliseR.html#cb142-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>( <span class="fu">parLapply</span>( cl, ...) )</span>
<span id="cb142-39"><a href="chap-utiliseR.html#cb142-39" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">finally =</span> {        </span>
<span id="cb142-40"><a href="chap-utiliseR.html#cb142-40" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Stop the cluster</span></span>
<span id="cb142-41"><a href="chap-utiliseR.html#cb142-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopCluster</span>(cl)</span>
<span id="cb142-42"><a href="chap-utiliseR.html#cb142-42" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb142-43"><a href="chap-utiliseR.html#cb142-43" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb142-44"><a href="chap-utiliseR.html#cb142-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-45"><a href="chap-utiliseR.html#cb142-45" aria-hidden="true" tabindex="-1"></a><span class="do">## Warn the user if they are using Windows</span></span>
<span id="cb142-46"><a href="chap-utiliseR.html#cb142-46" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>( <span class="fu">Sys.info</span>()[[<span class="st">&#39;sysname&#39;</span>]] <span class="sc">==</span> <span class="st">&#39;Windows&#39;</span> ){</span>
<span id="cb142-47"><a href="chap-utiliseR.html#cb142-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">paste</span>(</span>
<span id="cb142-48"><a href="chap-utiliseR.html#cb142-48" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>, </span>
<span id="cb142-49"><a href="chap-utiliseR.html#cb142-49" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;   *** Microsoft Windows detected ***</span><span class="sc">\n</span><span class="st">&quot;</span>,</span>
<span id="cb142-50"><a href="chap-utiliseR.html#cb142-50" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;   </span><span class="sc">\n</span><span class="st">&quot;</span>,</span>
<span id="cb142-51"><a href="chap-utiliseR.html#cb142-51" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;   For technical reasons, the MS Windows version of mclapply()</span><span class="sc">\n</span><span class="st">&quot;</span>,</span>
<span id="cb142-52"><a href="chap-utiliseR.html#cb142-52" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;   is implemented as a serial function instead of a parallel</span><span class="sc">\n</span><span class="st">&quot;</span>,</span>
<span id="cb142-53"><a href="chap-utiliseR.html#cb142-53" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;   function.&quot;</span>,</span>
<span id="cb142-54"><a href="chap-utiliseR.html#cb142-54" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;   </span><span class="sc">\n\n</span><span class="st">&quot;</span>,</span>
<span id="cb142-55"><a href="chap-utiliseR.html#cb142-55" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;   As a quick hack, we replace this serial version of mclapply()</span><span class="sc">\n</span><span class="st">&quot;</span>,</span>
<span id="cb142-56"><a href="chap-utiliseR.html#cb142-56" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;   with a wrapper to parLapply() for this R session. Please see</span><span class="sc">\n\n</span><span class="st">&quot;</span>,</span>
<span id="cb142-57"><a href="chap-utiliseR.html#cb142-57" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;     http://www.stat.cmu.edu/~nmv/2014/07/14/</span></span>
<span id="cb142-58"><a href="chap-utiliseR.html#cb142-58" aria-hidden="true" tabindex="-1"></a><span class="st">    implementing-mclapply-on-windows </span><span class="sc">\n\n</span><span class="st">&quot;</span>,</span>
<span id="cb142-59"><a href="chap-utiliseR.html#cb142-59" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;   for details.</span><span class="sc">\n\n</span><span class="st">&quot;</span>))</span>
<span id="cb142-60"><a href="chap-utiliseR.html#cb142-60" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb142-61"><a href="chap-utiliseR.html#cb142-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-62"><a href="chap-utiliseR.html#cb142-62" aria-hidden="true" tabindex="-1"></a><span class="do">## If the OS is Windows, set mclapply to the</span></span>
<span id="cb142-63"><a href="chap-utiliseR.html#cb142-63" aria-hidden="true" tabindex="-1"></a><span class="do">## the hackish version. Otherwise, leave the</span></span>
<span id="cb142-64"><a href="chap-utiliseR.html#cb142-64" aria-hidden="true" tabindex="-1"></a><span class="do">## definition alone. </span></span>
<span id="cb142-65"><a href="chap-utiliseR.html#cb142-65" aria-hidden="true" tabindex="-1"></a>mclapply <span class="ot">&lt;-</span> <span class="cf">switch</span>( <span class="fu">Sys.info</span>()[[<span class="st">&#39;sysname&#39;</span>]],</span>
<span id="cb142-66"><a href="chap-utiliseR.html#cb142-66" aria-hidden="true" tabindex="-1"></a>                    <span class="at">Windows =</span> {mclapply.hack}, </span>
<span id="cb142-67"><a href="chap-utiliseR.html#cb142-67" aria-hidden="true" tabindex="-1"></a>                    <span class="at">Linux   =</span> {mclapply},</span>
<span id="cb142-68"><a href="chap-utiliseR.html#cb142-68" aria-hidden="true" tabindex="-1"></a>                    <span class="at">Darwin  =</span> {mclapply})</span>
<span id="cb142-69"><a href="chap-utiliseR.html#cb142-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-70"><a href="chap-utiliseR.html#cb142-70" aria-hidden="true" tabindex="-1"></a><span class="do">## end mclapply.hack.R</span></span></code></pre></div>
<p></p>
<p>The following code tests the parallelization of a function that returns its argument unchanged after a quarter-second pause.
This is knitted with <code>3</code> cores, all of which are used except for one so as not to saturate the system.</p>
<p></p>
<div class="sourceCode" id="cb143"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb143-1"><a href="chap-utiliseR.html#cb143-1" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">time =</span> <span class="fl">0.25</span>) {</span>
<span id="cb143-2"><a href="chap-utiliseR.html#cb143-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Sys.sleep</span>(time)</span>
<span id="cb143-3"><a href="chap-utiliseR.html#cb143-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(x)</span>
<span id="cb143-4"><a href="chap-utiliseR.html#cb143-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb143-5"><a href="chap-utiliseR.html#cb143-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Leave one core out for the system</span></span>
<span id="cb143-6"><a href="chap-utiliseR.html#cb143-6" aria-hidden="true" tabindex="-1"></a>nbCores <span class="ot">&lt;-</span> <span class="fu">detectCores</span>() <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb143-7"><a href="chap-utiliseR.html#cb143-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Serial : theoretical time = nbCores/4 seconds</span></span>
<span id="cb143-8"><a href="chap-utiliseR.html#cb143-8" aria-hidden="true" tabindex="-1"></a>(tserie <span class="ot">&lt;-</span> <span class="fu">system.time</span>(<span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>nbCores, f)))</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.003   0.000   0.606</code></pre>
<div class="sourceCode" id="cb145"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb145-1"><a href="chap-utiliseR.html#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Parallel : theoretical time = 1/4 second</span></span>
<span id="cb145-2"><a href="chap-utiliseR.html#cb145-2" aria-hidden="true" tabindex="-1"></a>(tparallele <span class="ot">&lt;-</span> <span class="fu">system.time</span>(<span class="fu">mclapply</span>(<span class="dv">1</span><span class="sc">:</span>nbCores, f, <span class="at">mc.cores =</span> nbCores)))</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.004   0.009   0.390</code></pre>
<p></p>
<p>Setting up parallelization has a cost of about <code>0.14</code> seconds here.
The execution time is much longer in parallel under Windows because setting up the cluster takes much more time than parallelization saves.
Parallelization is interesting for longer tasks, such as a one second break.</p>
<p></p>
<div class="sourceCode" id="cb147"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb147-1"><a href="chap-utiliseR.html#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Serial</span></span>
<span id="cb147-2"><a href="chap-utiliseR.html#cb147-2" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(<span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>nbCores, f, <span class="at">time =</span> <span class="dv">1</span>))</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.000   0.000   2.121</code></pre>
<div class="sourceCode" id="cb149"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb149-1"><a href="chap-utiliseR.html#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Parallel</span></span>
<span id="cb149-2"><a href="chap-utiliseR.html#cb149-2" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(<span class="fu">mclapply</span>(<span class="dv">1</span><span class="sc">:</span>nbCores, f, <span class="at">time =</span> <span class="dv">1</span>, <span class="at">mc.cores =</span> nbCores))</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.003   0.007   1.009</code></pre>
<p></p>
<p>The additional time required for parallel execution of the new code is relatively smaller: the costs become less than the savings when the time of each task increases.</p>
<p>If the number of parallel tasks exceeds the number of cores used, performance collapses because the additional task must be executed after the first ones.</p>
<p></p>
<div class="sourceCode" id="cb151"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb151-1"><a href="chap-utiliseR.html#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(<span class="fu">mclapply</span>(<span class="dv">1</span><span class="sc">:</span>nbCores, f, <span class="at">time =</span> <span class="dv">1</span>, <span class="at">mc.cores =</span> nbCores))</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.001   0.004   1.008</code></pre>
<div class="sourceCode" id="cb153"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb153-1"><a href="chap-utiliseR.html#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(<span class="fu">mclapply</span>(<span class="dv">1</span><span class="sc">:</span>(nbCores <span class="sc">+</span> <span class="dv">1</span>), f, <span class="at">time =</span> <span class="dv">1</span>, <span class="at">mc.cores =</span> nbCores))</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.002   0.005   2.007</code></pre>
<p></p>
<p>The time then remains stable until the number of cores is doubled.
The figure <a href="chap-utiliseR.html#fig:r-parallele">2.2</a> shows the evolution of the computation time according to the number of tasks.</p>

<p></p>
<div class="sourceCode" id="cb155"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb155-1"><a href="chap-utiliseR.html#cb155-1" aria-hidden="true" tabindex="-1"></a>Tasks <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span>(<span class="dv">2</span> <span class="sc">*</span> nbCores<span class="sc">+</span><span class="dv">1</span>)</span>
<span id="cb155-2"><a href="chap-utiliseR.html#cb155-2" aria-hidden="true" tabindex="-1"></a>Time <span class="ot">&lt;-</span> <span class="fu">sapply</span>(Tasks, <span class="cf">function</span>(nbTasks) {</span>
<span id="cb155-3"><a href="chap-utiliseR.html#cb155-3" aria-hidden="true" tabindex="-1"></a>      <span class="fu">system.time</span>(<span class="fu">mclapply</span>(<span class="dv">1</span><span class="sc">:</span>nbTasks, f, <span class="at">time=</span><span class="dv">1</span>, <span class="at">mc.cores=</span>nbCores))</span>
<span id="cb155-4"><a href="chap-utiliseR.html#cb155-4" aria-hidden="true" tabindex="-1"></a>              })</span>
<span id="cb155-5"><a href="chap-utiliseR.html#cb155-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;tidyverse&quot;</span>)</span>
<span id="cb155-6"><a href="chap-utiliseR.html#cb155-6" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(Tasks, <span class="at">Time=</span>Time[<span class="st">&quot;elapsed&quot;</span>, ]) <span class="sc">%&gt;%</span> </span>
<span id="cb155-7"><a href="chap-utiliseR.html#cb155-7" aria-hidden="true" tabindex="-1"></a>  ggplot <span class="sc">+</span></span>
<span id="cb155-8"><a href="chap-utiliseR.html#cb155-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> Tasks, <span class="at">y =</span> Time)) <span class="sc">+</span></span>
<span id="cb155-9"><a href="chap-utiliseR.html#cb155-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> nbCores, <span class="at">col =</span> <span class="st">&quot;red&quot;</span>, <span class="at">lty =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb155-10"><a href="chap-utiliseR.html#cb155-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">2</span> <span class="sc">*</span> nbCores, <span class="at">col =</span> <span class="st">&quot;red&quot;</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:r-parallele"></span>
<img src="WwR_files/figure-html/r-parallele-1.png" alt="Parallel execution time of tasks requiring one second (each task is a one second pause). The number of tasks varies from 1 to twice the number of cores used (equal to 2) plus one." width="80%" />
<p class="caption">
Figure 2.2: Parallel execution time of tasks requiring one second (each task is a one second pause). The number of tasks varies from 1 to twice the number of cores used (equal to <code>2</code>) plus one.
</p>
</div>
<p></p>
<p>The theoretical shape of this curve is as follows:</p>
<ul>
<li>for a task, the time is equal to one second plus the parallelization setup time;</li>
<li>the time should remain stable until the number of cores used;</li>
<li>when all the cores are used (red dotted line), the time should increase by one second and then remain stable until the next limit.</li>
</ul>
<p>In practice, the computation time is determined by other factors that are difficult to predict.
The best practice is to adapt the number of tasks to the number of cores, otherwise performance will be lost.</p>
</div>
<div id="parlapply-socket" class="section level3 hasAnchor" number="2.6.2">
<h3><span class="header-section-number">2.6.2</span> parLapply (socket)<a href="chap-utiliseR.html#parlapply-socket" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><code>parLapply</code> requires to create a cluster, export the useful variables on each node, load the necessary packages on each node, execute the code and finally stop the cluster.
The code for each step can be found in the <code>mclapply.hack</code> function above.</p>
<p>For everyday use, <code>mclapply</code> is faster, except under Windows, and simpler (including under Windows thanks to the above workaround).</p>
</div>
<div id="foreach" class="section level3 hasAnchor" number="2.6.3">
<h3><span class="header-section-number">2.6.3</span> foreach<a href="chap-utiliseR.html#foreach" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="how-it-works" class="section level4 hasAnchor" number="2.6.3.1">
<h4><span class="header-section-number">2.6.3.1</span> How it works<a href="chap-utiliseR.html#how-it-works" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The <strong>foreach</strong> package allows advanced use of parallelization.
Read its thumbnails.</p>
<p></p>
<div class="sourceCode" id="cb156"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb156-1"><a href="chap-utiliseR.html#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Manual</span></span>
<span id="cb156-2"><a href="chap-utiliseR.html#cb156-2" aria-hidden="true" tabindex="-1"></a><span class="fu">vignette</span>(<span class="st">&quot;foreach&quot;</span>, <span class="st">&quot;foreach&quot;</span>)</span>
<span id="cb156-3"><a href="chap-utiliseR.html#cb156-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Nested loops</span></span>
<span id="cb156-4"><a href="chap-utiliseR.html#cb156-4" aria-hidden="true" tabindex="-1"></a><span class="fu">vignette</span>(<span class="st">&quot;nested&quot;</span>, <span class="st">&quot;foreach&quot;</span>)</span></code></pre></div>
<p></p>
<p>Regardless of parallelization, <strong>foreach</strong> redefines <em>for</em> loops.</p>
<p></p>
<div class="sourceCode" id="cb157"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb157-1"><a href="chap-utiliseR.html#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) {</span>
<span id="cb157-2"><a href="chap-utiliseR.html#cb157-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">f</span>(i)</span>
<span id="cb157-3"><a href="chap-utiliseR.html#cb157-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb157-4"><a href="chap-utiliseR.html#cb157-4" aria-hidden="true" tabindex="-1"></a><span class="co"># becomes</span></span>
<span id="cb157-5"><a href="chap-utiliseR.html#cb157-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;foreach&quot;</span>)</span></code></pre></div>
<pre><code>## 
## Attaching package: &#39;foreach&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:purrr&#39;:
## 
##     accumulate, when</code></pre>
<div class="sourceCode" id="cb160"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb160-1"><a href="chap-utiliseR.html#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) <span class="sc">%do%</span> {</span>
<span id="cb160-2"><a href="chap-utiliseR.html#cb160-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">f</span>(i)</span>
<span id="cb160-3"><a href="chap-utiliseR.html#cb160-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## [[1]]
## [1] 1
## 
## [[2]]
## [1] 2
## 
## [[3]]
## [1] 3</code></pre>
<p></p>
<p>The <code>foreach</code> function returns a list containing the results of each loop.
The elements of the list can be combined by any function, such as <code>c</code>.</p>
<p></p>
<div class="sourceCode" id="cb162"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb162-1"><a href="chap-utiliseR.html#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">.combine =</span> <span class="st">&quot;c&quot;</span>) <span class="sc">%do%</span> {</span>
<span id="cb162-2"><a href="chap-utiliseR.html#cb162-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">f</span>(i)</span>
<span id="cb162-3"><a href="chap-utiliseR.html#cb162-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## [1] 1 2 3</code></pre>
<p></p>
<p>The <code>foreach</code> function is capable of using iterators, that is, functions that pass to the loop only the data it needs without loading the rest into memory.
Here, the <code>icount</code> iterator passes the values 1, 2 and 3 individually, without loading the 1:3 vector into memory.</p>
<p></p>
<div class="sourceCode" id="cb164"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb164-1"><a href="chap-utiliseR.html#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;iterators&quot;</span>)</span>
<span id="cb164-2"><a href="chap-utiliseR.html#cb164-2" aria-hidden="true" tabindex="-1"></a><span class="fu">foreach</span>(<span class="at">i =</span> <span class="fu">icount</span>(<span class="dv">3</span>), <span class="at">.combine =</span> <span class="st">&quot;c&quot;</span>) <span class="sc">%do%</span> {</span>
<span id="cb164-3"><a href="chap-utiliseR.html#cb164-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">f</span>(i)</span>
<span id="cb164-4"><a href="chap-utiliseR.html#cb164-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## [1] 1 2 3</code></pre>
<p></p>
<p>It is therefore very useful when each object of the loop uses a large amount of memory.</p>
</div>
<div id="parallelization" class="section level4 hasAnchor" number="2.6.3.2">
<h4><span class="header-section-number">2.6.3.2</span> Parallelization<a href="chap-utiliseR.html#parallelization" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Replacing the <code>%do%</code> operator with <code>%dopar%</code> parallelizes loops, provided that an adapter, i.e. an intermediate package between <code>foreach</code> and a package implementing parallelization, is loaded.
<strong>doParallel</strong> is an adapter for using the <strong>parallel</strong> package that comes with R.</p>
<p></p>
<div class="sourceCode" id="cb166"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb166-1"><a href="chap-utiliseR.html#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(doParallel)</span>
<span id="cb166-2"><a href="chap-utiliseR.html#cb166-2" aria-hidden="true" tabindex="-1"></a><span class="fu">registerDoParallel</span>(<span class="at">cores =</span> nbCores)</span>
<span id="cb166-3"><a href="chap-utiliseR.html#cb166-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Serial</span></span>
<span id="cb166-4"><a href="chap-utiliseR.html#cb166-4" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(<span class="fu">foreach</span>(<span class="at">i =</span> <span class="fu">icount</span>(nbCores), <span class="at">.combine =</span> <span class="st">&quot;c&quot;</span>) <span class="sc">%do%</span></span>
<span id="cb166-5"><a href="chap-utiliseR.html#cb166-5" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb166-6"><a href="chap-utiliseR.html#cb166-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">f</span>(i)</span>
<span id="cb166-7"><a href="chap-utiliseR.html#cb166-7" aria-hidden="true" tabindex="-1"></a>    })</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.003   0.001   0.647</code></pre>
<div class="sourceCode" id="cb168"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb168-1"><a href="chap-utiliseR.html#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Parallel</span></span>
<span id="cb168-2"><a href="chap-utiliseR.html#cb168-2" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(<span class="fu">foreach</span>(<span class="at">i =</span> <span class="fu">icount</span>(nbCores), <span class="at">.combine =</span> <span class="st">&quot;c&quot;</span>) <span class="sc">%dopar%</span></span>
<span id="cb168-3"><a href="chap-utiliseR.html#cb168-3" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb168-4"><a href="chap-utiliseR.html#cb168-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">f</span>(i)</span>
<span id="cb168-5"><a href="chap-utiliseR.html#cb168-5" aria-hidden="true" tabindex="-1"></a>    })</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.007   0.016   0.403</code></pre>
<p></p>
<p>The fixed cost of parallelization is low.</p>
</div>
</div>
</div>
<div id="sec:cas" class="section level2 hasAnchor" number="2.7">
<h2><span class="header-section-number">2.7</span> Case study<a href="chap-utiliseR.html#sec:cas" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This case study tests the different techniques seen above to solve a concrete problem.
The objective is to compute the average distance between two points of a random seed of 1000 points in a square window of side 1.</p>
<p>Its expectation is computable<a href="#fn26" class="footnote-ref" id="fnref26"><sup>26</sup></a>.
It is equal to <span class="math inline">\(\frac{2+\sqrt{2}+5\ln{(1+\sqrt{2})}}{15} \approx 0.5214\)</span>.</p>
<div id="creation-of-the-data" class="section level3 hasAnchor" number="2.7.1">
<h3><span class="header-section-number">2.7.1</span> Creation of the data<a href="chap-utiliseR.html#creation-of-the-data" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The point set is created with the <strong>spatstat</strong> package.</p>
<p></p>
<div class="sourceCode" id="cb170"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb170-1"><a href="chap-utiliseR.html#cb170-1" aria-hidden="true" tabindex="-1"></a>NbPoints <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb170-2"><a href="chap-utiliseR.html#cb170-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;spatstat&quot;</span>)</span>
<span id="cb170-3"><a href="chap-utiliseR.html#cb170-3" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">runifpoint</span>(NbPoints)</span></code></pre></div>
<p></p>
</div>
<div id="spatstat" class="section level3 hasAnchor" number="2.7.2">
<h3><span class="header-section-number">2.7.2</span> Spatstat<a href="chap-utiliseR.html#spatstat" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>pairdist()</code> function of <strong>spatstat</strong> returns the matrix of distances between points.
The average distance is calculated by dividing the sum by the number of pairs of distinct points.</p>
<p></p>
<div class="sourceCode" id="cb171"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb171-1"><a href="chap-utiliseR.html#cb171-1" aria-hidden="true" tabindex="-1"></a>mb <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(d <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">pairdist</span>(X))<span class="sc">/</span>NbPoints<span class="sc">/</span>(NbPoints <span class="sc">-</span></span>
<span id="cb171-2"><a href="chap-utiliseR.html#cb171-2" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>))</span>
<span id="cb171-3"><a href="chap-utiliseR.html#cb171-3" aria-hidden="true" tabindex="-1"></a><span class="co"># suppressmessages pour éliminer les messages superflus</span></span>
<span id="cb171-4"><a href="chap-utiliseR.html#cb171-4" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressMessages</span>(<span class="fu">autoplot</span>(mb))</span></code></pre></div>
<p><img src="WwR_files/figure-html/pairdist-1.png" width="80%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb172"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb172-1"><a href="chap-utiliseR.html#cb172-1" aria-hidden="true" tabindex="-1"></a>d</span></code></pre></div>
<pre><code>## [1] 0.5154062</code></pre>
<p></p>
<p>The function is fast because it is coded in C language in the <strong>spatstat</strong> package for the core of its calculations.</p>
</div>
<div id="apply" class="section level3 hasAnchor" number="2.7.3">
<h3><span class="header-section-number">2.7.3</span> apply<a href="chap-utiliseR.html#apply" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The distance can be calculated by two nested <code>sapply()</code>.</p>
<p></p>
<div class="sourceCode" id="cb174"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb174-1"><a href="chap-utiliseR.html#cb174-1" aria-hidden="true" tabindex="-1"></a>fsapply1 <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb174-2"><a href="chap-utiliseR.html#cb174-2" aria-hidden="true" tabindex="-1"></a>    distances <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span>NbPoints, <span class="cf">function</span>(i) <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span>NbPoints,</span>
<span id="cb174-3"><a href="chap-utiliseR.html#cb174-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">function</span>(j) <span class="fu">sqrt</span>((X<span class="sc">$</span>x[i] <span class="sc">-</span> X<span class="sc">$</span>x[j])<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> (X<span class="sc">$</span>y[i] <span class="sc">-</span> X<span class="sc">$</span>y[j])<span class="sc">^</span><span class="dv">2</span>)))</span>
<span id="cb174-4"><a href="chap-utiliseR.html#cb174-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">sum</span>(distances)<span class="sc">/</span>NbPoints<span class="sc">/</span>(NbPoints <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb174-5"><a href="chap-utiliseR.html#cb174-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb174-6"><a href="chap-utiliseR.html#cb174-6" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(d <span class="ot">&lt;-</span> <span class="fu">fsapply1</span>())</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   5.550   0.035   5.606</code></pre>
<div class="sourceCode" id="cb176"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb176-1"><a href="chap-utiliseR.html#cb176-1" aria-hidden="true" tabindex="-1"></a>d</span></code></pre></div>
<pre><code>## [1] 0.5154062</code></pre>
<p></p>
<p>Some time can be saved by replacing <code>sapply</code> with <code>vapply</code>: the format of the results does not have to be determined by the function.
The gain is negligible on a long computation like this one but important for short computations.</p>
<p></p>
<div class="sourceCode" id="cb178"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb178-1"><a href="chap-utiliseR.html#cb178-1" aria-hidden="true" tabindex="-1"></a>fsapply2 <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb178-2"><a href="chap-utiliseR.html#cb178-2" aria-hidden="true" tabindex="-1"></a>    distances <span class="ot">&lt;-</span> <span class="fu">vapply</span>(<span class="dv">1</span><span class="sc">:</span>NbPoints, <span class="cf">function</span>(i) <span class="fu">vapply</span>(<span class="dv">1</span><span class="sc">:</span>NbPoints,</span>
<span id="cb178-3"><a href="chap-utiliseR.html#cb178-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">function</span>(j) <span class="fu">sqrt</span>((X<span class="sc">$</span>x[i] <span class="sc">-</span> X<span class="sc">$</span>x[j])<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> (X<span class="sc">$</span>y[i] <span class="sc">-</span> X<span class="sc">$</span>y[j])<span class="sc">^</span><span class="dv">2</span>),</span>
<span id="cb178-4"><a href="chap-utiliseR.html#cb178-4" aria-hidden="true" tabindex="-1"></a>        <span class="dv">0</span>), <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span> <span class="sc">+</span> <span class="dv">0</span>)</span>
<span id="cb178-5"><a href="chap-utiliseR.html#cb178-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">sum</span>(distances)<span class="sc">/</span>NbPoints<span class="sc">/</span>(NbPoints <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb178-6"><a href="chap-utiliseR.html#cb178-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb178-7"><a href="chap-utiliseR.html#cb178-7" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(d <span class="ot">&lt;-</span> <span class="fu">fsapply2</span>())</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   5.226   0.016   5.249</code></pre>
<div class="sourceCode" id="cb180"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb180-1"><a href="chap-utiliseR.html#cb180-1" aria-hidden="true" tabindex="-1"></a>d</span></code></pre></div>
<pre><code>## [1] 0.5154062</code></pre>
<p></p>
<p>The output format is not always obvious to write:</p>
<ul>
<li>it must respect the size of the data: a vector of size 1000 for the outer loop, a scalar for the inner loop.</li>
<li>it must respect the type: <code>0</code> for an integer, <code>0.0</code> for a real. In the outer loop, adding <code>0.0</code> to the vector of integers turns it into a vector of reals.</li>
</ul>
<p>A more significant improvement is to compute the square roots only at the end of the loop, to take advantage of the vectorization of the function.</p>
<p></p>
<div class="sourceCode" id="cb182"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb182-1"><a href="chap-utiliseR.html#cb182-1" aria-hidden="true" tabindex="-1"></a>fsapply3 <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb182-2"><a href="chap-utiliseR.html#cb182-2" aria-hidden="true" tabindex="-1"></a>    distances <span class="ot">&lt;-</span> <span class="fu">vapply</span>(<span class="dv">1</span><span class="sc">:</span>NbPoints, <span class="cf">function</span>(i) <span class="fu">vapply</span>(<span class="dv">1</span><span class="sc">:</span>NbPoints,</span>
<span id="cb182-3"><a href="chap-utiliseR.html#cb182-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">function</span>(j) (X<span class="sc">$</span>x[i] <span class="sc">-</span> X<span class="sc">$</span>x[j])<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> (X<span class="sc">$</span>y[i] <span class="sc">-</span> X<span class="sc">$</span>y[j])<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb182-4"><a href="chap-utiliseR.html#cb182-4" aria-hidden="true" tabindex="-1"></a>        <span class="dv">0</span>), <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span> <span class="sc">+</span> <span class="dv">0</span>)</span>
<span id="cb182-5"><a href="chap-utiliseR.html#cb182-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">sum</span>(<span class="fu">sqrt</span>(distances))<span class="sc">/</span>NbPoints<span class="sc">/</span>(NbPoints <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb182-6"><a href="chap-utiliseR.html#cb182-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb182-7"><a href="chap-utiliseR.html#cb182-7" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(d <span class="ot">&lt;-</span> <span class="fu">fsapply3</span>())</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   5.202   0.023   5.246</code></pre>
<div class="sourceCode" id="cb184"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb184-1"><a href="chap-utiliseR.html#cb184-1" aria-hidden="true" tabindex="-1"></a>d</span></code></pre></div>
<pre><code>## [1] 0.5154062</code></pre>
<p></p>
<p>The computations are performed twice (distance between points <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span>, but also between points <span class="math inline">\(j\)</span> and <span class="math inline">\(i\)</span>): a test on the indices allows to divide the time almost by 2 (not quite because the loops without computation, which return <span class="math inline">\(0\)</span>, take time).</p>
<p></p>
<div class="sourceCode" id="cb186"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb186-1"><a href="chap-utiliseR.html#cb186-1" aria-hidden="true" tabindex="-1"></a>fsapply4 <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb186-2"><a href="chap-utiliseR.html#cb186-2" aria-hidden="true" tabindex="-1"></a>    distances <span class="ot">&lt;-</span> <span class="fu">vapply</span>(<span class="dv">1</span><span class="sc">:</span>NbPoints, <span class="cf">function</span>(i) {</span>
<span id="cb186-3"><a href="chap-utiliseR.html#cb186-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">vapply</span>(<span class="dv">1</span><span class="sc">:</span>NbPoints, <span class="cf">function</span>(j) {</span>
<span id="cb186-4"><a href="chap-utiliseR.html#cb186-4" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (j <span class="sc">&gt;</span> i) {</span>
<span id="cb186-5"><a href="chap-utiliseR.html#cb186-5" aria-hidden="true" tabindex="-1"></a>                (X<span class="sc">$</span>x[i] <span class="sc">-</span> X<span class="sc">$</span>x[j])<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> (X<span class="sc">$</span>y[i] <span class="sc">-</span> X<span class="sc">$</span>y[j])<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb186-6"><a href="chap-utiliseR.html#cb186-6" aria-hidden="true" tabindex="-1"></a>            } <span class="cf">else</span> {</span>
<span id="cb186-7"><a href="chap-utiliseR.html#cb186-7" aria-hidden="true" tabindex="-1"></a>                <span class="dv">0</span></span>
<span id="cb186-8"><a href="chap-utiliseR.html#cb186-8" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb186-9"><a href="chap-utiliseR.html#cb186-9" aria-hidden="true" tabindex="-1"></a>        }, <span class="dv">0</span>)</span>
<span id="cb186-10"><a href="chap-utiliseR.html#cb186-10" aria-hidden="true" tabindex="-1"></a>    }, <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span> <span class="sc">+</span> <span class="dv">0</span>)</span>
<span id="cb186-11"><a href="chap-utiliseR.html#cb186-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">sum</span>(<span class="fu">sqrt</span>(distances))<span class="sc">/</span>NbPoints<span class="sc">/</span>(NbPoints <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="dv">2</span>)</span>
<span id="cb186-12"><a href="chap-utiliseR.html#cb186-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb186-13"><a href="chap-utiliseR.html#cb186-13" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(d <span class="ot">&lt;-</span> <span class="fu">fsapply4</span>())</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   3.019   0.010   3.034</code></pre>
<div class="sourceCode" id="cb188"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb188-1"><a href="chap-utiliseR.html#cb188-1" aria-hidden="true" tabindex="-1"></a>d</span></code></pre></div>
<pre><code>## [1] 0.5154062</code></pre>
<p></p>
<p>In parallel, the computation time is not improved under Windows because the individual tasks are too short.
Under MacOS or Linux, the computation is accelerated.</p>
<p></p>
<div class="sourceCode" id="cb190"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb190-1"><a href="chap-utiliseR.html#cb190-1" aria-hidden="true" tabindex="-1"></a>fsapply5 <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb190-2"><a href="chap-utiliseR.html#cb190-2" aria-hidden="true" tabindex="-1"></a>    distances <span class="ot">&lt;-</span> <span class="fu">mclapply</span>(<span class="dv">1</span><span class="sc">:</span>NbPoints, <span class="cf">function</span>(i) {</span>
<span id="cb190-3"><a href="chap-utiliseR.html#cb190-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">vapply</span>(<span class="dv">1</span><span class="sc">:</span>NbPoints, <span class="cf">function</span>(j) {</span>
<span id="cb190-4"><a href="chap-utiliseR.html#cb190-4" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (j <span class="sc">&gt;</span> i) {</span>
<span id="cb190-5"><a href="chap-utiliseR.html#cb190-5" aria-hidden="true" tabindex="-1"></a>                (X<span class="sc">$</span>x[i] <span class="sc">-</span> X<span class="sc">$</span>x[j])<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> (X<span class="sc">$</span>y[i] <span class="sc">-</span> X<span class="sc">$</span>y[j])<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb190-6"><a href="chap-utiliseR.html#cb190-6" aria-hidden="true" tabindex="-1"></a>            } <span class="cf">else</span> {</span>
<span id="cb190-7"><a href="chap-utiliseR.html#cb190-7" aria-hidden="true" tabindex="-1"></a>                <span class="dv">0</span></span>
<span id="cb190-8"><a href="chap-utiliseR.html#cb190-8" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb190-9"><a href="chap-utiliseR.html#cb190-9" aria-hidden="true" tabindex="-1"></a>        }, <span class="dv">0</span>)</span>
<span id="cb190-10"><a href="chap-utiliseR.html#cb190-10" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb190-11"><a href="chap-utiliseR.html#cb190-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">sum</span>(<span class="fu">sqrt</span>(<span class="fu">simplify2array</span>(distances)))<span class="sc">/</span>NbPoints<span class="sc">/</span>(NbPoints <span class="sc">-</span></span>
<span id="cb190-12"><a href="chap-utiliseR.html#cb190-12" aria-hidden="true" tabindex="-1"></a>        <span class="dv">1</span>) <span class="sc">*</span> <span class="dv">2</span>)</span>
<span id="cb190-13"><a href="chap-utiliseR.html#cb190-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb190-14"><a href="chap-utiliseR.html#cb190-14" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(d <span class="ot">&lt;-</span> <span class="fu">fsapply5</span>())</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   3.390   0.382   1.926</code></pre>
<div class="sourceCode" id="cb192"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb192-1"><a href="chap-utiliseR.html#cb192-1" aria-hidden="true" tabindex="-1"></a>d</span></code></pre></div>
<pre><code>## [1] 0.5154062</code></pre>
<p></p>
</div>
<div id="boucle-for" class="section level3 hasAnchor" number="2.7.4">
<h3><span class="header-section-number">2.7.4</span> boucle for<a href="chap-utiliseR.html#boucle-for" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>A for loop is faster and consumes less memory because it does not store the distance matrix.</p>
<p></p>
<div class="sourceCode" id="cb194"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb194-1"><a href="chap-utiliseR.html#cb194-1" aria-hidden="true" tabindex="-1"></a>distance <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb194-2"><a href="chap-utiliseR.html#cb194-2" aria-hidden="true" tabindex="-1"></a>ffor <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb194-3"><a href="chap-utiliseR.html#cb194-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(NbPoints <span class="sc">-</span> <span class="dv">1</span>)) {</span>
<span id="cb194-4"><a href="chap-utiliseR.html#cb194-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (j <span class="cf">in</span> (i <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>NbPoints) {</span>
<span id="cb194-5"><a href="chap-utiliseR.html#cb194-5" aria-hidden="true" tabindex="-1"></a>            distance <span class="ot">&lt;-</span> distance <span class="sc">+</span> <span class="fu">sqrt</span>((X<span class="sc">$</span>x[i] <span class="sc">-</span> X<span class="sc">$</span>x[j])<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span></span>
<span id="cb194-6"><a href="chap-utiliseR.html#cb194-6" aria-hidden="true" tabindex="-1"></a>                (X<span class="sc">$</span>y[i] <span class="sc">-</span> X<span class="sc">$</span>y[j])<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb194-7"><a href="chap-utiliseR.html#cb194-7" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb194-8"><a href="chap-utiliseR.html#cb194-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb194-9"><a href="chap-utiliseR.html#cb194-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(distance<span class="sc">/</span>NbPoints<span class="sc">/</span>(NbPoints <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="dv">2</span>)</span>
<span id="cb194-10"><a href="chap-utiliseR.html#cb194-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb194-11"><a href="chap-utiliseR.html#cb194-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculation time, stored</span></span>
<span id="cb194-12"><a href="chap-utiliseR.html#cb194-12" aria-hidden="true" tabindex="-1"></a>(for_time <span class="ot">&lt;-</span> <span class="fu">system.time</span>(d <span class="ot">&lt;-</span> <span class="fu">ffor</span>()))</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   1.829   0.010   1.840</code></pre>
<div class="sourceCode" id="cb196"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb196-1"><a href="chap-utiliseR.html#cb196-1" aria-hidden="true" tabindex="-1"></a>d</span></code></pre></div>
<pre><code>## [1] 0.5154062</code></pre>
<p></p>
<p>This is the simplest and most efficient way to write this code without parallelization and by limiting ourselves to core R.</p>
</div>
<div id="boucle-foreach" class="section level3 hasAnchor" number="2.7.5">
<h3><span class="header-section-number">2.7.5</span> boucle foreach<a href="chap-utiliseR.html#boucle-foreach" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Two nested foreach loops are needed here: they are extremely slow compared to a simple loop.
The test is run here with 10 times fewer points, so 100 times fewer distances to calculate.</p>
<p></p>
<div class="sourceCode" id="cb198"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb198-1"><a href="chap-utiliseR.html#cb198-1" aria-hidden="true" tabindex="-1"></a>NbPointsReduit <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb198-2"><a href="chap-utiliseR.html#cb198-2" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="fu">runifpoint</span>(NbPointsReduit)</span>
<span id="cb198-3"><a href="chap-utiliseR.html#cb198-3" aria-hidden="true" tabindex="-1"></a>fforeach1 <span class="ot">&lt;-</span> <span class="cf">function</span>(Y) {</span>
<span id="cb198-4"><a href="chap-utiliseR.html#cb198-4" aria-hidden="true" tabindex="-1"></a>    distances <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span>NbPointsReduit, <span class="at">.combine =</span> <span class="st">&quot;cbind&quot;</span>) <span class="sc">%:%</span></span>
<span id="cb198-5"><a href="chap-utiliseR.html#cb198-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">foreach</span>(<span class="at">j =</span> <span class="dv">1</span><span class="sc">:</span>NbPointsReduit, <span class="at">.combine =</span> <span class="st">&quot;c&quot;</span>) <span class="sc">%do%</span> {</span>
<span id="cb198-6"><a href="chap-utiliseR.html#cb198-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (j <span class="sc">&gt;</span> i) {</span>
<span id="cb198-7"><a href="chap-utiliseR.html#cb198-7" aria-hidden="true" tabindex="-1"></a>            (Y<span class="sc">$</span>x[i] <span class="sc">-</span> Y<span class="sc">$</span>x[j])<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> (Y<span class="sc">$</span>y[i] <span class="sc">-</span> Y<span class="sc">$</span>y[j])<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb198-8"><a href="chap-utiliseR.html#cb198-8" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb198-9"><a href="chap-utiliseR.html#cb198-9" aria-hidden="true" tabindex="-1"></a>            <span class="dv">0</span></span>
<span id="cb198-10"><a href="chap-utiliseR.html#cb198-10" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb198-11"><a href="chap-utiliseR.html#cb198-11" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb198-12"><a href="chap-utiliseR.html#cb198-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">sum</span>(<span class="fu">sqrt</span>(distances))<span class="sc">/</span>NbPointsReduit<span class="sc">/</span>(NbPointsReduit <span class="sc">-</span></span>
<span id="cb198-13"><a href="chap-utiliseR.html#cb198-13" aria-hidden="true" tabindex="-1"></a>        <span class="dv">1</span>) <span class="sc">*</span> <span class="dv">2</span>)</span>
<span id="cb198-14"><a href="chap-utiliseR.html#cb198-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb198-15"><a href="chap-utiliseR.html#cb198-15" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(d <span class="ot">&lt;-</span> <span class="fu">fforeach1</span>(Y))</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   2.698   0.020   2.732</code></pre>
<div class="sourceCode" id="cb200"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb200-1"><a href="chap-utiliseR.html#cb200-1" aria-hidden="true" tabindex="-1"></a>d</span></code></pre></div>
<pre><code>## [1] 0.5181951</code></pre>
<p></p>
<p>Nested foreach loops should be reserved for very long tasks (several seconds at least) to compensate the fixed costs of setting them up.</p>
<p>Parallelization is efficient in the code below, especially because it avoids nested foreach loops.
On the other hand, distances are calculated twice.
The performance is still much lower than a simple for loop (remember: 100 times less distances are computed).</p>
<p></p>
<div class="sourceCode" id="cb202"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb202-1"><a href="chap-utiliseR.html#cb202-1" aria-hidden="true" tabindex="-1"></a><span class="fu">registerDoParallel</span>(<span class="at">cores =</span> <span class="fu">detectCores</span>())</span>
<span id="cb202-2"><a href="chap-utiliseR.html#cb202-2" aria-hidden="true" tabindex="-1"></a>fforeach3 <span class="ot">&lt;-</span> <span class="cf">function</span>(Y) {</span>
<span id="cb202-3"><a href="chap-utiliseR.html#cb202-3" aria-hidden="true" tabindex="-1"></a>  distances <span class="ot">&lt;-</span> </span>
<span id="cb202-4"><a href="chap-utiliseR.html#cb202-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">foreach</span>(<span class="at">i=</span><span class="fu">icount</span>(NbPointsReduit), </span>
<span id="cb202-5"><a href="chap-utiliseR.html#cb202-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">.combine=</span><span class="st">&#39;+&#39;</span>) <span class="sc">%dopar%</span> {</span>
<span id="cb202-6"><a href="chap-utiliseR.html#cb202-6" aria-hidden="true" tabindex="-1"></a>      distance <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb202-7"><a href="chap-utiliseR.html#cb202-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>Y<span class="sc">$</span>n) {</span>
<span id="cb202-8"><a href="chap-utiliseR.html#cb202-8" aria-hidden="true" tabindex="-1"></a>        distance <span class="ot">&lt;-</span> distance <span class="sc">+</span> </span>
<span id="cb202-9"><a href="chap-utiliseR.html#cb202-9" aria-hidden="true" tabindex="-1"></a>          <span class="fu">sqrt</span>((Y<span class="sc">$</span>x[i]<span class="sc">-</span>Y<span class="sc">$</span>x[j])<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> (Y<span class="sc">$</span>y[i]<span class="sc">-</span>Y<span class="sc">$</span>y[j])<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb202-10"><a href="chap-utiliseR.html#cb202-10" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb202-11"><a href="chap-utiliseR.html#cb202-11" aria-hidden="true" tabindex="-1"></a>      distance</span>
<span id="cb202-12"><a href="chap-utiliseR.html#cb202-12" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb202-13"><a href="chap-utiliseR.html#cb202-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(distances<span class="sc">/</span>NbPointsReduit<span class="sc">/</span>(NbPointsReduit<span class="dv">-1</span>))</span>
<span id="cb202-14"><a href="chap-utiliseR.html#cb202-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb202-15"><a href="chap-utiliseR.html#cb202-15" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(d <span class="ot">&lt;-</span> <span class="fu">fforeach3</span>(Y))</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.126   0.058   0.111</code></pre>
<div class="sourceCode" id="cb204"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb204-1"><a href="chap-utiliseR.html#cb204-1" aria-hidden="true" tabindex="-1"></a>d</span></code></pre></div>
<pre><code>## [1] 0.5181951</code></pre>
<p></p>
<p><strong>foreach</strong> has optimized adapters allowing to use physical clusters for example.
Its interest is limited with the <strong>parallel</strong> package.</p>
</div>
<div id="rcpp" class="section level3 hasAnchor" number="2.7.6">
<h3><span class="header-section-number">2.7.6</span> RCpp<a href="chap-utiliseR.html#rcpp" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The C++ function to calculate distances is the following.</p>
<p></p>
<div class="sourceCode" id="cb206"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb206-1"><a href="chap-utiliseR.html#cb206-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb206-2"><a href="chap-utiliseR.html#cb206-2" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> Rcpp<span class="op">;</span></span>
<span id="cb206-3"><a href="chap-utiliseR.html#cb206-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-4"><a href="chap-utiliseR.html#cb206-4" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb206-5"><a href="chap-utiliseR.html#cb206-5" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> MeanDistance<span class="op">(</span>NumericVector x<span class="op">,</span> NumericVector y<span class="op">)</span> <span class="op">{</span></span>
<span id="cb206-6"><a href="chap-utiliseR.html#cb206-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> distance<span class="op">=</span><span class="dv">0</span><span class="op">;</span></span>
<span id="cb206-7"><a href="chap-utiliseR.html#cb206-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> dx<span class="op">,</span> dy<span class="op">;</span></span>
<span id="cb206-8"><a href="chap-utiliseR.html#cb206-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i<span class="op">=</span><span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="op">(</span>x<span class="op">.</span>length<span class="op">()-</span><span class="dv">1</span><span class="op">);</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb206-9"><a href="chap-utiliseR.html#cb206-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j<span class="op">=</span>i<span class="op">+</span><span class="dv">1</span><span class="op">;</span> j <span class="op">&lt;</span> x<span class="op">.</span>length<span class="op">();</span> j<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb206-10"><a href="chap-utiliseR.html#cb206-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Calculate distance</span></span>
<span id="cb206-11"><a href="chap-utiliseR.html#cb206-11" aria-hidden="true" tabindex="-1"></a>        dx <span class="op">=</span> x<span class="op">[</span>i<span class="op">]-</span>x<span class="op">[</span>j<span class="op">];</span></span>
<span id="cb206-12"><a href="chap-utiliseR.html#cb206-12" aria-hidden="true" tabindex="-1"></a>        dy <span class="op">=</span> y<span class="op">[</span>i<span class="op">]-</span>y<span class="op">[</span>j<span class="op">];</span></span>
<span id="cb206-13"><a href="chap-utiliseR.html#cb206-13" aria-hidden="true" tabindex="-1"></a>        distance <span class="op">+=</span> sqrt<span class="op">(</span>dx<span class="op">*</span>dx <span class="op">+</span> dy<span class="op">*</span>dy<span class="op">);</span></span>
<span id="cb206-14"><a href="chap-utiliseR.html#cb206-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb206-15"><a href="chap-utiliseR.html#cb206-15" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb206-16"><a href="chap-utiliseR.html#cb206-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> distance<span class="op">/(</span><span class="dt">double</span><span class="op">)(</span>x<span class="op">.</span>length<span class="op">()/</span><span class="dv">2</span><span class="op">*(</span>x<span class="op">.</span>length<span class="op">()-</span><span class="dv">1</span><span class="op">));</span></span>
<span id="cb206-17"><a href="chap-utiliseR.html#cb206-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p></p>
<p>It is called in R very simply.
The execution time is very short.</p>
<p></p>
<div class="sourceCode" id="cb207"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb207-1"><a href="chap-utiliseR.html#cb207-1" aria-hidden="true" tabindex="-1"></a>mb <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(d <span class="ot">&lt;-</span> <span class="fu">MeanDistance</span>(X<span class="sc">$</span>x, X<span class="sc">$</span>y))</span>
<span id="cb207-2"><a href="chap-utiliseR.html#cb207-2" aria-hidden="true" tabindex="-1"></a><span class="co"># suppressMessages to eliminate superfluous messages</span></span>
<span id="cb207-3"><a href="chap-utiliseR.html#cb207-3" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressMessages</span>(<span class="fu">autoplot</span>(mb))</span></code></pre></div>
<p><img src="WwR_files/figure-html/RCpp-1.png" width="80%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb208"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb208-1"><a href="chap-utiliseR.html#cb208-1" aria-hidden="true" tabindex="-1"></a>d</span></code></pre></div>
<pre><code>## [1] 0.5154062</code></pre>
<p></p>
</div>
<div id="rcppparallel" class="section level3 hasAnchor" number="2.7.7">
<h3><span class="header-section-number">2.7.7</span> RcppParallel<a href="chap-utiliseR.html#rcppparallel" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><strong>RcppParallel</strong> allows to interface parallelized C++ code, at the cost of a more complex syntax than <strong>RCpp</strong>.
Documentation is available<a href="#fn27" class="footnote-ref" id="fnref27"><sup>27</sup></a>.</p>
<p>The C++ function exported to R does not perform the computations but only organizes the parallel execution of another, non-exported, function of type <code>Worker</code>.</p>
<p>Two (C++) parallelization functions are available for two types of tasks:</p>
<ul>
<li><code>parallelReduce</code> for accumulating a value, used here to sum distances.</li>
<li><code>parallelFor</code> for filling a result matrix.</li>
</ul>
<p>The syntax of the <code>Worker</code> is a bit laborious but simple enough to adapt: the constructors initialize the C variables from the values passed by R and declare the parallelization.</p>
<p></p>
<div class="sourceCode" id="cb210"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb210-1"><a href="chap-utiliseR.html#cb210-1" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::depends(RcppParallel)]]</span></span>
<span id="cb210-2"><a href="chap-utiliseR.html#cb210-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb210-3"><a href="chap-utiliseR.html#cb210-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;RcppParallel.h&gt;</span></span>
<span id="cb210-4"><a href="chap-utiliseR.html#cb210-4" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> Rcpp<span class="op">;</span></span>
<span id="cb210-5"><a href="chap-utiliseR.html#cb210-5" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> RcppParallel<span class="op">;</span></span>
<span id="cb210-6"><a href="chap-utiliseR.html#cb210-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb210-7"><a href="chap-utiliseR.html#cb210-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Working function, not exported</span></span>
<span id="cb210-8"><a href="chap-utiliseR.html#cb210-8" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> TotalDistanceWrkr <span class="op">:</span> <span class="kw">public</span> Worker</span>
<span id="cb210-9"><a href="chap-utiliseR.html#cb210-9" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb210-10"><a href="chap-utiliseR.html#cb210-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">// source vectors</span></span>
<span id="cb210-11"><a href="chap-utiliseR.html#cb210-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> RVector<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Rx<span class="op">;</span></span>
<span id="cb210-12"><a href="chap-utiliseR.html#cb210-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> RVector<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Ry<span class="op">;</span></span>
<span id="cb210-13"><a href="chap-utiliseR.html#cb210-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb210-14"><a href="chap-utiliseR.html#cb210-14" aria-hidden="true" tabindex="-1"></a>  <span class="co">// accumulated value</span></span>
<span id="cb210-15"><a href="chap-utiliseR.html#cb210-15" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> distance<span class="op">;</span></span>
<span id="cb210-16"><a href="chap-utiliseR.html#cb210-16" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb210-17"><a href="chap-utiliseR.html#cb210-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">// constructors</span></span>
<span id="cb210-18"><a href="chap-utiliseR.html#cb210-18" aria-hidden="true" tabindex="-1"></a>  TotalDistanceWrkr<span class="op">(</span><span class="at">const</span> NumericVector x<span class="op">,</span> <span class="at">const</span> NumericVector y<span class="op">)</span> <span class="op">:</span></span>
<span id="cb210-19"><a href="chap-utiliseR.html#cb210-19" aria-hidden="true" tabindex="-1"></a>    Rx<span class="op">(</span>x<span class="op">),</span> Ry<span class="op">(</span>y<span class="op">),</span> distance<span class="op">(</span><span class="dv">0</span><span class="op">)</span> <span class="op">{}</span></span>
<span id="cb210-20"><a href="chap-utiliseR.html#cb210-20" aria-hidden="true" tabindex="-1"></a>  TotalDistanceWrkr<span class="op">(</span><span class="at">const</span> TotalDistanceWrkr<span class="op">&amp;</span> totalDistanceWrkr<span class="op">,</span> Split<span class="op">)</span> <span class="op">:</span></span>
<span id="cb210-21"><a href="chap-utiliseR.html#cb210-21" aria-hidden="true" tabindex="-1"></a>    Rx<span class="op">(</span>totalDistanceWrkr<span class="op">.</span>Rx<span class="op">),</span> Ry<span class="op">(</span>totalDistanceWrkr<span class="op">.</span>Ry<span class="op">),</span>  distance<span class="op">(</span><span class="dv">0</span><span class="op">)</span> <span class="op">{}</span></span>
<span id="cb210-22"><a href="chap-utiliseR.html#cb210-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb210-23"><a href="chap-utiliseR.html#cb210-23" aria-hidden="true" tabindex="-1"></a>  <span class="co">// count neighbors</span></span>
<span id="cb210-24"><a href="chap-utiliseR.html#cb210-24" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> <span class="kw">operator</span><span class="op">()(</span><span class="bu">std::</span>size_t<span class="op"> </span>begin<span class="op">,</span> <span class="bu">std::</span>size_t<span class="op"> </span>end<span class="op">)</span> <span class="op">{</span></span>
<span id="cb210-25"><a href="chap-utiliseR.html#cb210-25" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> dx<span class="op">,</span> dy<span class="op">;</span></span>
<span id="cb210-26"><a href="chap-utiliseR.html#cb210-26" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">int</span> Npoints <span class="op">=</span> Rx<span class="op">.</span>length<span class="op">();</span></span>
<span id="cb210-27"><a href="chap-utiliseR.html#cb210-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb210-28"><a href="chap-utiliseR.html#cb210-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">unsigned</span> <span class="dt">int</span> i <span class="op">=</span> begin<span class="op">;</span> i <span class="op">&lt;</span> end<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb210-29"><a href="chap-utiliseR.html#cb210-29" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> <span class="op">(</span><span class="dt">unsigned</span> <span class="dt">int</span> j<span class="op">=</span>i<span class="op">+</span><span class="dv">1</span><span class="op">;</span> j <span class="op">&lt;</span> Npoints<span class="op">;</span> j<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb210-30"><a href="chap-utiliseR.html#cb210-30" aria-hidden="true" tabindex="-1"></a>          <span class="co">// Calculate squared distance</span></span>
<span id="cb210-31"><a href="chap-utiliseR.html#cb210-31" aria-hidden="true" tabindex="-1"></a>          dx <span class="op">=</span> Rx<span class="op">[</span>i<span class="op">]-</span>Rx<span class="op">[</span>j<span class="op">];</span></span>
<span id="cb210-32"><a href="chap-utiliseR.html#cb210-32" aria-hidden="true" tabindex="-1"></a>          dy <span class="op">=</span> Ry<span class="op">[</span>i<span class="op">]-</span>Ry<span class="op">[</span>j<span class="op">];</span></span>
<span id="cb210-33"><a href="chap-utiliseR.html#cb210-33" aria-hidden="true" tabindex="-1"></a>          distance <span class="op">+=</span> sqrt<span class="op">(</span>dx<span class="op">*</span>dx <span class="op">+</span> dy<span class="op">*</span>dy<span class="op">);</span></span>
<span id="cb210-34"><a href="chap-utiliseR.html#cb210-34" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb210-35"><a href="chap-utiliseR.html#cb210-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb210-36"><a href="chap-utiliseR.html#cb210-36" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb210-37"><a href="chap-utiliseR.html#cb210-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb210-38"><a href="chap-utiliseR.html#cb210-38" aria-hidden="true" tabindex="-1"></a>  <span class="co">// join my value with that of another Sum</span></span>
<span id="cb210-39"><a href="chap-utiliseR.html#cb210-39" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> join<span class="op">(</span><span class="at">const</span> TotalDistanceWrkr<span class="op">&amp;</span> rhs<span class="op">)</span> <span class="op">{</span> </span>
<span id="cb210-40"><a href="chap-utiliseR.html#cb210-40" aria-hidden="true" tabindex="-1"></a>    distance <span class="op">+=</span> rhs<span class="op">.</span>distance<span class="op">;</span> </span>
<span id="cb210-41"><a href="chap-utiliseR.html#cb210-41" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb210-42"><a href="chap-utiliseR.html#cb210-42" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb210-43"><a href="chap-utiliseR.html#cb210-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb210-44"><a href="chap-utiliseR.html#cb210-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb210-45"><a href="chap-utiliseR.html#cb210-45" aria-hidden="true" tabindex="-1"></a><span class="co">// Exported function</span></span>
<span id="cb210-46"><a href="chap-utiliseR.html#cb210-46" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb210-47"><a href="chap-utiliseR.html#cb210-47" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> TotalDistance<span class="op">(</span>NumericVector x<span class="op">,</span> NumericVector y<span class="op">)</span> <span class="op">{</span></span>
<span id="cb210-48"><a href="chap-utiliseR.html#cb210-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb210-49"><a href="chap-utiliseR.html#cb210-49" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Declare TotalDistanceWrkr instance</span></span>
<span id="cb210-50"><a href="chap-utiliseR.html#cb210-50" aria-hidden="true" tabindex="-1"></a>  TotalDistanceWrkr totalDistanceWrkr<span class="op">(</span>x<span class="op">,</span> y<span class="op">);</span></span>
<span id="cb210-51"><a href="chap-utiliseR.html#cb210-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb210-52"><a href="chap-utiliseR.html#cb210-52" aria-hidden="true" tabindex="-1"></a>  <span class="co">// call parallel_reduce to start the work</span></span>
<span id="cb210-53"><a href="chap-utiliseR.html#cb210-53" aria-hidden="true" tabindex="-1"></a>  parallelReduce<span class="op">(</span><span class="dv">0</span><span class="op">,</span> x<span class="op">.</span>length<span class="op">(),</span> totalDistanceWrkr<span class="op">);</span></span>
<span id="cb210-54"><a href="chap-utiliseR.html#cb210-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb210-55"><a href="chap-utiliseR.html#cb210-55" aria-hidden="true" tabindex="-1"></a>  <span class="co">// return the result</span></span>
<span id="cb210-56"><a href="chap-utiliseR.html#cb210-56" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> totalDistanceWrkr<span class="op">.</span>distance<span class="op">;</span></span>
<span id="cb210-57"><a href="chap-utiliseR.html#cb210-57" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p></p>
<p>The usage in R is identical to the usage of C++ functions interfaced by <strong>RCpp</strong>.</p>
<p></p>
<div class="sourceCode" id="cb211"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb211-1"><a href="chap-utiliseR.html#cb211-1" aria-hidden="true" tabindex="-1"></a>(mb <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(d <span class="ot">&lt;-</span> <span class="fu">TotalDistance</span>(X<span class="sc">$</span>x, X<span class="sc">$</span>y)<span class="sc">/</span>NbPoints<span class="sc">/</span>(NbPoints <span class="sc">-</span></span>
<span id="cb211-2"><a href="chap-utiliseR.html#cb211-2" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>) <span class="sc">*</span> <span class="dv">2</span>))</span></code></pre></div>
<pre><code>## Unit: microseconds
##                                                      expr
##  d &lt;- TotalDistance(X$x, X$y)/NbPoints/(NbPoints - 1) * 2
##      min       lq     mean   median       uq     max neval
##  818.926 918.6365 1045.249 963.0465 1113.066 2704.94   100</code></pre>
<div class="sourceCode" id="cb213"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb213-1"><a href="chap-utiliseR.html#cb213-1" aria-hidden="true" tabindex="-1"></a><span class="co"># suppressMessages to eliminate superfluous messages</span></span>
<span id="cb213-2"><a href="chap-utiliseR.html#cb213-2" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressMessages</span>(<span class="fu">autoplot</span>(mb))</span></code></pre></div>
<p><img src="WwR_files/figure-html/RcppParallel-1.png" width="80%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb214"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb214-1"><a href="chap-utiliseR.html#cb214-1" aria-hidden="true" tabindex="-1"></a>d</span></code></pre></div>
<pre><code>## [1] 0.5154062</code></pre>
<p></p>
<p>The setup time for parallel tasks is much longer than the serial computation time.</p>
<p>Multiplying the number of points by 50, the serial computation time must be multiplied by about 2500.</p>
<p></p>
<div class="sourceCode" id="cb216"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb216-1"><a href="chap-utiliseR.html#cb216-1" aria-hidden="true" tabindex="-1"></a>NbPoints <span class="ot">&lt;-</span> <span class="dv">50000</span></span>
<span id="cb216-2"><a href="chap-utiliseR.html#cb216-2" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">runifpoint</span>(NbPoints)</span>
<span id="cb216-3"><a href="chap-utiliseR.html#cb216-3" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(d <span class="ot">&lt;-</span> <span class="fu">MeanDistance</span>(X<span class="sc">$</span>x, X<span class="sc">$</span>y))</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   7.057   0.020   7.095</code></pre>
<p></p>
<p>In parallel, the time increases little: parallelization becomes really efficient.
This time is to be compared to that of the reference for loop, multiplied by 2500, that is <code>4600</code> seconds.</p>
<p></p>
<div class="sourceCode" id="cb218"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb218-1"><a href="chap-utiliseR.html#cb218-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(d <span class="ot">&lt;-</span> <span class="fu">TotalDistance</span>(X<span class="sc">$</span>x, X<span class="sc">$</span>y)<span class="sc">/</span>NbPoints<span class="sc">/</span>(NbPoints <span class="sc">-</span></span>
<span id="cb218-2"><a href="chap-utiliseR.html#cb218-2" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>) <span class="sc">*</span> <span class="dv">2</span>)</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   5.054   0.033   2.081</code></pre>
<p></p>
</div>
<div id="conclusions-on-code-speed-optimization" class="section level3 hasAnchor" number="2.7.8">
<h3><span class="header-section-number">2.7.8</span> Conclusions on code speed optimization<a href="chap-utiliseR.html#conclusions-on-code-speed-optimization" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>From this case study, several lessons can be learned:</p>
<ul>
<li>a for loop is a good basis for repetitive calculations, faster than <code>vapply()</code>, simple to read and write;</li>
<li>optimized functions may exist in R packages for common tasks (here, the <code>pairdist()</code> function of <strong>spatstat</strong> is two orders of magnitude faster than the for loop);</li>
<li>the use of C++ code allows to speed up significantly the calculations, by three orders of magnitude here;</li>
<li>parallelization of the C++ code further divides the computation time by about half the number of cores for long computations.</li>
</ul>
<p>Beyond this example, optimizing computation time in R can be complicated if it involves parallelization and writing C++ code.
The effort must therefore be concentrated on the really long computations while the readability of the code must remain the priority for the current code.
C code is quite easy to integrate with <strong>RCpp</strong> and its parallelization is not very expensive with <strong>RCppParallel</strong>.</p>
<p>The use of for loops is no longer penalized since version 3.5 of R.
Writing vector code, using <code>sapply()</code> is still justified for its readability.</p>
<p>The choice of parallelizing the code must be evaluated according to the execution time of each parallelizable task.
If it exceeds a few seconds, parallelization is justified.
mclapply()<code>replaces</code>lapply()<code>without any effort, but requires a hack (provided here) under Windows.</code>foreach()<code>does not replace</code>for()` as easily and is only justified for very memory and computationally heavy tasks, especially on computing clusters.</p>
</div>
</div>
<div id="sec:targets" class="section level2 hasAnchor" number="2.8">
<h2><span class="header-section-number">2.8</span> Workflow<a href="chap-utiliseR.html#sec:targets" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The <strong>targets</strong> package allows you to manage a <em>workflow</em>, i.e. to break down the code into elementary tasks called <em>targets</em> that follow each other, the result of which is stored in a variable, itself saved on disk.
In case of a change in the code or in the data used, only the targets concerned are reevaluated.</p>
<p>The operation of the flow is similar to that of a cache, but does not depend on the computer on which it runs.
**It is also possible to integrate the flow into a document project (see section <a href="chap-rediger.html#sec:targetsmd">4.9</a>), and even to use a computing cluster to process the tasks in parallel.</p>
<div id="how-it-works-1" class="section level3 hasAnchor" number="2.8.1">
<h3><span class="header-section-number">2.8.1</span> How it works<a href="chap-utiliseR.html#how-it-works-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The documentation<a href="#fn28" class="footnote-ref" id="fnref28"><sup>28</sup></a> of <strong>targets</strong> is detailed and provides a worked example to learn how to use the package<a href="#fn29" class="footnote-ref" id="fnref29"><sup>29</sup></a>.
It is not repeated here, but the principles of how the flow works are explained..</p>
<p>The workflow is unique for a given project.
It is coded in the <code>_targets.R</code> file at the root of the project.
It contains:</p>
<ul>
<li>global commands, such as loading packages;</li>
<li>a list of targets, which describe the code to be executed and the variable that stores their result.</li>
</ul>
<p>The stream is executed by the <code>tar_make()</code> function, which updates the targets that need it.
Its content is placed in the <code>_targets</code> folder.
Stored variables are read by <code>tar_read()</code>.</p>
<p>If the project requires long computations, <strong>targets</strong> can be used to run only those that are necessary.
If the project is shared or placed under source control (chapter `<span class="citation">(<a href="#ref-ref" role="doc-biblioref"><strong>ref?</strong></a>)</span>(chap-git)), the result of the computations is also integrated.
Finally, if the project is a document (chapter <a href="chap-rediger.html#chap-rediger">4</a>), its formatting is completely independent of the calculation of its content, for a saving of time which can be considerable.</p>
</div>
<div id="minimal-example" class="section level3 hasAnchor" number="2.8.2">
<h3><span class="header-section-number">2.8.2</span> Minimal example<a href="chap-utiliseR.html#minimal-example" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The following example is even simpler than the one in the <strong>targets</strong> manual, which will allow you to go further.
It takes up the previous case study: a set of points is generated and the average distance between the points is calculated.
A map of the points is also drawn.
Each of these three operations is a target in the vocabulary of <strong>targets</strong>.</p>
<p>The workflow file is therefore the following:</p>
<p></p>
<div class="sourceCode" id="cb220"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb220-1"><a href="chap-utiliseR.html#cb220-1" aria-hidden="true" tabindex="-1"></a><span class="co"># File _targets.R </span></span>
<span id="cb220-2"><a href="chap-utiliseR.html#cb220-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;targets&quot;</span>)</span>
<span id="cb220-3"><a href="chap-utiliseR.html#cb220-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_option_set</span>(<span class="at">packages =</span> <span class="fu">c</span>(<span class="st">&quot;spatstat&quot;</span>, <span class="st">&quot;dbmss&quot;</span>))</span>
<span id="cb220-4"><a href="chap-utiliseR.html#cb220-4" aria-hidden="true" tabindex="-1"></a><span class="fu">list</span>(</span>
<span id="cb220-5"><a href="chap-utiliseR.html#cb220-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Draw points</span></span>
<span id="cb220-6"><a href="chap-utiliseR.html#cb220-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tar_target</span>(X,</span>
<span id="cb220-7"><a href="chap-utiliseR.html#cb220-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">runifpoint</span>(NbPoints)</span>
<span id="cb220-8"><a href="chap-utiliseR.html#cb220-8" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb220-9"><a href="chap-utiliseR.html#cb220-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Choose Parameters</span></span>
<span id="cb220-10"><a href="chap-utiliseR.html#cb220-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tar_target</span>(NbPoints,</span>
<span id="cb220-11"><a href="chap-utiliseR.html#cb220-11" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1000</span></span>
<span id="cb220-12"><a href="chap-utiliseR.html#cb220-12" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb220-13"><a href="chap-utiliseR.html#cb220-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Average Distance</span></span>
<span id="cb220-14"><a href="chap-utiliseR.html#cb220-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tar_target</span>(d,</span>
<span id="cb220-15"><a href="chap-utiliseR.html#cb220-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(<span class="fu">pairdist</span>(X)) <span class="sc">/</span> NbPoints <span class="sc">/</span> (NbPoints <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb220-16"><a href="chap-utiliseR.html#cb220-16" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb220-17"><a href="chap-utiliseR.html#cb220-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Map</span></span>
<span id="cb220-18"><a href="chap-utiliseR.html#cb220-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tar_target</span>(map, </span>
<span id="cb220-19"><a href="chap-utiliseR.html#cb220-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">autoplot</span>(<span class="fu">as.wmppp</span>(X))</span>
<span id="cb220-20"><a href="chap-utiliseR.html#cb220-20" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb220-21"><a href="chap-utiliseR.html#cb220-21" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p></p>
<p>The global commands consist in loading the <strong>targets</strong> package itself and then listing the packages needed for the code.
The execution of the stream takes place in a new instance of R.</p>
<p>The targets are then listed.
Each one is declared by the <code>tar_target()</code> function whose first argument is the name of the target, which will be the name of the variable that will receive the result.
The second argument is the code that produces the result.
Targets are very simple here and can be written in a single command.
When this is not the case, each target can be written as a function, stored in a separate code file loaded by the <code>source()</code> function at the beginning of the stream file.</p>
<p>The <code>tar_visnetwork</code> command displays the sequence of targets and their possibly obsolete status.</p>
<p></p>
<div class="sourceCode" id="cb221"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb221-1"><a href="chap-utiliseR.html#cb221-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;targets&quot;</span>)</span>
<span id="cb221-2"><a href="chap-utiliseR.html#cb221-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_visnetwork</span>()</span></code></pre></div>
<div id="htmlwidget-4c2873e5859f69562509" style="width:80%;height:504px;" class="visNetwork html-widget"></div>
<script type="application/json" data-for="htmlwidget-4c2873e5859f69562509">{"x":{"nodes":{"name":["d","map","NbPoints","X"],"type":["stem","stem","stem","stem"],"status":["outdated","outdated","outdated","outdated"],"seconds":[null,null,null,null],"bytes":[null,null,null,null],"branches":[null,null,null,null],"label":["d","map","NbPoints","X"],"color":["#78B7C5","#78B7C5","#78B7C5","#78B7C5"],"id":["d","map","NbPoints","X"],"level":[3,3,1,2],"shape":["dot","dot","dot","dot"]},"edges":{"from":["NbPoints","NbPoints","X","X"],"to":["X","d","d","map"],"arrows":["to","to","to","to"]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"edges":{"smooth":{"type":"cubicBezier","forceDirection":"horizontal"}},"physics":{"stabilization":false},"interaction":{"zoomSpeed":1},"layout":{"hierarchical":{"enabled":true,"direction":"LR"}}},"groups":null,"width":null,"height":null,"idselection":{"enabled":false,"style":"width: 150px; height: 26px","useLabels":true,"main":"Select by id"},"byselection":{"enabled":false,"style":"width: 150px; height: 26px","multiple":false,"hideColor":"rgba(200,200,200,0.5)","highlight":false},"main":{"text":"","style":"font-family:Georgia, Times New Roman, Times, serif;font-weight:bold;font-size:20px;text-align:center;"},"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","highlight":{"enabled":true,"hoverNearest":false,"degree":{"from":1,"to":1},"algorithm":"hierarchical","hideColor":"rgba(200,200,200,0.5)","labelOnly":true},"collapse":{"enabled":true,"fit":false,"resetHighlight":true,"clusterOptions":null,"keepCoord":true,"labelSuffix":"(cluster)"},"legend":{"width":0.2,"useGroups":false,"position":"right","ncol":1,"stepX":100,"stepY":100,"zoom":true,"nodes":{"label":["Outdated","Stem"],"color":["#78B7C5","#899DA4"],"shape":["dot","dot"]},"nodesToDataframe":true},"tooltipStay":300,"tooltipStyle":"position: fixed;visibility:hidden;padding: 5px;white-space: nowrap;font-family: verdana;font-size:14px;font-color:#000000;background-color: #f5f4ed;-moz-border-radius: 3px;-webkit-border-radius: 3px;border-radius: 3px;border: 1px solid #808074;box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);"},"evals":[],"jsHooks":[]}</script>
<p></p>
<p>The order of declaration of the targets in the list is not important: they are ordered automatically.</p>
<p>The workflow is run by <code>tar_make()</code>.</p>
<p></p>
<div class="sourceCode" id="cb222"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb222-1"><a href="chap-utiliseR.html#cb222-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_make</span>()</span></code></pre></div>
<pre><code>## • start target NbPoints
## • built target NbPoints
## • start target X
## • built target X
## • start target d
## • built target d
## • start target map
## • built target map
## • end pipeline: 2.159 seconds</code></pre>
<p></p>
<p>The workflow is now up to date and <code>tar_make()</code> does not recompute anything.</p>
<p></p>
<div class="sourceCode" id="cb224"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb224-1"><a href="chap-utiliseR.html#cb224-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_visnetwork</span>()</span></code></pre></div>
<div id="htmlwidget-c5409db81165a82e2db3" style="width:80%;height:504px;" class="visNetwork html-widget"></div>
<script type="application/json" data-for="htmlwidget-c5409db81165a82e2db3">{"x":{"nodes":{"name":["d","map","NbPoints","X"],"type":["stem","stem","stem","stem"],"status":["uptodate","uptodate","uptodate","uptodate"],"seconds":[0.021,0.018,1.987,0.003],"bytes":[55,99942,53,11044],"branches":[null,null,null,null],"label":["d","map","NbPoints","X"],"color":["#354823","#354823","#354823","#354823"],"id":["d","map","NbPoints","X"],"level":[3,3,1,2],"shape":["dot","dot","dot","dot"]},"edges":{"from":["NbPoints","NbPoints","X","X"],"to":["X","d","d","map"],"arrows":["to","to","to","to"]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"edges":{"smooth":{"type":"cubicBezier","forceDirection":"horizontal"}},"physics":{"stabilization":false},"interaction":{"zoomSpeed":1},"layout":{"hierarchical":{"enabled":true,"direction":"LR"}}},"groups":null,"width":null,"height":null,"idselection":{"enabled":false,"style":"width: 150px; height: 26px","useLabels":true,"main":"Select by id"},"byselection":{"enabled":false,"style":"width: 150px; height: 26px","multiple":false,"hideColor":"rgba(200,200,200,0.5)","highlight":false},"main":{"text":"","style":"font-family:Georgia, Times New Roman, Times, serif;font-weight:bold;font-size:20px;text-align:center;"},"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","highlight":{"enabled":true,"hoverNearest":false,"degree":{"from":1,"to":1},"algorithm":"hierarchical","hideColor":"rgba(200,200,200,0.5)","labelOnly":true},"collapse":{"enabled":true,"fit":false,"resetHighlight":true,"clusterOptions":null,"keepCoord":true,"labelSuffix":"(cluster)"},"legend":{"width":0.2,"useGroups":false,"position":"right","ncol":1,"stepX":100,"stepY":100,"zoom":true,"nodes":{"label":["Up to date","Stem"],"color":["#354823","#899DA4"],"shape":["dot","dot"]},"nodesToDataframe":true},"tooltipStay":300,"tooltipStyle":"position: fixed;visibility:hidden;padding: 5px;white-space: nowrap;font-family: verdana;font-size:14px;font-color:#000000;background-color: #f5f4ed;-moz-border-radius: 3px;-webkit-border-radius: 3px;border-radius: 3px;border: 1px solid #808074;box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);"},"evals":[],"jsHooks":[]}</script>
<div class="sourceCode" id="cb225"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb225-1"><a href="chap-utiliseR.html#cb225-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_make</span>()</span></code></pre></div>
<pre><code>## ✔ skip target NbPoints
## ✔ skip target X
## ✔ skip target d
## ✔ skip target map
## ✔ skip pipeline: 0.067 seconds</code></pre>
<p></p>
<p>The results are read by <code>tar_read()</code>.</p>
<p></p>
<div class="sourceCode" id="cb227"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb227-1"><a href="chap-utiliseR.html#cb227-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_read</span>(d)</span></code></pre></div>
<pre><code>## [1] 0.5189867</code></pre>
<div class="sourceCode" id="cb229"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb229-1"><a href="chap-utiliseR.html#cb229-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_read</span>(map)</span></code></pre></div>
<p><img src="WwR_files/figure-html/tar_read-1.png" width="80%" style="display: block; margin: auto;" /></p>
<p></p>
</div>
<div id="practical-interest" class="section level3 hasAnchor" number="2.8.3">
<h3><span class="header-section-number">2.8.3</span> Practical interest<a href="chap-utiliseR.html#practical-interest" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In this example, <strong>targets</strong> complicates writing the code and <code>tar_make()</code> is much slower than simply executing the code it processes because it has to check if the targets are up to date.
In a real project that requires long computations, processing the status of the targets is negligible and the time saved by just evaluating the necessary targets is considerable.
The definition of targets remains a constraint, but forces the user to structure their project well.</p>

</div>
</div>
</div>
<h3>References<a href="references.html#references" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Gillespie2016" class="csl-entry">
Gillespie, Colin, and Robin Lovelace. 2016. <em>Efficient <span>R</span> Programming</em>. <span>O’Reilly Media</span>. <a href="https://csgillespie.github.io/efficientR/">https://csgillespie.github.io/efficientR/</a>.
</div>
<div id="ref-Wickham2010" class="csl-entry">
Wickham, Hadley. 2010. <span>“A Layered Grammar of Graphics.”</span> <em>Journal of Computational and Graphical Statistics</em> 19 (1): 3–28. <a href="http://vita.had.co.nz/papers/layered-grammar.pdf">http://vita.had.co.nz/papers/layered-grammar.pdf</a>.
</div>
<div id="ref-Wickham2014" class="csl-entry">
———. 2014. <em>Advanced <span>R</span></em>. <span>Chapman and Hall/CRC</span>. <a href="http://adv-r.had.co.nz/">http://adv-r.had.co.nz/</a>.
</div>
<div id="ref-Wickham2017" class="csl-entry">
———. 2017. <em>Ggplot2: <span>Elegant</span> Graphics for Data Analysis</em>. 2nd ed. <span>Springer</span>. <a href="https://doi.org/10.1007/978-3-319-24277-4">https://doi.org/10.1007/978-3-319-24277-4</a>.
</div>
<div id="ref-Wickham2016" class="csl-entry">
Wickham, Hadley, and Garrett Grolemund. 2016. <em>R for Data Science</em>. <span>O’Reilly Media</span>. <a href="http://r4ds.had.co.nz/">http://r4ds.had.co.nz/</a>.
</div>
</div>
<div class="footnotes">
<hr />
<ol start="17">
<li id="fn17"><p><a href="https://adv-r.had.co.nz/OO-essentials.html" class="uri">https://adv-r.had.co.nz/OO-essentials.html</a><a href="chap-utiliseR.html#fnref17" class="footnote-back">↩︎</a></p></li>
<li id="fn18"><p><a href="https://www.troispointzero.fr/le-blog/introduction-a-la-programmation-orientee-objet-poo/" class="uri">https://www.troispointzero.fr/le-blog/introduction-a-la-programmation-orientee-objet-poo/</a><a href="chap-utiliseR.html#fnref18" class="footnote-back">↩︎</a></p></li>
<li id="fn19"><p><a href="https://r6.r-lib.org/" class="uri">https://r6.r-lib.org/</a><a href="chap-utiliseR.html#fnref19" class="footnote-back">↩︎</a></p></li>
<li id="fn20"><p><a href="https://r6.r-lib.org/articles/Performance.html" class="uri">https://r6.r-lib.org/articles/Performance.html</a><a href="chap-utiliseR.html#fnref20" class="footnote-back">↩︎</a></p></li>
<li id="fn21"><p><a href="https://dplyr.tidyverse.org/articles/programming.html" class="uri">https://dplyr.tidyverse.org/articles/programming.html</a><a href="chap-utiliseR.html#fnref21" class="footnote-back">↩︎</a></p></li>
<li id="fn22"><p><a href="https://cran.r-project.org/web/packages/tidyverse/vignettes/manifesto.html" class="uri">https://cran.r-project.org/web/packages/tidyverse/vignettes/manifesto.html</a><a href="chap-utiliseR.html#fnref22" class="footnote-back">↩︎</a></p></li>
<li id="fn23"><p><a href="https://EricMarcon.github.io/WorkingWithR/profile.html" class="uri">https://EricMarcon.github.io/WorkingWithR/profile.html</a><a href="chap-utiliseR.html#fnref23" class="footnote-back">↩︎</a></p></li>
<li id="fn24"><p><a href="https://rstudio.github.io/profvis/" class="uri">https://rstudio.github.io/profvis/</a><a href="chap-utiliseR.html#fnref24" class="footnote-back">↩︎</a></p></li>
<li id="fn25"><p><a href="http://dept.stat.lsa.umich.edu/~jerrick/courses/stat701/notes/parallel.html" class="uri">http://dept.stat.lsa.umich.edu/~jerrick/courses/stat701/notes/parallel.html</a><a href="chap-utiliseR.html#fnref25" class="footnote-back">↩︎</a></p></li>
<li id="fn26"><p><a href="https://mindyourdecisions.com/blog/2016/07/03/distance-between-two-random-points-in-a-square-sunday-puzzle/" class="uri">https://mindyourdecisions.com/blog/2016/07/03/distance-between-two-random-points-in-a-square-sunday-puzzle/</a><a href="chap-utiliseR.html#fnref26" class="footnote-back">↩︎</a></p></li>
<li id="fn27"><p><a href="http://rcppcore.github.io/RcppParallel/" class="uri">http://rcppcore.github.io/RcppParallel/</a><a href="chap-utiliseR.html#fnref27" class="footnote-back">↩︎</a></p></li>
<li id="fn28"><p><a href="https://books.ropensci.org/targets/" class="uri">https://books.ropensci.org/targets/</a><a href="chap-utiliseR.html#fnref28" class="footnote-back">↩︎</a></p></li>
<li id="fn29"><p><a href="https://books.ropensci.org/targets/walkthrough.html" class="uri">https://books.ropensci.org/targets/walkthrough.html</a><a href="chap-utiliseR.html#fnref29" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="chap-logiciels.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="chap-git.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["WwR.pdf"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
